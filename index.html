<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />  
  <title>ZA í•œê¸€ ê³µëµ ë§µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height:100%; margin:0; }
    #map { position: relative; z-index: 0; background:#e9eaec; }
    .bar{
      position:fixed; left:10px; top:10px; z-index:1400;
      background:#111a; color:#fff; padding:8px 10px; border-radius:10px; font-size:14px;
      display:flex; gap:8px; align-items:center;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    }
    .bar button{margin:0}
    #adminBadge{display:none;background:#ffd54f;color:#111;padding:2px 6px;border-radius:8px}
    .tbtn{background:#2a2f3a;color:#ddd;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
    .tbtn.on{background:#3d6cff;color:#fff}

    /* ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ê±´ì˜/ê³µì§€/ë©”ì‹ ì €) */
    .top-right {
      position: fixed; right:10px; top:10px; z-index: 1400;
      display:flex; gap:8px; align-items:center;
    }
    .pill-btn { position:relative; background:#2a2f3a; color:#ddd; border:0; border-radius:999px; padding:6px 12px; cursor:pointer }
    .pill-btn.on { background:#3d6cff; color:#fff }
    .pill-btn .bang { position:absolute; left:-6px; top:-6px; width:16px; height:16px; border-radius:50%; background:#ff5252; color:#fff; font-size:11px; display:none; align-items:center; justify-content:center }
    .pill-btn .bang.show { display:flex }

    /* ì¢Œì¸¡ ê²€ìƒ‰ ì‚¬ì´ë“œ */
    #side{
      position:fixed; z-index:1300; left:10px; top:60px; bottom:10px;
      width:20vw; min-width:240px; max-width:420px;
      display:none; background:#1c1f27; color:#d6d9e0; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.25);
      padding:12px; overflow:auto;
    }
    #side h3{margin:6px 0 10px 4px; font-size:16px; color:#fff}
    .flt-wrap{display:flex; flex-wrap:wrap; gap:8px}
    .flt{
      border:1px solid #303645; background:#202532; color:#c9cfdd; padding:6px 10px;
      border-radius:999px; cursor:pointer; font-size:13px; position:relative;
    }
    .flt.on{background:#3d6cff; border-color:#3d6cff; color:#fff}
    /* ì§„í–‰ë„: ë” ì‘ê²Œ, ê¸°ë³¸ì€ ìˆ¨ê¹€ */
    .flt .progress{
      position:absolute;
      bottom:2px; left:50%; transform:translateX(-50%);
      font-size:9px; opacity:.75; display:none;
    }
    /* í•´ë‹¹ ì¹´í…Œê³ ë¦¬ê°€ ONì¼ ë•Œë§Œ í‘œì‹œ */
    .flt.on .progress{ display:block }

    .hr{height:1px; background:#2a3040; margin:12px 0}
    .inp{width:100%; box-sizing:border-box; background:#1117; color:#eef; border:1px solid #303645; border-radius:10px; padding:8px}
    .row{display:flex; gap:8px; align-items:center}

    /* ì‹ ê³  ê´€ë¦¬ ëª¨ë“œ ì „ìš© ë¦¬ìŠ¤íŠ¸ */
    .rlist{display:grid; gap:8px}
    .ritem{background:#1f2430;border:1px solid #2f3647;border-radius:10px;padding:10px}
    .ritem .meta{font-size:12px;color:#9fb0c0;margin-top:4px}
    .ritem .act{display:flex;gap:8px;margin-top:8px}
    .rbtn{background:#2a2f3a;color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
    .rbtn.warn{background:#ff5252}
    .rep-sort{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 8px}
    .rep-sort .flt{padding:4px 10px}
    .rep-filt{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 8px}
    .rep-filt .flt{padding:3px 10px}

    /* ìš°í•˜ë‹¨ ìƒì„¸ íŒ¨ë„ */
    #info{position:fixed; right:10px; bottom:10px; width:420px; max-height:75%;
      overflow:auto; z-index:1500; display:none; background:#1e1e1e; color:#ddd;
      border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.35);}
    #info header{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #333; flex-wrap:wrap}
    #info .thumb{width:100%; max-height:260px; object-fit:cover; background:#000}
    #info .pad{padding:12px}
    #info .meta{font-size:12px; color:#aaa; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    #info .badge{background:#ff9800;color:#111;padding:2px 6px;border-radius:6px;font-size:11px}
    #info .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    #info button{background:#2a2a2a; color:#fff; border:0; padding:6px 10px; border-radius:8px; cursor:pointer}
    #info button.primary{background:#3d6cff}
    #info button.warn{background:#ff5252}
    #info .media video{width:100%; max-height:260px}
    #info .media img{width:100%; max-height:260px; object-fit:cover}
    #info .idtag{background:#263238; color:#cfd8dc; padding:2px 6px; border-radius:6px; font-size:11px}
    #info .view-count{font-size:11px; color:#888; margin-left:auto}
    .pk-tags{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
    .pk-tags .tag{background:#223; border:1px solid #345; color:#cfe; padding:2px 8px; border-radius:999px; font-size:12px; cursor:pointer}
    
    /* ìºëŸ¬ì…€ */
    .carousel{ position:relative; width:100%; margin-top:12px; background:#141414; border-radius:10px; overflow:hidden }
    .carousel .inner{ display:flex; transition: transform .3s ease }
    .carousel .item{ min-width:100%; display:flex; align-items:center; justify-content:center; background:#000 }
    .carousel .item img, .carousel .item video{ width:100%; max-height:420px; object-fit:contain; background:#000 }
    .carousel .nav{
      position:absolute; top:50%; transform:translateY(-50%);
      background:#000a; color:#fff; border:0; width:38px; height:38px; border-radius:50%; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:18px;
    }
    .carousel .prev{ left:8px } .carousel .next{ right:8px }
    .carousel .dots{ position:absolute; left:0; right:0; bottom:6px; display:flex; justify-content:center; gap:6px }
    .carousel .dot{ width:8px; height:8px; border-radius:50%; background:#6a6a6a; }
    .carousel .dot.on{ background:#fff }
    
    /* ëŒ“ê¸€ */
    #comments{ margin-top:12px; }
    #comments .cform textarea{ width:100%; box-sizing:border-box; background:#111; color:#eee; border:1px solid #333; border-radius:8px; padding:8px }
    #comments .cform .row{ display:flex; gap:8px; margin-top:8px }
    #comments .cform button{ background:#3d6cff; border:0; color:#fff; padding:6px 10px; border-radius:8px }
    #comments .clist{ margin-top:10px; display:grid; gap:10px }
    .citem{ background:#151515; border:1px solid #2a2a2a; border-radius:10px; padding:10px; opacity:1; transition:opacity .2s }
    .citem.inactive{ opacity:0.4 }
    .citem .meta{ font-size:12px; color:#aaa; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .citem .meta .clickable{ cursor:pointer; text-decoration:underline }
    .citem .act{ display:flex; gap:8px; margin-top:6px }
    .citem .btn{ background:#2a2a2a; color:#fff; border:0; padding:4px 8px; border-radius:8px; cursor:pointer }
    .citem .btn.warn{ background:#ff5252 }
    .citem .reactions{display:flex; gap:4px; margin-top:6px; font-size:11px}
    .citem .reactions span{background:#2a2a2a; padding:2px 6px; border-radius:4px}
    .badge-report{background:#ff9800;color:#111;padding:2px 6px;border-radius:6px;font-size:11px}
    .badge-hidden{background:#90caf9;color:#111;padding:2px 6px;border-radius:6px;font-size:11px}

    /* ë°˜ì‘ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
    .reaction-menu{
      position:fixed; background:#1e1e1e; border:1px solid #333; border-radius:8px; padding:8px;
      display:none; z-index:2000; box-shadow:0 4px 12px rgba(0,0,0,.5)
    }
    .reaction-menu button{
      background:transparent; border:0; color:#fff; padding:4px 8px; cursor:pointer;
      font-size:16px; border-radius:4px
    }
    .reaction-menu button:hover{background:#2a2a2a}

    /* ì…ë ¥/ì„¤ì • ëª¨ë‹¬ (ê¸°ë³¸ ìˆ¨ê¹€ ëŒ€ìƒ ì „ì²´ ëª…ì‹œ) */
    #modal,#profileModal,#messengerModal,#noticeModal,#noticeListModal,#suggestModal,#suggestListModal,#achievementModal,#missionsModal,#otherProfileModal,#trustHistoryModal,#achievementListModal{
      display:none; position:fixed; inset:0; background:#0008; align-items:center; justify-content:center; z-index:1500;
    }
    .panel{background:#1e1e1e;color:#fff;padding:16px;border-radius:12px;width:380px; max-height:85vh; overflow:auto}
    .panel.wide{width:min(720px, 96vw)}
    .panel input,.panel textarea,.panel select{width:100%; box-sizing:border-box}
    small.muted{color:#a0a7b4}

    /* XP ë°” */
    .xp-bar{
      background:#2a2a2a; border-radius:8px; height:20px; position:relative; overflow:hidden; margin:8px 0
    }
    .xp-bar-fill{
      background:linear-gradient(90deg, #3d6cff, #5d8cff); height:100%; transition:width .3s ease
    }
    .xp-bar-text{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:600; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.5)
    }

    /* ì—…ì  ë°°ì§€ */
    .achievement-badge{
      display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; margin:2px;
      background:#2a2a2a; border:1px solid #444
    }
    .achievement-badge.normal{border-color:#888; background:#333}
    .achievement-badge.rare{border-color:#4a9eff; background:#1a3a5f}
    .achievement-badge.epic{border-color:#a335ee; background:#3a1a5f}
    .achievement-badge.legend{border-color:#ff8000; background:#5f3a1a}

    /* ë¯¸ì…˜ */
    .mission-item{
      background:#2a2a2a; border:1px solid #444; border-radius:8px; padding:10px; margin:8px 0;
      display:flex; justify-content:space-between; align-items:center
    }
    .mission-item.completed{opacity:.5}
    .mission-item .mission-reward{color:#4a9eff; font-size:11px}

    /* ì‹ ë¢°ë„ ìƒ‰ìƒ */
    .trust-negative{color:#ff5252}
    .trust-positive{color:#4caf50}

    /* ì–Œì „í•œ ì¸ì•± ì•ˆë‚´ ë°°ë„ˆ */
    #inapp-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 2999;
      background: linear-gradient(90deg,#0f172aee,#111827ee);
      color: #e5e7eb; font-size: 13px; line-height: 1.4;
      padding: 10px 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,.35);
    }
    #inapp-banner strong{ color:#fff; font-weight:600 }

    /* ê³µì§€ íŠ¹ìˆ˜ ë©”ì‹œì§€ */
    .sys-notice {
      background:#0b3a70; color:#e6f1ff; border-radius:12px; padding:16px; margin:8px 0;
    }
    .sys-notice h4{ margin:0 0 6px 0; font-size:16px }
    .sys-notice p{ margin:0; opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .sys-notice .view-count{font-size:11px; opacity:.8; margin-top:4px}

    /* ë©”ì‹ ì € ì±„íŒ… ë²„ë¸” */
    .chat-wrap { max-height:60vh; overflow:auto; background:#0f1116; border:1px solid #2b3143; border-radius:12px; padding:12px }
    .chat-row { display:flex; margin:6px 0 }
    .chat-row.me { justify-content:flex-start }
    .chat-row.other { justify-content:flex-end }
    .bubble { max-width:70%; background:#1f2430; color:#e5e7eb; padding:8px 10px; border-radius:12px }
    .chat-row.other .bubble { background:#293146 }
    .chat-meta { font-size:11px; color:#aab; margin-top:4px }

    /* ìš”ì£¼ì˜ ìœ ì € ì„¹ì…˜ */
    .warning-users{background:#3a1f1f; border:1px solid #5f2f2f; border-radius:8px; padding:10px; margin:10px 0}
    .warning-users h4{margin:0 0 8px 0; color:#ff8a80}
    
    /* ì—…ì  íŒì—… */
    .achievement-popup{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#1e1e1e; border:2px solid #ffd700; border-radius:12px; padding:20px;
      z-index:3000; min-width:300px; text-align:center; animation:popIn .3s ease
    }
    @keyframes popIn{
      from{transform:translate(-50%,-50%) scale(.8); opacity:0}
      to{transform:translate(-50%,-50%) scale(1); opacity:1}
    }
  </style>
</head>
<body>
  <!-- ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ì°¨ë‹¨ ê²½ê³  -->
  <div id="blockWarn" style="display:none;position:fixed;inset:0;background:#000a;z-index:3000;
  align-items:center;justify-content:center;color:#fff;padding:20px;text-align:center">
    ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì°¨ë‹¨ë˜ì–´ í˜ì´ì§€ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
    ê´‘ê³ ì°¨ë‹¨/ë³´ì•ˆDNS/ë¸Œë¼ìš°ì € ë³´í˜¸ê¸°ëŠ¥ì„ ë„ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.
  </div>
  <script> setTimeout(()=>{ if(!window.L){ document.getElementById('blockWarn').style.display='flex'; } }, 1500); </script>

  <!-- ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ -->
  <script>
  (function(){
    const PATTERNS = [/KAKAOTALK/i, /Line\//i, /Instagram/i, /FBAN|FBAV/i, /Twitter/i, /Snapchat/i, /MicroMessenger/i];
    const isInApp = PATTERNS.some(r => r.test(navigator.userAgent||''));
    if (!isInApp) return;
    const banner = document.createElement('div');
    banner.id = 'inapp-banner';
    banner.innerHTML = '<strong>ì•ˆë‚´</strong> Â· ì•± ë‚´ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤. ' +
      'ì¼ë¶€ ê¸°ëŠ¥(íŠ¹íˆ <strong>Google ë¡œê·¸ì¸/ì—…ë¡œë“œ/íŒì—…</strong>)ì´ ì œí•œë˜ê±°ë‚˜ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. ' +
      'Chrome/Safari ë“± <strong>ì™¸ë¶€ ë¸Œë¼ìš°ì € ì´ìš©</strong>ì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
    document.body.appendChild(banner);
  })();
  </script>

  <div class="bar" role="toolbar" aria-label="ìƒë‹¨ ë„êµ¬ë§‰ëŒ€">
    <span id="who">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
    <button id="login" title="Google ë¡œê·¸ì¸">Google ë¡œê·¸ì¸</button>
    <button id="logout" style="display:none" title="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
    <button id="btnProfile" class="tbtn" style="display:none" title="í”„ë¡œí•„ ì„¤ì •">í”„ë¡œí•„</button>
    <span id="adminBadge" aria-label="ê´€ë¦¬ì">ê´€ë¦¬ì</span>
    <span style="width:1px;height:20px;background:#2f3545;margin:0 6px"></span>
    <button id="btnSearch" class="tbtn on" title="ê²€ìƒ‰ ëª¨ë“œ(S)">ê²€ìƒ‰ ëª¨ë“œ</button>
    <button id="btnPlace"  class="tbtn" title="í•€ ë°°ì¹˜ ëª¨ë“œ(M)">í•€ ë°°ì¹˜ ëª¨ë“œ</button>
    <button id="btnAdminReport" class="tbtn" style="display:none" title="ì‹ ê³  ê´€ë¦¬ ëª¨ë“œ">ì‹ ê³  ê´€ë¦¬ ëª¨ë“œ</button>
    <button id="btnPendingOnly" class="tbtn" style="display:none" title="ìŠ¹ì¸ ëŒ€ê¸° í•€">ìŠ¹ì¸ ëŒ€ê¸° í•€</button>
  </div>

  <!-- ìš°ì¸¡ ìƒë‹¨: ê±´ì˜ / ê³µì§€ / ë©”ì‹ ì € -->
  <div class="top-right">
    <button id="btnSuggestList" class="pill-btn" title="ê±´ì˜ ë° ë¬¸ì˜">ê±´ì˜ ë° ë¬¸ì˜</button>
    <button id="btnNoticeList" class="pill-btn" title="ê³µì§€ ëª©ë¡">ê³µì§€</button>
    <button id="btnMsg" class="pill-btn" style="display:none" title="ê´€ë¦¬ì§„ ë©”ì‹ ì €">ë©”ì„¸ì§€ <span class="bang" id="msgBang">!</span></button>
  </div>

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œ -->
  <aside id="side" aria-label="ê²€ìƒ‰ ì‚¬ì´ë“œë°”">
    <div id="sideCats">
      <h3>ì¹´í…Œê³ ë¦¬ í•„í„°</h3>
      <div class="flt-wrap" id="fltList"></div>

      <h3>íŠ¹ìˆ˜ ë ˆì´ì–´</h3>
      <div class="flt-wrap">
        <button id="fltWild" class="flt on" title="ì™€ì¼ë“œ ì¡´ ë ˆì´ì–´ í† ê¸€">ì™€ì¼ë“œ ì¡´</button>
        <button id="fltAll" class="flt" title="ì „ì²´ ì„ íƒ">ì „ì²´ ì„ íƒ</button>
        <button id="fltNone" class="flt" title="ì „ì²´ í•´ì œ">ì „ì²´ í•´ì œ</button>
      </div>
    </div>

    <!-- ì‹ ê³  ê´€ë¦¬ ëª¨ë“œ -->
    <div id="sideReports" style="display:none">
      <h3>ì‹ ê³ ëœ ëŒ“ê¸€</h3>
      <div class="rep-sort" id="repSortBar">
        <button class="flt on" data-sort="mix">ì¢…í•©</button>
        <button class="flt" data-sort="count">ëˆ„ì íšŸìˆ˜</button>
        <button class="flt" data-sort="remain">ë‚¨ì€ìˆ¨ê¹€ì‹œê°„</button>
        <button class="flt" data-sort="oldest">ì˜¤ë˜ëœì‹ ê³ </button>
      </div>
      <div class="rep-filt" id="repFiltBar">
        <button class="flt on" data-filt="all">ì „ì²´</button>
        <button class="flt" data-filt="eligible">ê°€ë¦¼ì¡°ê±´ì¶©ì¡±</button>
        <button class="flt" data-filt="ineligible">ë¯¸ì¶©ì¡±</button>
      </div>
      <div id="repCommentList" class="rlist"></div>
      
      <div class="warning-users">
        <h4>âš ï¸ ìš”ì£¼ì˜ ìœ ì €</h4>
        <div id="warningUserList" style="font-size:12px"></div>
      </div>
      
      <div class="hr"></div>
      <div style="font-size:12px;opacity:.8">ê´€ë¦¬ììš© í”„ë¡ì‹œì™€ ëŒ“ê¸€/ìˆ¨ê¹€/ë³´ë¥˜ ë¦¬í¬íŠ¸ë¥¼ ë³‘í•©í•´ í‘œì‹œí•©ë‹ˆë‹¤.</div>
    </div>

    <div class="hr"></div>
    <h3>í†µí•© ê²€ìƒ‰</h3>
    <div class="row" style="align-items:stretch">
      <input id="qInput" class="inp" placeholder="ì œëª©/ë‚´ìš©ì—ì„œ ê²€ìƒ‰" aria-label="ê²€ìƒ‰ì–´ ì…ë ¥ (/)ë¡œ í¬ì»¤ìŠ¤" />
      <button id="qSearch" class="flt" title="ê²€ìƒ‰">ê²€ìƒ‰</button>
      <button id="qClear" class="flt" title="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
    </div>
    <div style="margin-top:8px; font-size:12px; opacity:.85">ìµœê·¼ 7ì¼ ì¸ê¸° ê²€ìƒ‰ì–´</div>
    <div id="qTrending" class="flt-wrap" style="margin-top:6px"></div>
  </aside>

  <div id="map" role="application" aria-label="ê²Œì„ ì›”ë“œ ì§€ë„"></div>

  <!-- ë°˜ì‘ ë©”ë‰´ -->
  <div id="reactionMenu" class="reaction-menu">
    <button data-emoji="ğŸ‘">ğŸ‘</button>
    <button data-emoji="ğŸ˜•">ğŸ˜•</button>
    <button data-emoji="â¤ï¸">â¤ï¸</button>
    <button data-emoji="â“">â“</button>
    <button data-emoji="â—">â—</button>
    <button data-emoji="âœ“">âœ“</button>
    <button data-emoji="âœ˜">âœ˜</button>
  </div>

  <!-- ìš°í•˜ë‹¨ ìƒì„¸ íŒ¨ë„ -->
  <aside id="info" aria-live="polite">
    <header>
      <h3 id="infoTitle">(ì œëª©)</h3>
      <span id="infoId" class="idtag">#-</span>
      <button id="btnConfirm" title="í™•ì¸ í‘œì‹œ">âœ“</button>
      <span class="view-count" id="pinViewCount">ì¡°íšŒ -</span>
      <button id="copyLinkBtn" title="ì´ í•€ ë§í¬ ë³µì‚¬">ë§í¬ë³µì‚¬</button>
      <button id="infoClose" title="ë‹«ê¸°(Esc)">ë‹«ê¸°</button>
    </header>
    <div class="media" id="infoMediaTop"></div>
    <div class="pad">
      <div class="meta" id="infoMeta"></div>
      <div id="infoPk" class="pk-tags"></div>
      <div id="infoBody" style="white-space:pre-wrap; margin-top:8px"></div>
      <div id="pinReactions" class="reactions"></div>

      <div id="infoCarousel" class="carousel" style="display:none">
        <div class="inner" id="carInner"></div>
        <button class="nav prev" id="carPrev" aria-label="ì´ì „">â€¹</button>
        <button class="nav next" id="carNext" aria-label="ë‹¤ìŒ">â€º</button>
        <div class="dots" id="carDots"></div>
      </div>

      <!-- ëŒ“ê¸€ -->
      <div id="comments">
        <div class="cform" id="cForm" style="display:none">
          <textarea id="cBody" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <div class="row"><button id="cSubmit">ëŒ“ê¸€ ë“±ë¡</button></div>
        </div>
        <div class="clist" id="cList"></div>
      </div>

      <div class="btns" id="infoBtns" style="margin-top:12px"></div>
    </div>
  </aside>

  <!-- ë§ˆì»¤ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="modal">
    <div class="panel">
      <h3>ë§ˆì»¤ ì¶”ê°€ (ê²€ìˆ˜ ëŒ€ê¸°)</h3>
      <input id="mTitle" class="inp" placeholder="ì œëª©" />
      <textarea id="mBody" class="inp" rows="4" placeholder="ê³µëµ/ì„¤ëª…(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>

      <label style="display:block;margin-top:8px">ì¹´í…Œê³ ë¦¬</label>
      <select id="mCat" class="inp"></select>
      <small class="muted">ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ì€ Firestore <code>categories/{ì¹´í…Œê³ ë¦¬í‚¤}.iconUrl</code>ë¡œ ì „ì—­ ë³€ê²½</small>

      <!-- ê¸°ìˆ ë¨¸ì‹  -->
      <div id="tmEditor" style="display:none; margin-top:10px">
        <label>ê¸°ìˆ ë¨¸ì‹  ë²ˆí˜¸</label>
        <input id="tmNumber" class="inp" placeholder="ì˜ˆ: 001" />
        <label style="margin-top:8px">ê¸°ìˆ ë¨¸ì‹  ì´ë¦„</label>
        <input id="tmName" class="inp" placeholder="ì˜ˆ: ëª¸í†µë°•ì¹˜ê¸°" />
      </div>

      <!-- ë©”ê°€ìŠ¤í†¤ -->
      <div id="megaEditor" style="display:none; margin-top:10px">
        <label>í¬ì¼“ëª¬ ì´ë¦„</label>
        <input id="megaPokemon" class="inp" placeholder="ì˜ˆ: ë¦¬ìëª½" />
      </div>

      <!-- ë¯¸ì…˜ -->
      <div id="missionEditor" style="display:none; margin-top:10px">
        <label>ë¯¸ì…˜ ë²ˆí˜¸</label>
        <input id="missionNumber" class="inp" placeholder="ì˜ˆ: M-01" />
      </div>

      <!-- ì•„ì´í…œ -->
      <div id="itemEditor" style="display:none; margin-top:10px">
        <label>ì•„ì´í…œ ì´ë¦„</label>
        <input id="itemName" class="inp" placeholder="ì•„ì´í…œ ì´ë¦„ ì…ë ¥" />
      </div>

      <!-- í¬ì¼“ëª¬ ì§€ì • -->
      <div id="pkEditor" style="display:none; margin-top:10px">
        <label>í¬ì¼“ëª¬(ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</label>
        <div class="row" style="align-items:stretch">
          <input id="pkAddInput" class="inp" placeholder="í¬ì¼“ëª¬ ì´ë¦„ ì…ë ¥ í›„ ì¶”ê°€" />
          <button id="pkAddBtn" class="flt">ì¶”ê°€</button>
          <button id="pkAddClear" class="flt">ì´ˆê¸°í™”</button>
        </div>
        <div id="pkChips" class="pk-tags" style="margin-top:6px"></div>
      </div>

      <!-- ì„ íƒ ì—…ë¡œë“œ -->
      <label style="display:block;margin-top:8px">ì‚¬ì§„(ì„ íƒ, ì—¬ëŸ¬ì¥ ê°€ëŠ¥)</label>
      <input id="mImgs" class="inp" type="file" accept="image/*" multiple />
      <label style="display:block;margin-top:8px">ë™ì˜ìƒ(ì„ íƒ, 1ê°œ ê¶Œì¥)</label>
      <input id="mVideo" class="inp" type="file" accept="video/*" />
      <div style="margin-top:12px; text-align:right">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button id="saveBtn">ë“±ë¡</button>
      </div>
    </div>
  </div>

  <!-- í”„ë¡œí•„ ëª¨ë‹¬ -->
  <div id="profileModal">
    <div class="panel">
      <h3>í”„ë¡œí•„ ì„¤ì •</h3>
      <div id="pfWho" style="font-size:12px; opacity:.8; margin-bottom:6px">(ë¡œê·¸ì¸ í•„ìš”)</div>
      
      <!-- ì—…ì  ì „ì‹œ -->
      <div id="pfAchievements" style="margin-bottom:12px">
        <strong>ì „ì‹œ ì—…ì </strong>
        <div id="pfAchievementList" style="margin-top:6px"></div>
        <button id="pfManageAchievements" class="tbtn" style="margin-top:6px">ì—…ì  ê´€ë¦¬</button>
      </div>
      
      <label>ë‹‰ë„¤ì„</label>
      <input id="pfNick" class="inp" maxlength="24" placeholder="ì§€ë„ì— í‘œì‹œë  ì´ë¦„" />
      <div class="hr"></div>
      
      <div><strong>ë‚´ ë­í¬</strong> Â· <span id="pfRank">(Z)</span></div>
      <div style="font-size:12px; opacity:.85; margin:6px 0">
        <strong>ì‹ ë¢°ë„:</strong> <span id="pfTrust">10</span>
      </div>
      
      <!-- XP ë°” -->
      <div class="xp-bar">
        <div class="xp-bar-fill" id="pfXpFill"></div>
        <div class="xp-bar-text" id="pfXpText">0 / 100 XP</div>
      </div>
      
      <div style="font-size:12px; opacity:.85">
        <strong>ì´ ì¡°íšŒìˆ˜:</strong> <span id="pfTotalViews">0</span>
      </div>
      <div style="font-size:12px; opacity:.85">
        <strong>ì´ ë°˜ì‘ ìˆ˜:</strong> <span id="pfTotalReactions">0</span>
      </div>
      
      <div class="hr"></div>
      <div style="font-size:12px; opacity:.85; margin:6px 0">
        <strong>ê²½í—˜ì¹˜ íšë“ ë°©ë²•:</strong><br>
        â€¢ í•€ ë“±ë¡: +100 XP<br>
        â€¢ ëŒ“ê¸€ ì‘ì„±: +10 XP<br>
        â€¢ ì‹ ê³  ìŠ¹ì¸: í•€ ì‘ì„±ì˜ 110% (+110 XP)
      </div>
      
      <div class="hr"></div>
      <div style="font-size:12px; opacity:.85; margin:6px 0">
        <strong>ì‹ ë¢°ë„ ì‹œìŠ¤í…œ:</strong><br>
        â€¢ ê¸°ë³¸ ì‹ ë¢°ë„: 10 (ìµœëŒ€ 100)<br>
        â€¢ í•€ ë“±ë¡: +10<br>
        â€¢ ëŒ“ê¸€ ë“±ë¡: +5<br>
        â€¢ ì‹ ê³  ì ‘ìˆ˜: -10<br>
        â€¢ ì‹ ê³  ìŠ¹ì¸: ì¶”ê°€ -10<br>
        â€¢ ì‹ ê³  ë°˜ë ¤: +15
      </div>
      
      <div class="hr"></div>
      <button id="pfTrustHistory" class="tbtn" style="margin-bottom:8px">ì‹ ë¢°ë„ ë‚´ì—­</button>
      
      <div style="text-align:right">
        <button id="pfClose">ë‹«ê¸°</button>
        <button id="pfSave" class="tbtn on">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- íƒ€ ìœ ì € í”„ë¡œí•„ ëª¨ë‹¬ -->
  <div id="otherProfileModal">
    <div class="panel">
      <h3>ìœ ì € í”„ë¡œí•„</h3>
      <div id="opNick" style="font-size:18px; font-weight:600; margin-bottom:8px"></div>
      
      <div id="opAchievements" style="margin-bottom:12px">
        <strong>ì „ì‹œ ì—…ì </strong>
        <div id="opAchievementList" style="margin-top:6px"></div>
      </div>
      
      <div style="font-size:14px; margin:6px 0">
        <strong>ë­í¬:</strong> <span id="opRank">Z</span>
      </div>
      <div style="font-size:14px; margin:6px 0">
        <strong>ì‹ ë¢°ë„:</strong> <span id="opTrust">10</span>
      </div>
      <div style="font-size:14px; margin:6px 0">
        <strong>ì´ ê²½í—˜ì¹˜:</strong> <span id="opXp">0</span> XP
      </div>
      <div style="font-size:14px; margin:6px 0">
        <strong>ì´ ì¡°íšŒìˆ˜:</strong> <span id="opViews">0</span>
      </div>
      
      <div style="text-align:right; margin-top:16px">
        <button id="opClose" class="tbtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì‹ ë¢°ë„ ë‚´ì—­ ëª¨ë‹¬ -->
  <div id="trustHistoryModal">
    <div class="panel">
      <h3>ì‹ ë¢°ë„ ë‚´ì—­</h3>
      <div id="trustHistoryList" style="max-height:400px; overflow:auto; margin:12px 0"></div>
      <div style="text-align:right">
        <button id="thClose" class="tbtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì—…ì  ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="achievementModal">
    <div class="panel">
      <h3>ì—…ì  ê´€ë¦¬</h3>
      <p style="font-size:12px; opacity:.8">ë‹¬ì„±í•œ ì—…ì  ì¤‘ ìµœëŒ€ 3ê°œë¥¼ í”„ë¡œí•„ì— ì „ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div id="achievementList" style="max-height:400px; overflow:auto; margin:12px 0"></div>
      <div style="text-align:right">
        <button id="achClose" class="tbtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë©”ì‹ ì € ëª¨ë‹¬ -->
  <div id="messengerModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ê´€ë¦¬ì§„ ë©”ì‹ ì €
        <span>
          <button id="msgClose" class="tbtn">ë‹«ê¸°</button>
        </span>
      </h3>
      <div id="chatBox" class="chat-wrap"></div>
      <div class="row" style="margin-top:8px">
        <input id="msgInput" class="inp" placeholder="ë©”ì„¸ì§€ ì…ë ¥â€¦" />
        <button id="msgSend" class="tbtn on">ë³´ë‚´ê¸°</button>
      </div>
      <div style="font-size:12px;opacity:.75;margin-top:6px">* ë‚´ê°€ ë³´ë‚¸ ë©”ì„¸ì§€ëŠ” ì¢Œì¸¡, ë‹¤ë¥¸ ê´€ë¦¬ìê°€ ë³´ë‚¸ ë©”ì„¸ì§€ëŠ” ìš°ì¸¡ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ê³µì§€ ì‘ì„±/ë³´ê¸° ëª¨ë‹¬ -->
  <div id="noticeModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ê³µì§€
        <span>
          <button id="noticeClose" class="tbtn">ë‹«ê¸°</button>
        </span>
      </h3>
      <div id="noticeView" style="display:none">
        <div style="font-size:12px;opacity:.8;margin-bottom:6px; display:flex; justify-content:space-between" id="noticeViewMeta">
          <span id="noticeDate"></span>
          <span class="view-count" id="noticeViewCount">ì¡°íšŒ -</span>
        </div>
        <h3 id="noticeTitle"></h3>
        <div id="noticeBody" style="white-space:pre-wrap;margin-top:8px"></div>
        <div id="noticeFiles" style="margin-top:10px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px" id="noticeAdminBtns"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button id="noticeHide24" class="tbtn">24ì‹œê°„ ë™ì•ˆ ì•ˆëœ¨ê²Œ</button>
          <button id="noticeDismiss" class="tbtn">ë‹«ê¸°</button>
        </div>
      </div>
      <div id="noticeEdit" style="display:none">
        <label>ì œëª©</label>
        <input id="ntTitle" class="inp" maxlength="80" />
        <label style="margin-top:8px;display:block">ë‚´ìš©</label>
        <textarea id="ntBody" class="inp" rows="6"></textarea>
        <label style="margin-top:8px;display:block">íŒŒì¼ ì²¨ë¶€(ì„ íƒ, ì—¬ëŸ¬ ê°œ)</label>
        <input id="ntFiles" class="inp" type="file" multiple />
        <div style="text-align:right;margin-top:10px">
          <button id="ntCancel" class="tbtn">ì·¨ì†Œ</button>
          <button id="ntSave" class="tbtn on">ì‘ì„± ì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê³µì§€ ëª©ë¡ ëª¨ë‹¬ -->
  <div id="noticeListModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ê³µì§€ ëª©ë¡
        <span style="display:flex;gap:8px;align-items:center">
          <button id="ntNew" class="tbtn" style="display:none">ê³µì§€ ì‘ì„±</button>
          <button id="ntListClose" class="tbtn">ë‹«ê¸°</button>
        </span>
      </h3>
      <div id="ntListWrap" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <!-- ê±´ì˜ ë° ë¬¸ì˜ ëª©ë¡ ëª¨ë‹¬ -->
  <div id="suggestListModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ê±´ì˜ ë° ë¬¸ì˜
        <span style="display:flex;gap:8px;align-items:center">
          <button id="sgNew" class="tbtn">ì‘ì„±í•˜ê¸°</button>
          <button id="sgListClose" class="tbtn">ë‹«ê¸°</button>
        </span>
      </h3>
      <div id="sgListWrap" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <!-- ê±´ì˜ ë° ë¬¸ì˜ ìƒì„¸/ì‘ì„± ëª¨ë‹¬ -->
  <div id="suggestModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ê±´ì˜ ë° ë¬¸ì˜
        <span>
          <button id="sgClose" class="tbtn">ë‹«ê¸°</button>
        </span>
      </h3>
      
      <div id="sgView" style="display:none">
        <div style="font-size:12px;opacity:.8;margin-bottom:6px" id="sgDate"></div>
        <h3 id="sgTitle"></h3>
        <div id="sgBody" style="white-space:pre-wrap;margin-top:8px"></div>
        
        <div class="hr"></div>
        <h4>ë‹µë³€</h4>
        <div id="sgReplies" style="margin-top:8px"></div>
        
        <div id="sgReplyForm" style="display:none; margin-top:12px">
          <textarea id="sgReplyBody" class="inp" rows="3" placeholder="ë‹µë³€ ì…ë ¥ (ê´€ë¦¬ì ì „ìš©)"></textarea>
          <div style="text-align:right; margin-top:8px">
            <button id="sgReplySubmit" class="tbtn on">ë‹µë³€ ë“±ë¡</button>
          </div>
        </div>
      </div>
      
      <div id="sgEdit" style="display:none">
        <label>ì œëª©</label>
        <input id="sgEditTitle" class="inp" maxlength="80" />
        <label style="margin-top:8px;display:block">ë‚´ìš©</label>
        <textarea id="sgEditBody" class="inp" rows="6"></textarea>
        <div style="text-align:right;margin-top:10px">
          <button id="sgEditCancel" class="tbtn">ì·¨ì†Œ</button>
          <button id="sgEditSave" class="tbtn on">ë“±ë¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¯¸ì…˜ ëª¨ë‹¬ -->
  <div id="missionsModal">
    <div class="panel">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ë¯¸ì…˜
        <button id="missionsClose" class="tbtn">ë‹«ê¸°</button>
      </h3>
      
      <h4>ì¼ì¼ ë¯¸ì…˜</h4>
      <div id="dailyMissions"></div>
      
      <div class="hr"></div>
      
      <h4>ì£¼ê°„ ë¯¸ì…˜</h4>
      <div id="weeklyMissions"></div>
    </div>
  </div>

  <!-- ì—…ì  ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ì) ëª¨ë‹¬ -->
  <div id="achievementListModal">
    <div class="panel wide">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        ì „ì²´ ì—…ì  ë¦¬ìŠ¤íŠ¸
        <button id="achListClose" class="tbtn">ë‹«ê¸°</button>
      </h3>
      <div id="achListContent" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <script type="module" src="za-patch-20251028.js"></script>
  
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    /* ---------------- ìœ í‹¸ ---------------- */
    if (!globalThis.CSS) globalThis.CSS = {};
    if (!CSS.escape) CSS.escape = s => String(s).replace(/["'\\\s]/g, m => '\\' + m);
    const esc = (s)=> (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    const nowMs = ()=> Date.now();
    const HIDE_MS = 48 * 3600 * 1000;
    const HIDE_DELAY_MS = 2 * 3600 * 1000;
    const HIDE_COUNT = 5;
    const toMs = (t)=>{
      if (!t) return null;
      if (t.toMillis) return t.toMillis();
      if (t.seconds)  return t.seconds*1000;
      if (typeof t === 'number') return t;
      const d = new Date(t); return isNaN(d) ? null : d.getTime();
    };
    const norm = s => (s||'').toLowerCase();
    const normName = s => (s||'').trim().toLowerCase();
    const fieldKey = s => normName(s).replace(/[.#$/\[\]\/]/g,'_');

    /* === ë¡œì»¬ ìƒíƒœ ì €ì¥/ë³µì› === */
    const LS = {
      save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} },
      load(k,def){ try{ const v = JSON.parse(localStorage.getItem(k)||'null'); return v==null?def:v; }catch{ return def; } }
    };
  
    // === Notice Seen (global) ===
    const SEEN_KEY = 'notice_seen_latest_id';
    function getLastSeenNoticeId(){ return LS.load(SEEN_KEY, '') || ''; }
    function setLastSeenNoticeId(id){ LS.save(SEEN_KEY, id || ''); }
    // Auto-open guard (respect 24h snooze)
    function guardNoticeAutoOpen(){ return isSnoozedNow(); }
  
    // ---- Notice Snooze Patch (UTILS) ----
    const SNOOZE_KEY_NOTICE = 'notice_snooze_until_ms';

    function setSnoozeUntilMs(ms){
      const v = Number(ms)||0;
      LS.save(SNOOZE_KEY_NOTICE, v);
    }
    function getSnoozeUntilMs(){
      const v = Number(LS.load(SNOOZE_KEY_NOTICE, 0));
      return Number.isFinite(v) ? v : 0;
    }
    function isSnoozedNow(){
      return getSnoozeUntilMs() > Date.now();
    }
    function humanRemain(ms){
      const m = Math.max(0, Math.floor(ms/60000));
      const h = Math.floor(m/60);
      const mm = m%60;
      return h ? `${h}ì‹œê°„ ${mm}ë¶„` : `${mm}ë¶„`;
    }
    // -------------------------------------

    /* ---------------- Leaflet ---------------- */
    const IMG_URL = "za_world_map_clean_fixed.png";
    const IMG_W = 2048, IMG_H = 2048;
    const map = L.map('map', { 
      crs: L.CRS.Simple, 
      minZoom: -2, 
      maxZoom: 4,
      zoomControl: false  // âœ… ì¤Œ ì»¨íŠ¸ë¡¤ ì œê±°
    });
    const bounds = [[0,0],[IMG_H,IMG_W]];
    L.imageOverlay(IMG_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    const isInside = (latlng)=> map.getBounds().contains(latlng);

    map.createPane('wildPane');
    map.getPane('wildPane').style.zIndex = 450;
    map.getPane('wildPane').style.pointerEvents = 'none';
    const wildLayer = L.layerGroup().addTo(map);
    let wildVisible = LS.load('wildVisible', true);

    let showPendingOnly = LS.load('showPendingOnly', false);
    let adminReportMode = false;

    /* ---------------- Firebase ---------------- */
    let firebaseOk = true;
    let app, auth, db, st;
    let GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged;
    let collection, collectionGroup, addDoc, serverTimestamp, onSnapshot,
        orderBy, query, doc, updateDoc, deleteDoc, where, getDocs, getDoc, setDoc, increment, limit, arrayUnion, arrayRemove;
    let ref, getDownloadURL, uploadBytesResumable, uploadBytes;

    try {
      const [appMod, authMod, fsMod, stMod] = await Promise.all([
        import("https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"),
        import("https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"),
        import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"),
        import("https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"),
      ]);
      const firebaseConfig = {
        apiKey: "AIzaSyCam7y7qNINoxBlTeGx7CDlP8Y77pXFMWA",
        authDomain: "za-maps-32982.firebaseapp.com",
        projectId: "za-maps-32982",
        storageBucket: "za-maps-32982.appspot.com",
        messagingSenderId: "804333155537",
        appId: "1:804333155537:web:504bc3ee175e3678bc81f0",
        measurementId: "G-GTRK8JEZFM"
      };
      app = appMod.initializeApp(firebaseConfig);
      auth = authMod.getAuth(app);
      db   = fsMod.getFirestore(app);
      st   = stMod.getStorage(app);
      ({ GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod);
      ({ collection, collectionGroup, addDoc, serverTimestamp, onSnapshot, orderBy, query, doc, updateDoc, deleteDoc, where, getDocs, getDoc, setDoc, increment, limit, arrayUnion, arrayRemove } = fsMod);
      ({ ref, getDownloadURL, uploadBytesResumable, uploadBytes } = stMod);
    } catch (e) {
      firebaseOk = false;
      console.warn("[Firebase] ë™ì  import ì‹¤íŒ¨ â€” ì˜¤í”„ë¼ì¸ ëª¨ë“œ", e);
    }
  
    // === ê³µì§€ ìë™ ì˜¤í”ˆ/ê°•ì¡° ===
    let currentNoticeId = null;

    async function openNoticeDoc(n){
      currentNoticeId = n.id;

      const modal = document.getElementById('noticeModal');
      const view  = document.getElementById('noticeView');
      const edit  = document.getElementById('noticeEdit');

      if (!modal || !view) return;
      // ë‚´ìš© ì±„ìš°ê¸°
      document.getElementById('noticeTitle').textContent = n.title || '(ì œëª© ì—†ìŒ)';
      document.getElementById('noticeBody').textContent  = n.body  || '';
      document.getElementById('noticeDate').textContent  = n.createdAt
          ? new Date(toMs(n.createdAt)).toLocaleString()
          : '';

      const vc = (n.viewCount || 0) + 1;
      const vcEl = document.getElementById('noticeViewCount');
      if (vcEl) vcEl.textContent = `ì¡°íšŒ ${vc}`;

      // ì²¨ë¶€(ìˆìœ¼ë©´)
      const filesWrap = document.getElementById('noticeFiles');
      if (filesWrap){
        const files = Array.isArray(n.files) ? n.files : [];
        filesWrap.innerHTML = files.map(u =>
          `<div style="margin-top:6px"><a href="${esc(u)}" target="_blank" rel="noopener">ì²¨ë¶€ ë³´ê¸°</a></div>`
        ).join('');
      }

      // ë³´ê¸° ëª¨ë“œ í‘œì‹œ
      view.style.display = 'block';
      if (edit) edit.style.display = 'none';
      modal.style.display = 'flex';

      // ê³„ì •ë³„ 'ì½ìŒ' ê¸°ë¡
      setLastSeenNoticeId(n.id);

      // ë±ƒì§€/í•˜ì´ë¼ì´íŠ¸ í•´ì œ
      try {
        const btn = document.getElementById('btnNoticeList');
        if (btn) btn.classList.remove('on');
      } catch {}

      // ì¡°íšŒìˆ˜ ì¦ê°€
      try { await updateDoc(doc(db,'notices', n.id), { viewCount: increment(1) }); } catch(_e){}
    }

    async function tryOpenLatestNotice(){
      if (!firebaseOk) return;
      if (isSnoozedNow()) return;

      // ìµœì‹  ê³µì§€ 1ê°œ
      const qLatest = query(collection(db,'notices'), orderBy('createdAt','desc'), limit(1));
      const snap = await getDocs(qLatest);
      if (snap.empty) return;

      const d  = snap.docs[0];
      const n  = { id: d.id, ...d.data() };
      const seenId = getLastSeenNoticeId();

      // ì´ë¯¸ ë³¸ ê³µì§€ëŠ” ìë™ ì˜¤í”ˆ ì•ˆ í•¨
      if (seenId === d.id) {
        // ëŒ€ì‹  ë²„íŠ¼ì„ í•˜ì´ë¼ì´íŠ¸ í•´ì œë§Œ ë³´ì¥
        const btn = document.getElementById('btnNoticeList');
        if (btn) btn.classList.remove('on');
        return;
      }

      await openNoticeDoc(n);
    }

    async function highlightNoticeIfUnseen(){
      if (!firebaseOk) return;
      const qLatest = query(collection(db,'notices'), orderBy('createdAt','desc'), limit(1));
      const snap = await getDocs(qLatest);
      if (snap.empty) return;

      const latestId = snap.docs[0].id;
      const btn = document.getElementById('btnNoticeList');
      if (!btn) return;

      if (getLastSeenNoticeId() !== latestId){
        // ìƒˆ ê³µì§€ ìˆìŒ â†’ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
        btn.classList.add('on');
        btn.title = 'ìƒˆ ê³µì§€ ìˆìŒ';
      } else {
        btn.classList.remove('on');
        btn.title = 'ê³µì§€ ëª©ë¡';
      }
    }

    /* ---------------- ì—…ë¡œë“œ ìœ í‹¸ ---------------- */
    async function safeMergeDoc(pathArr, data){
      if (!firebaseOk) return;
      await setDoc(doc(db, ...pathArr), data, { merge: true });
    }
    const safeName = (name)=> name.normalize('NFKD').replace(/[^\w.\-]+/g,'_').replace(/_+/g,'_').slice(-80);
    globalThis.uploadSmart = async function uploadSmart(file, folder, onProgress, label='ì—…ë¡œë“œ'){
      if (!firebaseOk) throw new Error('Firebase unavailable');
      const uid = (me && me.uid) || 'anon';
      const fname = `${Date.now()}_${safeName(file.name)}`;
      const path  = `${folder}/${uid}/${fname}`;
      const r     = ref(st, path);
      try{
        onProgress?.(`${label}â€¦`);
        await uploadBytes(r, file);
        return await getDownloadURL(r);
      }catch(e1){
        console.warn('[upload] simple ì‹¤íŒ¨ â†’ resumable', e1);
      }
      const task = uploadBytesResumable(r, file);
      await new Promise((resolve, reject)=>{
        task.on('state_changed',
          s=> onProgress?.(`${label}â€¦ ${Math.round(s.bytesTransferred/s.totalBytes*100)}%`),
          reject, resolve);
      });
      return await getDownloadURL(r);
    };
    // markers ì“°ê¸° ì‹¤íŒ¨(ê¶Œí•œ) ì‹œ submissionsë¡œ í´ë°± ì €ì¥
    async function tryAddMarker(docData){
      if (!firebaseOk) throw new Error('Firebase unavailable');
      // ì•ˆì „ì¥ì¹˜: ì¹´í…Œê³ ë¦¬ ì •ê·œí™” ë³´ì¥
      docData.category = normalizeCategoryKey(docData.category);
      try{
        const r = await addDoc(collection(db, 'markers'), docData);
        return { ok:true, id:r.id, to:'markers' };
      }catch(e){
        const msg = String(e?.message||'');
        const code = String(e?.code||'');
        if (code === 'permission-denied' || /Missing or insufficient permissions/i.test(msg)){
          const r2 = await addDoc(collection(db, 'submissions'), {
            ...docData,
            status: 'pending',
            createdAt: serverTimestamp(),
            submittedBy: me?.uid || null
          });
          alert('ê¶Œí•œ ë¬¸ì œë¡œ ê²€ìˆ˜í•¨ì— ì„ì‹œ ì €ì¥í–ˆì–´ìš”. ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ì§€ë„ì— ë°˜ì˜ë¼ìš”.');
          return { ok:false, id:r2.id, to:'submissions' };
        }
        throw e;
      }
    }

    /* ---------------- ì¹´í…Œê³ ë¦¬ ---------------- */
    const CATEGORIES = [
      {key:'ì¥ì†Œ-ì™€ì¼ë“œ ì¡´',       label:'ì™€ì¼ë“œ ì¡´',       defaultIcon:'wild_zone.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-ì¤‘ìš”í•œ ì¥ì†Œ',     label:'ì¤‘ìš”í•œ ì¥ì†Œ',     defaultIcon:'poi.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-í¬ì¼“ëª¬ ì„¼í„°',     label:'í¬ì¼“ëª¬ ì„¼í„°',     defaultIcon:'pokemon_center.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-ì¹´í˜',           label:'ì¹´í˜',           defaultIcon:'cafe.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-ë ˆìŠ¤í† ë‘',       label:'ë ˆìŠ¤í† ë‘',       defaultIcon:'restaurant.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-í—¤ì–´ì‚´ë¡±',       label:'í—¤ì–´ ì‚´ë¡±',       defaultIcon:'hair_salon.png', group:'ì¥ì†Œ'},
      {key:'ì¥ì†Œ-ë¶€í‹°í¬',         label:'ë¶€í‹°í¬',         defaultIcon:'boutique.png', group:'ì¥ì†Œ'},
      {key:'ì•„ì´í…œ-ì»¬ëŸ¬í’€í•œ ë‚˜ì‚¬',   label:'ì»¬ëŸ¬í’€í•œ ë‚˜ì‚¬',   defaultIcon:'colorful_screw.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-ì¤‘ìš” ì•„ì´í…œ',     label:'ì¤‘ìš” ì•„ì´í…œ',     defaultIcon:'key_item.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-ë³´ë¬¼',           label:'ë³´ë¬¼',           defaultIcon:'treasure.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-ë©”ê°€ìŠ¤í†¤',       label:'ë©”ê°€ìŠ¤í†¤',       defaultIcon:'mega_stone.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-í¬ì¼“ëª¬ ë³¼',       label:'í¬ì¼“ëª¬ ë³¼',       defaultIcon:'poke_ball.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-íšŒë³µ ì•„ì´í…œ',     label:'íšŒë³µ ì•„ì´í…œ',     defaultIcon:'medicine.png', group:'ì•„ì´í…œ'},
      {key:'ì•„ì´í…œ-ê¸°íƒ€ ì•„ì´í…œ',     label:'ê¸°íƒ€ ì•„ì´í…œ',     defaultIcon:'other_item.png', group:'ì•„ì´í…œ'},
      {key:'ì„ë¬´-ë©”ì¸ ì„ë¬´',       label:'ë©”ì¸ ì„ë¬´',       defaultIcon:'main_mission.png', group:'ì„ë¬´'},
      {key:'ì„ë¬´-ì‚¬ì´ë“œ ì„ë¬´',     label:'ì‚¬ì´ë“œ ì„ë¬´',     defaultIcon:'side_mission.png', group:'ì„ë¬´'},
      {key:'ì„ë¬´-ìŠ¹ê¸‰ì „',         label:'ìŠ¹ê¸‰ì „',         defaultIcon:'promotion_match.png', group:'ì„ë¬´'},
      {key:'ì„ë¬´-NPC',            label:'NPC',            defaultIcon:'npc.png', group:'ì„ë¬´'},
      {key:'í¬ì¼“ëª¬-ë©”ê°€ í¬ì¼“ëª¬',     label:'ë©”ê°€ í¬ì¼“ëª¬',     defaultIcon:'mega_pokemon.png', group:'í¬ì¼“ëª¬'},
      {key:'í¬ì¼“ëª¬-ìš°ë‘ë¨¸ë¦¬ í¬ì¼“ëª¬', label:'ìš°ë‘ë¨¸ë¦¬ í¬ì¼“ëª¬', defaultIcon:'alpha_pokemon.png', group:'í¬ì¼“ëª¬'},
      {key:'ê¸°íƒ€-í™€ë¡œë² ì´í„°',     label:'í™€ë¡œë² ì´í„°',     defaultIcon:'holovator.png', group:'ê¸°íƒ€'},
      {key:'ê¸°íƒ€-ì‚¬ë‹¤ë¦¬',         label:'ì‚¬ë‹¤ë¦¬',         defaultIcon:'ladder.png', group:'ê¸°íƒ€'},
      {key:'ê¸°íƒ€-ê¸°ìˆ ë¨¸ì‹ ',       label:'ê¸°ìˆ ë¨¸ì‹ ',       defaultIcon:'tm.png', group:'ê¸°íƒ€'},
      {key:'ê¸°íƒ€-ê¸°íƒ€',           label:'ê¸°íƒ€',           defaultIcon:'misc.png', group:'ê¸°íƒ€'},
    ];
    
    const POKEMON_CATS = ['ì¥ì†Œ-ì™€ì¼ë“œ ì¡´','í¬ì¼“ëª¬-ìš°ë‘ë¨¸ë¦¬ í¬ì¼“ëª¬','í¬ì¼“ëª¬-ë©”ê°€ í¬ì¼“ëª¬'];
    const TM_CAT = 'ê¸°íƒ€-ê¸°ìˆ ë¨¸ì‹ ';
    const MEGA_STONE_CAT = 'ì•„ì´í…œ-ë©”ê°€ìŠ¤í†¤';
    const MISSION_CATS = ['ì„ë¬´-ë©”ì¸ ì„ë¬´', 'ì„ë¬´-ì‚¬ì´ë“œ ì„ë¬´'];
    const ITEM_CATS = ['ì•„ì´í…œ-ì¤‘ìš” ì•„ì´í…œ', 'ì•„ì´í…œ-í¬ì¼“ëª¬ ë³¼', 'ì•„ì´í…œ-íšŒë³µ ì•„ì´í…œ', 'ì•„ì´í…œ-ë³´ë¬¼', 'ì•„ì´í…œ-ê¸°íƒ€ ì•„ì´í…œ'];
    
    const catSel = document.getElementById('mCat');
    catSel.innerHTML = CATEGORIES.map(c=>`<option value="${c.key}">${c.label}</option>`).join('');

    const categoryIconOverride = new Map();
    if (firebaseOk){
      onSnapshot(collection(db,'categories'), snap=>{
        categoryIconOverride.clear();
        snap.forEach(d=>{ const v=d.data()?.iconUrl; if (v) categoryIconOverride.set(d.id, v); });
      });
    }
  
    /* PATCH START: robust category resolution (2025-10-28) */
    const CAT_BY_KEY   = new Map(CATEGORIES.map(c => [c.key, c]));
    const CAT_BY_LABEL = new Map(CATEGORIES.map(c => [c.label, c]));    
    function resolveCategoryKey(k){
      if (!k) return k;
      if (CAT_BY_KEY.has(k)) return k;
      if (CAT_BY_LABEL.has(k)) return CAT_BY_LABEL.get(k).key;
      const s = (k+'').toLowerCase();
      if (s.includes('ê¸°ìˆ ë¨¸ì‹ ')) return TM_CAT;
      if (s.includes('ë©”ê°€ìŠ¤í†¤') || s.includes('ë©”ê°€ ìŠ¤í†¤')) return MEGA_STONE_CAT;
      return k; // ì•Œ ìˆ˜ ì—†ìœ¼ë©´ ì›ë³¸ ìœ ì§€
    }

    // ê¸°ì¡´ iconUrlForCatì„ êµì²´í•´ ë¼ë²¨/í‚¤ ëª¨ë‘ ì§€ì›
    function iconUrlForCat(cat){
      const key = resolveCategoryKey(cat);
      const override = categoryIconOverride.get(key);
      if (override) return override;
      const def = CAT_BY_KEY.get(key)?.defaultIcon;
      return def ? `icons/${def}` : `icons/default.png`;
    }
    /* PATCH END */
  
    const labelFor=(key)=> CATEGORIES.find(c=>c.key===key)?.label || key;
    const defaultIconFor=(key)=>{
    const def = CATEGORIES.find(c=>c.key===key)?.defaultIcon;
    return def ? `icons/${def}` : `icons/misc.png`;
  };
    // ë¼ë²¨â†’í‚¤ ë§¤í•‘ (ë ˆê±°ì‹œ í˜¸í™˜)
    const KEY_BY_LABEL = Object.fromEntries(CATEGORIES.map(c => [c.label, c.key]));

    // ì¹´í…Œê³ ë¦¬ ê°’ ì •ê·œí™”: í‚¤ë©´ ê·¸ëŒ€ë¡œ, ë¼ë²¨/ì˜›ê°’ì´ë©´ í‚¤ë¡œ í™˜ì‚°, ìµœì¢… ì‹¤íŒ¨ ì‹œ 'ê¸°íƒ€-ê¸°íƒ€'
    function normalizeCategoryKey(k){
      if (!k) return 'ê¸°íƒ€-ê¸°íƒ€';
      if (CATEGORIES.some(c => c.key === k)) return k;
      const byLabel = KEY_BY_LABEL[k] || KEY_BY_LABEL[String(k).trim()];
      return byLabel || 'ê¸°íƒ€-ê¸°íƒ€';
    }

    /* ---------------- ë¡œê·¸ì¸/ê´€ë¦¬ì ìƒíƒœ + í”„ë¡œí•„/ë­í¬ ---------------- */
    const $who = document.getElementById('who');
    const $login = document.getElementById('login');
    const $logout = document.getElementById('logout');
    const $btnProfile = document.getElementById('btnProfile');
    const $adminBadge = document.getElementById('adminBadge');
    const $btnPendingOnly = document.getElementById('btnPendingOnly');
    const $btnAdminReport = document.getElementById('btnAdminReport');
    const $btnMsg = document.getElementById('btnMsg');
    const $msgBang = document.getElementById('msgBang');
    let me=null, isAdmin=false, unsubAdminDoc=null;

    // ë­í¬ ì •ì˜
    const RANKS = 'ZYXWVUTSRQPONMLKJIHGFEDCBA'.split('');
    const PIN_XP = 100, CMT_XP = 10, REPORT_APPROVED_XP = 110;
    const FIRST_PIN_AUTO_UP = true;
    
    function xpForRankIndex(i){
      let req=0, step=100;
      for(let k=0;k<i;k++){ req += step; step*=2; }
      return req;
    }
    
    function totalToRank(totalXP){
      const aIdx = RANKS.length-1;
      const aNeed = xpForRankIndex(aIdx);
      if (totalXP < aNeed){
        let idx=0;
        while(idx<RANKS.length && xpForRankIndex(idx)<=totalXP) idx++;
        idx = Math.max(0, idx-1);
        const curNeed = xpForRankIndex(idx);
        const nextNeed = xpForRankIndex(Math.min(idx+1, aIdx));
        return { idx, rank:RANKS[idx], plus:0, cur: totalXP-curNeed, next: Math.max(0, nextNeed-totalXP), cap:false, q:false };
      }
      const over = totalXP - aNeed;
      const plusUnit = 50000;
      let plus = Math.floor(over / plusUnit);
      if (plus<=5){
        const next = (plus<5) ? (plusUnit - (over % plusUnit)) : 0;
        const cap = plus>=5;
        return { idx:aIdx, rank:'A' + '+'.repeat(plus), plus, cur: over%plusUnit, next, cap, q:false };
      }
      return { idx:aIdx, rank:'?', plus:999, cur:0, next:0, cap:true, q:true };
    }

    // âœ… ì—…ì  ì •ì˜
    const ACHIEVEMENTS = [
      {id:'pioneer', name:'ê°œì²™ì', desc:'í•€ì„ ì²˜ìŒìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”', tier:'normal', xp:50, check:(p)=>p.pinsCreated>=1},
      {id:'listener', name:'ê²½ì²­ì', desc:'ì²˜ìŒìœ¼ë¡œ ë°˜ì‘ì„ ì¶”ê°€í•´ë³´ì„¸ìš”', tier:'normal', xp:50, check:(p)=>p.reactionsGiven>=1},
      {id:'questioner', name:'ì§ˆë¬¸ì', desc:'ëŒ“ê¸€ì„ ì²˜ìŒìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”', tier:'normal', xp:50, check:(p)=>p.commentsCreated>=1},
      {id:'guardian', name:'ì •ì˜ì˜ ìˆ˜í˜¸ì', desc:'ì‹ ê³ ê°€ ì²˜ìŒìœ¼ë¡œ ìŠ¹ì¸ë˜ì–´ë³´ì„¸ìš”', tier:'normal', xp:50, check:(p)=>p.reportsApproved>=1},
      {id:'suggester', name:'ì œì•ˆì', desc:'ì²˜ìŒìœ¼ë¡œ ì˜ê²¬ì„ ì œì¶œí•´ë³´ì„¸ìš”', tier:'rare', xp:150, check:(p)=>p.suggestionsMade>=1},
      {id:'novice_explorer', name:'ì´ˆë³´ íƒí—˜ê°€', desc:'í•€ì„ ì²˜ìŒìœ¼ë¡œ ë¹„í™œì„±í™” í•´ë³´ì„¸ìš”', tier:'normal', xp:50, check:(p)=>p.pinsConfirmed>=1},
      {id:'veteran_explorer', name:'ì¤‘ê²¬ íƒí—˜ê°€', desc:'í•€ì„ 50ê°œ ì´ìƒ ë¹„í™œì„±í™” í•˜ì„¸ìš”', tier:'epic', xp:500, check:(p)=>p.pinsConfirmed>=50},
      {id:'legend_explorer', name:'ì „ì„¤ì˜ íƒí—˜ê°€', desc:'í•€ì„ 100ê°œ ì´ìƒ ë¹„í™œì„±í™” í•˜ì„¸ìš”', tier:'legend', xp:2500, check:(p)=>p.pinsConfirmed>=100},
      {id:'celebrity', name:'ì…€ëŸ¬ë¸Œë¦¬í‹°', desc:'ë°˜ì‘ì„ ë°›ì€ íšŸìˆ˜ê°€ 1000íšŒë¥¼ ë„˜ê¸°ì„¸ìš”', tier:'epic', xp:500, check:(p)=>p.reactionsReceived>=1000},
      {id:'star', name:'ì—°ì˜ˆì¸', desc:'ì´ ì¡°íšŒìˆ˜ê°€ 10000ì„ ë„˜ìœ¼ì„¸ìš”', tier:'legend', xp:2500, check:(p)=>p.totalViews>=10000},
    ];

    // âœ… ë¯¸ì…˜ ì •ì˜
    const DAILY_MISSIONS = [
      {id:'daily_login', name:'ë¡œê·¸ì¸í•˜ê¸°', xp:20, check:(m)=>m.loginToday},
      {id:'daily_comment', name:'ëŒ“ê¸€ 1ê°œ ì´ìƒ ë‹¬ê¸°', xp:20, check:(m)=>m.commentsToday>=1},
      {id:'daily_notice', name:'ê³µì§€ í™•ì¸í•˜ê¸°', xp:20, check:(m)=>m.noticeCheckedToday},
      {id:'daily_complete', name:'ì¼ì¼ë¯¸ì…˜ 3ê°œ í•˜ê¸°', xp:40, check:(m)=>{
        const completed = [m.loginToday, m.commentsToday>=1, m.noticeCheckedToday].filter(x=>x).length;
        return completed>=3;
      }},
    ];

    const WEEKLY_MISSIONS = [
      {id:'weekly_login', name:'ë¡œê·¸ì¸ 5íšŒ ì´ìƒ í•˜ê¸°', xp:60, check:(m)=>m.loginDaysThisWeek>=5},
      {id:'weekly_pin', name:'í•€ 1ê°œ ì´ìƒ ë“±ë¡í•˜ê¸°', xp:60, check:(m)=>m.pinsThisWeek>=1},
      {id:'weekly_suggest', name:'ê±´ì˜ ë° ë¬¸ì˜ 1íšŒ ì´ìƒ í•˜ê¸°', xp:60, check:(m)=>m.suggestionsThisWeek>=1},
      {id:'weekly_reactions', name:'í•€ í˜¹ì€ ëŒ“ê¸€ì— ë°˜ì‘ 3íšŒ ì´ìƒ ë‚¨ê¸°ê¸°', xp:60, check:(m)=>m.reactionsThisWeek>=3},
      {id:'weekly_complete', name:'ì£¼ê°„ë¯¸ì…˜ 3ê°œ ì´ìƒ í•˜ê¸°', xp:120, check:(m)=>{
        const completed = [
          m.loginDaysThisWeek>=5,
          m.pinsThisWeek>=1,
          m.suggestionsThisWeek>=1,
          m.reactionsThisWeek>=3
        ].filter(x=>x).length;
        return completed>=3;
      }},
    ];

    async function checkAchievements(uid){
      if (!firebaseOk || !uid) return;
      const pfRef = doc(db,'profiles', uid);
      const snap = await getDoc(pfRef);
      if (!snap.exists()) return;
      const profile = snap.data();
      const unlocked = profile.achievementsUnlocked || [];
      
      for (const ach of ACHIEVEMENTS){
        if (unlocked.includes(ach.id)) continue;
        if (ach.check(profile)){
          await updateDoc(pfRef, {
            achievementsUnlocked: arrayUnion(ach.id),
            xp: increment(ach.xp)
          });
          showAchievementPopup(ach);
        }
      }
    }

    function showAchievementPopup(ach){
      const tierLabels = {normal:'ë…¸ë§', rare:'ë ˆì–´', epic:'ì—í”½', legend:'ë ˆì „ë“œ'};
      const popup = document.createElement('div');
      popup.className = 'achievement-popup';
      popup.innerHTML = `
        <h3>ğŸ‰ ì—…ì  ë‹¬ì„±!</h3>
        <div class="achievement-badge ${ach.tier}">${ach.name}</div>
        <p style="margin:8px 0">${ach.desc}</p>
        <p style="font-size:12px; opacity:.8">${tierLabels[ach.tier]} ì—…ì  Â· +${ach.xp} XP</p>
      `;
      document.body.appendChild(popup);
      setTimeout(()=>popup.remove(), 4000);
    }

    async function awardXP(kind, customAmount){
      if (!firebaseOk || !me) return;
      const pfRef = doc(db,'profiles', me.uid);
      const snap = await getDoc(pfRef);
      const data = snap.exists()? (snap.data()||{}) : {};
      let xp = data.xp||0;
      const amount = customAmount !== undefined ? customAmount : (kind==='pin'? PIN_XP : CMT_XP);
      xp += amount;
      
      let firstPinBoon=false;
      if (kind==='pin' && FIRST_PIN_AUTO_UP && (data.rankCode||'Z')==='Z' && !(data.pinnedOnce)){
        firstPinBoon = true;
      }
      const calc = totalToRank(xp);
      let rankCode = calc.rank;
      if (firstPinBoon) { rankCode = 'Y'; }
      
      await setDoc(pfRef, {
        uid: me.uid,
        nick: data.nick || (me.displayName||'ìµëª…'),
        xp,
        rankCode,
        pinnedOnce: data.pinnedOnce || (kind==='pin')
      }, { merge:true });

      if (calc.q && typeof toast === 'function'){
        toast('ê²½ê³ : A+++++ ì´ˆê³¼ ì‹œ ë­í¬ í‘œê¸°ê°€ ? ë¡œ í‘œì‹œë©ë‹ˆë‹¤');
      }

      
      await checkAchievements(me.uid);
    }

    // âœ… ì‹ ë¢°ë„ ê´€ë¦¬
    async function addTrust(uid, amount, reason){
      if (!firebaseOk || !uid) return;
      const pfRef = doc(db,'profiles', uid);
      const snap = await getDoc(pfRef);
      const data = snap.exists() ? (snap.data()||{}) : {};
      const currentTrust = data.trust || 10;
      const newTrust = Math.max(-999, Math.min(100, currentTrust + amount));
      
      await setDoc(pfRef, { trust: newTrust }, { merge:true });
      await addDoc(collection(db,'profiles', uid, 'trustHistory'), {
        amount, reason, timestamp: serverTimestamp(), newTotal: newTrust
      });
    }

    function nameWithRank(nick, rankCode, trust, isAdminFlag){
      const trustStr = trust !== undefined ? ` â€¢ ì‹ ë¢°ë„: ${trust >= 0 ? trust : `<span class="trust-negative">${trust}</span>`}` : '';
      return `${nick||'ìµëª…'} â€¢ ${isAdminFlag ? 'ê´€ë¦¬ì' : (rankCode||'Z')}${trustStr}`;
    }

    async function ensureProfileOnLogin(){
      if (!firebaseOk || !me) return;
      const pfRef = doc(db,'profiles', me.uid);
      const snap = await getDoc(pfRef);
      if (!snap.exists()){
        openProfile(true);
        alert('ìµœì´ˆ ë¡œê·¸ì¸: ì–´ë–¤ ë‹‰ë„¤ì„ìœ¼ë¡œ í™œë™í• ì§€ ì„¤ì •í•´ì£¼ì„¸ìš”.\nì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ Google ë‹‰ë„¤ì„ìœ¼ë¡œ í™œë™í•©ë‹ˆë‹¤.');
        await setDoc(pfRef, {
          uid: me.uid,
          nick: me.displayName || 'ìµëª…',
          xp: 0,
          rankCode: 'Z',
          trust: 10,
          createdAt: serverTimestamp(),
          pinsCreated:0, commentsCreated:0, reactionsGiven:0, reactionsReceived:0,
          reportsApproved:0, suggestionsMade:0, pinsConfirmed:0, totalViews:0,
          achievementsUnlocked:[], achievementsDisplayed:[]
        }, { merge:true });
      } else {
        const data = snap.data()||{};
        $who.textContent = nameWithRank(data.nick, data.rankCode, data.trust, isAdmin);
      }
    }

    const $btnNoticeList = document.getElementById('btnNoticeList');
    
    // ---- Notice Snooze Patch (BUTTON WIRING) ----
    const $noticeModalEl = document.getElementById('noticeModal');
    const $noticeHide24  = document.getElementById('noticeHide24');
    const $noticeDismiss = document.getElementById('noticeDismiss'); // ì´ë¯¸ ìˆìŒ

    function closeNoticeModal(){
      if ($noticeModalEl) $noticeModalEl.style.display = 'none';
    }

    if ($noticeHide24){
      $noticeHide24.onclick = ()=>{
        // 24ì‹œê°„ ìŠ¤ëˆ„ì¦ˆ ì„¤ì •
        setSnoozeUntilMs(Date.now() + 24*3600*1000);
        closeNoticeModal();
        // ë²„íŠ¼ ìƒíƒœ(íˆ´íŒ/ë¶ˆíˆ¬ëª…ë„) ì¦‰ì‹œ ë°˜ì˜
        const btn = document.getElementById('btnNoticeList');
        if (btn){
          btn.title = 'ê³µì§€ ìŠ¤ëˆ„ì¦ˆ ì¤‘';
          btn.style.opacity = '0.6';
        }
        alert('24ì‹œê°„ ë™ì•ˆ ê³µì§€ê°€ ìë™ìœ¼ë¡œ ëœ¨ì§€ ì•Šì•„ìš”.');
      };
    }

    if ($noticeDismiss){
     $noticeDismiss.onclick = ()=>{
        // ê·¸ëƒ¥ ë‹«ì•„ë„ 'ì½ìŒ' ì²˜ë¦¬í•´ì„œ ìë™ ì¬ì˜¤í”ˆ ë°©ì§€
        try { setLastSeenNoticeId(currentNoticeId || getLastSeenNoticeId()); } catch(_e){}
        closeNoticeModal();
      };
  }
    // ----------------------------------------------
  
    $login.onclick = async () => {
      if (!firebaseOk) { alert('ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ìœ¼ë¡œ ë¡œê·¸ì¸ ë¶ˆê°€'); return; }
      try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch{ await signInWithRedirect(auth, new GoogleAuthProvider()); }
    };
    $logout.onclick = ()=>{ if(firebaseOk) signOut(auth); };

    if (firebaseOk) getRedirectResult(auth).catch(()=>{});

    function applyAdminUI() {
      // âœ… ê´€ë¦¬ì ë­í¬ëŠ” "ê´€ë¦¬ì"ë¡œ í‘œì‹œ
      $adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
      $btnPendingOnly.style.display = isAdmin ? 'inline-block' : 'none';
      $btnAdminReport.style.display = isAdmin ? 'inline-block' : 'none';
      $btnMsg.style.display = isAdmin ? 'inline-block' : 'none';
      if (!isAdmin) {
        showPendingOnly = false;
        $btnPendingOnly.classList.remove('on');
        if (adminReportMode) setAdminReportMode(false);
      }
      applyAllVisibility();
      subscribeMarkers();
      subscribeReportedCommentsAdmin();
      wireAdminMessenger();
    }

    if (firebaseOk){
      onAuthStateChanged(auth, async (user)=>{
        me = user || null;
        $btnProfile.style.display = me ? 'inline-block' : 'none';
        document.getElementById('btnAchievementList')?.remove();
        document.getElementById('login').style.display  = me ? 'none' : 'inline-block';
        document.getElementById('logout').style.display = me ? 'inline-block' : 'none';
        $who.textContent = me ? (me.displayName || 'ë¡œê·¸ì¸ë¨') : 'ë¡œê·¸ì¸ ì•ˆ ë¨';

        // â”€â”€ ê¸°ì¡´ êµ¬ë… ì •ë¦¬ ë° ê¸°ë³¸ê°’ ì´ˆê¸°í™”
        try { if (unsubAdminDoc) { unsubAdminDoc(); unsubAdminDoc = null; } } catch {}
        isAdmin = false;
        applyAdminUI();

        // meê°€ ìˆìœ¼ë©´ ê´€ë¦¬ì ë¬¸ì„œ êµ¬ë… ì‹œì‘
        if (me) {
          try {
           const r = doc(db, 'admins', me.uid);
            unsubAdminDoc = onSnapshot(
              r,
              (s) => {
                const prev = isAdmin;
                const d = s.exists() ? (s.data() || {}) : null;
                // enabled ê°€ falseê°€ ì•„ë‹ˆë©´ ê´€ë¦¬ì
                isAdmin = !!(d && (d.enabled !== false));
                if (isAdmin !== prev) applyAdminUI();
                ensureProfileOnLogin();
                  refreshTopName();
              },
             (err) => {
                console.warn('[admins] subscribe failed', err);
               isAdmin = false;
               applyAdminUI();
                refreshTopName();
             }
           );
          } catch (e) {
            console.warn('[admins] subscribe init error', e);
            isAdmin = false;
            applyAdminUI();
            refreshTopName();
          }
        } else {
          // ë¡œê·¸ì•„ì›ƒ ì‹œ ì´ˆê¸°í™”
          isAdmin = false;
         applyAdminUI();
          refreshTopName();
        }
        
        if (!guardNoticeAutoOpen()){
          await highlightNoticeIfUnseen();   // ë²„íŠ¼ì— 'ìƒˆ ê³µì§€' í•˜ì´ë¼ì´íŠ¸
          await tryOpenLatestNotice();       // ì‹¤ì œ ìë™ ì˜¤í”ˆ
        }
        
 
      }); // â† ì—¬ê¸°ì„œ ëë‚˜ì•¼ í•¨ (ì¶”ê°€ } ì œê±°)

    }
    async function recordDailyLogin(){
      if (!firebaseOk || !me) return;
      const today = new Date().toISOString().split('T')[0];
      const mRef = doc(db,'profiles', me.uid, 'missions', 'daily');
      const snap = await getDoc(mRef);
      const data = snap.exists() ? snap.data() : {};
      
      if (data.lastLoginDate !== today){
        await setDoc(mRef, {
          loginToday: true,
          lastLoginDate: today
        }, {merge:true});
      }
      
      // ì£¼ê°„ ë¡œê·¸ì¸ ê¸°ë¡
      const weekNum = getWeekNumber(new Date());
      const wRef = doc(db,'profiles', me.uid, 'missions', 'weekly');
      const wSnap = await getDoc(wRef);
      const wData = wSnap.exists() ? wSnap.data() : {};
      
      if (wData.currentWeek !== weekNum){
        await setDoc(wRef, {
          currentWeek: weekNum,
          loginDaysThisWeek: 1,
          loginDates: [today]
        }, {merge:true});
      } else {
        const dates = wData.loginDates || [];
        if (!dates.includes(today)){
          await updateDoc(wRef, {
            loginDaysThisWeek: increment(1),
            loginDates: arrayUnion(today)
          });
        }
      }
    }

    function getWeekNumber(d){
      const onejan = new Date(d.getFullYear(),0,1);
      return Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    }

    async function refreshTopName(){
      if (!firebaseOk || !me){
       $who.textContent = 'ë¡œê·¸ì¸ ì•ˆ ë¨';
        return;
      }
      try{
        const pf = await getDoc(doc(db,'profiles', me.uid));
        const d = pf.exists()? (pf.data()||{}) : null;
        const nick = d?.nick || (me.displayName||'ìµëª…');
        const rankCode = isAdmin ? 'ê´€ë¦¬ì' : (d?.rankCode || 'Z');
        const trust = (d?.trust !== undefined) ? d.trust : 10;
        $who.textContent = nameWithRank(nick, rankCode, trust, isAdmin);
      }catch{
        $who.textContent = me.displayName || 'ë¡œê·¸ì¸ë¨';
      }
    }


    /* ---------------- ì•„ì´ì½˜ ìºì‹œ ---------------- */
    const iconCache = new Map();
    function iconFor(catKey){
     const url = iconUrlForCat(catKey);
      if (iconCache.has(url)) return iconCache.get(url);
      const ic = L.icon({
        iconUrl: url,
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        className: 'pin-icon'
      });
      iconCache.set(url, ic);
      return ic;
    }

     function iconUrlForCat(catKey){
      const o = categoryIconOverride.get(catKey);
      if (o) {
        const u = String(o).trim();
        // ì™„ì „í•œ URLì´ë‚˜ data URLì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if (/^(https?:)?\/\//.test(u) || u.startsWith('data:')) return u;
        // ë„ë©”ì¸ ë£¨íŠ¸ ê¸°ì¤€ ì ˆëŒ€ê²½ë¡œë„ í—ˆìš©
        if (u.startsWith('/')) return u;
        // íŒŒì¼ëª…ë§Œ ì˜¨ ê²½ìš°ì—” /icons í”„ë¦¬í”½ìŠ¤ ë¶™ì—¬ì„œ ë¡œì»¬ ìì›ìœ¼ë¡œ ì²˜ë¦¬
        if (!u.startsWith('icons/')) return 'icons/' + u;
        return u;
      }
      return defaultIconFor(catKey);
    }

    /* ---------------- ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ & í† ê¸€ + ì§„í–‰ë„ ---------------- */
    const catGroups = new Map();
    const catVisible = new Map(CATEGORIES.map(c => [c.key, true]));
    const catConfirmed = new Map(); // âœ… ì¹´í…Œê³ ë¦¬ë³„ í™•ì¸ëœ í•€ ì¶”ì 
    
    const savedCatVis = LS.load('catVisible', null);
    if (savedCatVis && typeof savedCatVis==='object'){
      for (const [k,v] of Object.entries(savedCatVis)){ catVisible.set(k, !!v); }
    }
    
    function ensureCatGroup(key){
      if (!catGroups.has(key)) {
        catGroups.set(key, L.layerGroup().addTo(map));
      }
      return catGroups.get(key);
    }
    
    function setCategoryVisible(key, visible){
      catVisible.set(key, visible);
      LS.save('catVisible', Object.fromEntries(catVisible));
      const g = ensureCatGroup(key);
      if (visible) { if (!map.hasLayer(g)) g.addTo(map); }
      else { if (map.hasLayer(g)) map.removeLayer(g); }
      const btn = document.querySelector(`.flt[data-cat="${CSS.escape(key)}"]`);
      if (btn){ 
        btn.classList.toggle('on', visible);
        updateCategoryProgress(key);
      }
      applyAllVisibility();
      recomputeSeqs();
    }
    
    function updateCategoryProgress(catKey){
      const btn = document.querySelector(`.flt[data-cat="${CSS.escape(catKey)}"]`);
      if (!btn) return;

      // ìŠ¹ì¸ëœ í•€ë§Œ ì´ê³„
      const total = [...markerMap.values()]
        .filter(r=>r.data.category===catKey && r.data.status==='approved').length;

      const confirmed = confirmedCountForCat(catKey);
      const percent = total > 0 ? Math.round((confirmed/total)*100) : 0;

      let progressEl = btn.querySelector('.progress');
      if (!progressEl){
        progressEl = document.createElement('div');
        progressEl.className = 'progress';
        btn.appendChild(progressEl);
      }
      progressEl.textContent = `${percent}%`;

      // ì¹´í…Œê³ ë¦¬ê°€ "ì¼œì ¸ ìˆì„ ë•Œë§Œ" ë³´ì´ê²Œ (CSSì™€ í•¨ê»˜ ë™ì‘)
      progressEl.style.display = btn.classList.contains('on') ? 'block' : 'none';
    }
    
    function setAllCats(v){ CATEGORIES.forEach(c=> setCategoryVisible(c.key, v)); }
    function setOnlyPokemonCats(){
      setAllCats(false);
      POKEMON_CATS.forEach(k=> setCategoryVisible(k, true));
    }
    function setWildVisible(v){
      wildVisible = v;
      LS.save('wildVisible', v);
      if (v){ if (!map.hasLayer(wildLayer)) wildLayer.addTo(map); }
      else { if (map.hasLayer(wildLayer)) map.removeLayer(wildLayer); }
      document.getElementById('fltWild').classList.toggle('on', v);
    }

    // ì¢Œì¸¡ í•„í„° UI
    const side = document.getElementById('side');
    const sideCats = document.getElementById('sideCats');
    const sideReports = document.getElementById('sideReports');
    const repCommentList = document.getElementById('repCommentList');
    const fltList = document.getElementById('fltList');
    const repSortBar = document.getElementById('repSortBar');
    const repFiltBar = document.getElementById('repFiltBar');
    const warningUserList = document.getElementById('warningUserList');
    let repSortMode = 'mix';
    let repFilterMode = 'all';

    repSortBar.onclick = (e)=>{
      const b=e.target.closest('[data-sort]'); if(!b) return;
      repSortMode = b.getAttribute('data-sort');
      [...repSortBar.children].forEach(x=> x.classList.toggle('on', x===b));
      renderReportedComments();
    };
    repFiltBar.onclick = (e)=>{
      const b=e.target.closest('[data-filt]'); if(!b) return;
      repFilterMode = b.getAttribute('data-filt');
      [...repFiltBar.children].forEach(x=> x.classList.toggle('on', x===b));
      renderReportedComments();
    };

    function buildFilters(){
      fltList.innerHTML = CATEGORIES.map(c=>`<button class="flt ${catVisible.get(c.key)!==false?'on':''}" data-cat="${c.key}">${c.label}<div class="progress">0%</div></button>`).join('');
      fltList.onclick = (e)=>{
        const b = e.target.closest('.flt[data-cat]');
        if (!b) return;
        const key = b.getAttribute('data-cat');
        const next = !catVisible.get(key);
        setCategoryVisible(key, next);
        // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë ˆì´ì–´ë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ ì „ì²´ í† ê¸€ì´ ì¦‰ì‹œ ì „ ë²”ìœ„ì— ì ìš©ë˜ë„ë¡ í•¨
          CATEGORIES.forEach(c => ensureCatGroup(c.key));
      };
      document.getElementById('fltWild').onclick = ()=> setWildVisible(!wildVisible);
      document.getElementById('fltAll').onclick  = ()=> setAllCats(true);
      document.getElementById('fltNone').onclick = ()=> setAllCats(false);

      $btnPendingOnly.onclick = ()=>{
        if (!isAdmin) return;
        showPendingOnly = !showPendingOnly;
        LS.save('showPendingOnly', showPendingOnly);
        $btnPendingOnly.classList.toggle('on', showPendingOnly);
        applyAllVisibility(); recomputeSeqs();
      };

      $btnAdminReport.onclick = ()=>{
        if (!isAdmin) return;
        setAdminReportMode(!adminReportMode);
      };
    }
    buildFilters();

    function setAdminReportMode(v){
      adminReportMode = !!v;
      side.style.display = 'block';
      sideCats.style.display = adminReportMode ? 'none' : 'block';
      sideReports.style.display = adminReportMode ? 'block' : 'none';
      document.getElementById('btnAdminReport').classList.toggle('on', adminReportMode);
      applyAllVisibility();
      recomputeSeqs();
      if (adminReportMode) updateWarningUsers();
    }

    // âœ… ìš”ì£¼ì˜ ìœ ì € í‘œì‹œ
    async function updateWarningUsers(){
      if (!firebaseOk || !isAdmin) return;
      const profiles = await getDocs(collection(db,'profiles'));
      const warning = [];
      
      for (const p of profiles.docs){
        const data = p.data();
        const uid = p.id;
        
        // ì‹ ê³  ë°˜ë ¤ 10íšŒ ì´ìƒ
        const rejectCount = data.reportsRejected || 0;
        if (rejectCount >= 10){
          warning.push({uid, nick:data.nick||'ìµëª…', reason:`ì‹ ê³  ë°˜ë ¤ ${rejectCount}íšŒ`});
        }
        
        // ì‹ ê³  ìŠ¹ì¸/ì‚­ì œëœ í•€/ëŒ“ê¸€ 10ê°œ ì´ìƒ
        const badContent = (data.pinsDeleted||0) + (data.commentsDeleted||0);
        if (badContent >= 10){
          warning.push({uid, nick:data.nick||'ìµëª…', reason:`ì‚­ì œëœ ì½˜í…ì¸  ${badContent}ê°œ`});
        }
      }
      
      if (warning.length === 0){
        warningUserList.innerHTML = '<div style="opacity:.7">ì—†ìŒ</div>';
      } else {
        warningUserList.innerHTML = warning.map(w=>`
          <div style="background:#2a2a2a; padding:6px; margin:4px 0; border-radius:6px">
            ${esc(w.nick)} (${w.uid.slice(0,8)}â€¦)<br>
            <span style="opacity:.8">${esc(w.reason)}</span>
          </div>
        `).join('');
      }
    }

    /* ---------------- í†µí•© ê²€ìƒ‰ ---------------- */
    const qInput   = document.getElementById('qInput');
    const qSearch  = document.getElementById('qSearch');
    const qClear   = document.getElementById('qClear');
    const qTrendEl = document.getElementById('qTrending');

    let textFilter = LS.load('textFilter','');
    if (textFilter){ qInput.value = textFilter; }
    function applyTextFilter(q){
      textFilter = norm(q||'');
      LS.save('textFilter', textFilter);
      applyAllVisibility();
      recomputeSeqs();
    }
    qSearch.onclick = ()=> { const q = qInput.value.trim(); applyTextFilter(q); if (q) logQuery(q).catch(()=>{}); };
    qInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ qSearch.click(); }});
    qClear.onclick = ()=>{ qInput.value=''; applyTextFilter(''); };

    function dateKey(d=new Date()){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    async function logQuery(q){
      if (!firebaseOk) return;
      const normed = fieldKey(q);
      const refD = doc(db,'searchDaily', dateKey());
      await setDoc(refD, {
        updatedAt: serverTimestamp(),
        [`counts.${normed}`]: increment(1),
        [`labels.${normed}`]: q
      }, { merge:true });
    }
    function lastNDaysKeys(n){
      const arr=[]; const now=new Date();
      for(let i=0;i<n;i++){ const d=new Date(now.getTime()-i*24*3600*1000); arr.push(dateKey(d)); }
      return arr;
    }
    async function refreshTrending(){
      if (!firebaseOk) { qTrendEl.innerHTML=''; return; }
      const keys = lastNDaysKeys(7);
      const counts = new Map(); const labels = new Map();
      for (const k of keys){
        const s = await getDoc(doc(db,'searchDaily', k));
        if (!s.exists()) continue;
        const data = s.data();
        const cs = data?.counts || {}; const ls = data?.labels || {};
        for (const [normKey, c] of Object.entries(cs)){
          counts.set(normKey, (counts.get(normKey)||0) + (c||0));
          if (ls[normKey]) labels.set(normKey, ls[normKey]);
        }
      }
      const tops = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n])=> labels.get(n) || n);
      qTrendEl.innerHTML = tops.map(t=>`<button class="flt" data-sug="${esc(t)}">${esc(t)}</button>`).join('');
    }
    qTrendEl.onclick = (e)=>{
      const b=e.target.closest('[data-sug]'); if(!b) return;
      const q=b.getAttribute('data-sug'); qInput.value = q; qSearch.click();
    };
    refreshTrending(); setInterval(refreshTrending, 3600*1000);

    /* ---------------- ì‹ ê³ : ì •ì±…/í”„ë¡ì‹œ ---------------- */
    let reportedComments = [];
    let unsubRepComments = null;

    const msToHuman = (ms)=>{
      if (!ms || ms<=0) return 'í•´ì œë¨';
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      return h>0 ? `${h}ì‹œê°„ ${m}ë¶„ ë‚¨ìŒ` : `${m}ë¶„ ë‚¨ìŒ`;
    };

    const statusTextOf=(rc)=>{
      if (rc.hidden) return `ê°€ë¦¼ ì ìš©ì¤‘ Â· ${msToHuman(rc.remainMs||0)}`;
      const age = nowMs() - (rc.firstReportAt||nowMs());
      const h = Math.floor(age/3600000), m = Math.floor((age%3600000)/60000);
      if (rc.eligible) return `ê°€ë¦¼ ì¡°ê±´ ì¶©ì¡±(ì ìš© ëŒ€ê¸°) Â· ê²½ê³¼ ${h}ì‹œê°„ ${m}ë¶„ Â· ëˆ„ì  ${rc.count}`;
      return `ê°€ë¦¼ ì¡°ê±´ ë¯¸ì¶©ì¡± Â· ëˆ„ì  ${rc.count||0}/${HIDE_COUNT} Â· ê²½ê³¼ ${h}ì‹œê°„ ${m}ë¶„`;
    };

    function sortReported(a,b){
      if (b.count!==a.count) return b.count - a.count;
      if (b.remainMs!==a.remainMs) return b.remainMs - a.remainMs;
      if ((a.hidden?1:0)!==(b.hidden?1:0)) return (b.hidden?1:0)-(a.hidden?1:0);
      return (a.firstReportAt||0) - (b.firstReportAt||0);
    }



    async function ensureCommentHidePolicy(markerId, commentId){
      try{
        const cs = await getDoc(doc(db,'markers', markerId, 'comments', commentId));
        if (!cs.exists()) return { hidden:false, count:0, first:null, eligible:false };
        const c = cs.data()||{};
        const count = c.reportPendingCount||0;
        const first = toMs(c.firstReportAt)||null;
        const eligible = (count>=HIDE_COUNT) || (!!first && (nowMs()-first)>=HIDE_DELAY_MS);
        if (eligible){
          const until = new Date(Date.now()+HIDE_MS);
          await updateDoc(cs.ref, { hiddenUntil: until });
          return { hidden:true, count, first, eligible };
        }else{
          await updateDoc(cs.ref, { hiddenUntil: null });
          return { hidden:false, count, first, eligible };
        }
      }catch(e){
        console.warn('[ensureCommentHidePolicy] error', e);
        return { hidden:false, error:e };
      }
    }

    async function ensureMarkerHidePolicy(markerId){
      try{
        const ms = await getDoc(doc(db,'markers', markerId));
        if (!ms.exists()) return { hidden:false, count:0, first:null, eligible:false };
        const m = ms.data()||{};
        const count = m.reportPendingCount||0;
        const first = toMs(m.firstReportAt)||null;
        const eligible = (count>=HIDE_COUNT) || (!!first && (nowMs()-first)>=HIDE_DELAY_MS);
        if (eligible){
          const until = new Date(Date.now()+HIDE_MS);
          await updateDoc(ms.ref, { hiddenUntil: until });
          const rec = markerMap.get(markerId);
          if (rec){ rec.data.hiddenUntil = until; applyVisibility(markerId); }
          return { hidden:true, count, first, eligible };
        }else{
          await updateDoc(ms.ref, { hiddenUntil: null });
          const rec = markerMap.get(markerId);
          if (rec){ rec.data.hiddenUntil = null; applyVisibility(markerId); }
          return { hidden:false, count, first, eligible };
        }
      }catch(e){
        console.warn('[ensureMarkerHidePolicy] error', e);
        return { hidden:false, error:e };
      }
    }

    async function subscribeReportedCommentsAdmin(){
      if (unsubRepComments){unsubRepComments();unsubRepComments=null;}
      if (!firebaseOk || !isAdmin){
        reportedComments = [];
        renderReportedComments();
        return;
      }
      const stops = [];

      stops.push(onSnapshot(query(collectionGroup(db,'comments'), where('reportPendingCount','>',0)),
        (snap)=> ingestCommentGroupSnap(snap),
        (err)=> console.warn('[rep-list count]', err)
      ));
      stops.push(onSnapshot(query(collectionGroup(db,'comments'), where('hiddenUntil','>', new Date())),
        (snap)=> ingestCommentGroupSnap(snap),
        (err)=> console.warn('[rep-list hidden]', err)
      ));
      stops.push(onSnapshot(query(collectionGroup(db,'reports'), where('status','==','pending')),
        async (snap)=>{
          const tasks = [];
          snap.forEach(d=>{
            const parentCommentRef = d.ref.parent.parent;
            if (!parentCommentRef) return;
            tasks.push(getDoc(parentCommentRef));
          });
          const parents = await Promise.all(tasks);
          const fakeSnap = { forEach: (fn)=> parents.forEach(ps=> { if(ps && ps.exists()) fn(ps); }) };
          ingestCommentGroupSnap(fakeSnap);
        },
        (err)=> console.warn('[rep-list reports]', err)
      ));
      stops.push(onSnapshot(collection(db,'adminReports'), snap=>{
        const now = nowMs();
        const idx = new Map(reportedComments.map(x=> [`${x.markerId}|${x.commentId}`, x]));
        snap.forEach(d=>{
          const docData = d.data()||{};
          const markerId = docData.markerId;
          const commentId = docData.commentId || null;
          const body = docData.body || '';
          const first = toMs(docData.createdAt) || now;
          const key = `${markerId}|${commentId}`;
          const merged = {
            markerId, commentId,
            body,
            firstReportAt:first,
            remainMs: 0,
            hidden: false,
            count: docData.reportPendingCount || 1,
            eligible: false,
            adminProxyId: d.id
          };
          idx.set(key, merged);
        });
        reportedComments = [...idx.values()].sort(sortReported);
        renderReportedComments();
      }, err=> console.warn('[adminReports]', err)));

      unsubRepComments = ()=> stops.forEach(s=> s());
    }

    function ingestCommentGroupSnap(snap){
      const now = nowMs();
      const idx = new Map(reportedComments.map(x=> [`${x.markerId}|${x.commentId}`, x]));
      snap.forEach(d=>{
        const p = d.ref.path.split('/');
        if (!(p[0]==='markers' && p[2]==='comments')) return;
        const markerId = p[1], commentId = p[3];
        const c = d.data()||{};
        const first = toMs(c.firstReportAt)||now;
        const hidden = toMs(c.hiddenUntil) > now;
        const remainMs = hidden ? (toMs(c.hiddenUntil)-now) : 0;
        const count = c.reportPendingCount||0;
        const eligible = (count>=HIDE_COUNT) || (!!first && (now-first)>=HIDE_DELAY_MS);

        const key = `${markerId}|${commentId}`;
        const prev = idx.get(key)||{};
        const merged = {
          markerId, commentId,
          body: c.body || prev.body || '(ë³¸ë¬¸ ì—†ìŒ)',
          firstReportAt:first, remainMs, hidden, count, eligible
        };
        idx.set(key, merged);
      });
      reportedComments = [...idx.values()].sort(sortReported);
      renderReportedComments();
    }

    function renderReportedComments(){
      const repCommentList = document.getElementById('repCommentList');
      if (!adminReportMode){ repCommentList.innerHTML=''; return; }
      if (!reportedComments.length){
        repCommentList.innerHTML = `<div style="opacity:.7">ì‹ ê³  ì ‘ìˆ˜ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      let list = Array.isArray(reportedComments) ? [...reportedComments] : [];
      if (repFilterMode==='eligible')   list = list.filter(x=> x.eligible);
      if (repFilterMode==='ineligible') list = list.filter(x=> !x.eligible);
      list.sort(sortReported);

      repCommentList.innerHTML = list.map(rc=>{
        const midSafe = rc && rc.markerId ? String(rc.markerId).slice(0,6) : '??????';
        const cidSafe = rc && rc.commentId ? rc.commentId : '';
        const bodySafe = rc && rc.body ? rc.body : '(ë³¸ë¬¸ ì—†ìŒ)';
        return `
          <div class="ritem" data-mid="${esc(rc?.markerId||'')}" data-cid="${esc(cidSafe)}" data-adminproxy="${esc(rc?.adminProxyId||'')}">
            <div style="font-weight:600">#${midSafe}â€¦ Â· ëŒ“ê¸€</div>
            <div style="white-space:pre-wrap;margin-top:6px">${esc(bodySafe)}</div>
            <div class="meta">${esc(statusTextOf(rc||{}))}</div>
            <div class="act">
              <button class="rbtn" data-jump>í•´ë‹¹ í•€ ë³´ê¸°</button>
              <button class="rbtn" data-dismiss>ì‹ ê³  ë°˜ë ¤</button>
              <button class="rbtn warn" data-delete>ì›ë¬¸ ì‚­ì œ</button>
            </div>
          </div>
        `;
      }).join('');

      repCommentList.onclick = async (e)=>{
        const card = e.target.closest('.ritem'); if (!card) return;
        const markerId = card.getAttribute('data-mid');
        const commentId= card.getAttribute('data-cid') || null;
        const proxyId  = card.getAttribute('data-adminproxy') || null;

        if (e.target.matches('[data-jump]')){
          const rec = markerMap.get(markerId);
          if (rec){
            openInfoWithSeq(rec.data);
            setTimeout(()=>{
              if (commentId){
                const el = document.getElementById('c-'+commentId);
                if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
              }
            }, 400);
          } else alert('í•´ë‹¹ í•€ì„ ì§€ë„ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (e.target.matches('[data-dismiss]')){
          try{
            // âœ… ì‹ ê³ ìì—ê²Œ ì‹ ë¢°ë„ +15
            const reports = await getDocs(query(collection(db,'markers', markerId, 'comments', commentId, 'reports'), where('status','==','pending')));
            for (const r of reports.docs){
              const reporterUid = r.data().uid;
              if (reporterUid) await addTrust(reporterUid, 15, 'ì‹ ê³  ë°˜ë ¤');
            }
            
            if (proxyId){
              await deleteDoc(doc(db,'adminReports', proxyId));
            } else {
              try{
                const q = query(collection(db,'adminReports'), where('markerId','==', markerId), where('commentId','==', commentId));
                const s = await getDocs(q);
                await Promise.all(s.docs.map(d=> deleteDoc(d.ref)));
              }catch(e){ console.warn('reject pending reports failed', e); }
            }
            try{
              const q = query(collection(db,'markers', markerId, 'comments', commentId, 'reports'), where('status','==','pending'));
              const s = await getDocs(q);
              await Promise.all(s.docs.map(d=> updateDoc(d.ref, { status:'rejected', reviewedAt: serverTimestamp() })));
            }catch(e){ console.warn('reject pending reports failed', e); }
            await updateDoc(doc(db,'markers', markerId, 'comments', commentId), {
              hiddenUntil: null,
              reportPendingCount: 0,
              reportsBlocked: true
            });
            try{ await updateDoc(doc(db,'markers', markerId), { reportPendingCount: 0 }); }catch(_e){}
            
            // âœ… ì‘ì„±ì ì‹ ë¢°ë„ ì¦ê°€ ì—†ìŒ (ë°˜ë ¤ ì‹œ ì‹ ë¢°ë„ ë³€í™” ì—†ìŒ)
            alert('ì‹ ê³  ë°˜ë ¤ ì™„ë£Œ â€” ì›ë³¸ ëŒ“ê¸€ì˜ ì‹ ê³  ì¹´ìš´íŠ¸/ë±ƒì§€ë¥¼ ì œê±°í•˜ê³  ì¶”ê°€ ì‹ ê³ ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.');
          }catch(err){
            alert('ë°˜ë ¤ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (err?.message||err));
          }
        }

        if (e.target.matches('[data-delete]')){
          if (!confirm('ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì›ë³¸ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          try{
            const cSnap = await getDoc(doc(db,'markers', markerId, 'comments', commentId));
            const authorUid = cSnap.data()?.uid;
            
            // âœ… ì‹ ê³  ìŠ¹ì¸: ì‹ ê³ ìì—ê²Œ 110 XP, ì‘ì„±ì ì‹ ë¢°ë„ -10
            const reports = await getDocs(query(collection(db,'markers', markerId, 'comments', commentId, 'reports'), where('status','==','pending')));
            for (const r of reports.docs){
              const reporterUid = r.data().uid;
              if (reporterUid){
                const pfRef = doc(db,'profiles', reporterUid);
                await setDoc(pfRef, { 
                  xp: increment(REPORT_APPROVED_XP),
                reportsApproved: increment(1)
                }, { merge:true });
                await checkAchievements(reporterUid);
              }
            }
            
            if (authorUid){
              await addTrust(authorUid, -10, 'ëŒ“ê¸€ ì‚­ì œë¨ (ì‹ ê³  ìŠ¹ì¸)');
              await safeMergeDoc(['profiles', authorUid], { commentsDeleted: increment(1) });
            }
            
            await updateDoc(doc(db,'markers', markerId, 'comments', commentId), { deleted:true });
            if (proxyId) await deleteDoc(doc(db,'adminReports', proxyId));
            else {
              try{
                const q = query(collection(db,'adminReports'), where('markerId','==', markerId), where('commentId','==', commentId));
                const s = await getDocs(q);
                await Promise.all(s.docs.map(d=> deleteDoc(d.ref)));
              }catch(_e){}
            }
            alert('ì›ë³¸ ëŒ“ê¸€ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
          }catch(err){ alert('ì‚­ì œ ì‹¤íŒ¨: ' + (err?.message||err)); }
        }
      };
    }

    /* ---------------- ë§ˆì»¤ êµ¬ë…/ë Œë” + ì¡°íšŒìˆ˜ ---------------- */
    const markerMap=new Map();
    let unsubMain=null, unsubPending=null;

    async function incrementViewCount(markerId){
      if (!firebaseOk) return;
      try{
        await updateDoc(doc(db,'markers', markerId), {
          viewCount: increment(1)
        });
      }catch(e){
        console.warn('[viewCount] increment failed', e);
      }
    }

    function subscribeMarkers(){
      if (!firebaseOk) return;
      if (unsubMain){unsubMain();} if (unsubPending){unsubPending();}
      markerMap.forEach(({group, marker})=> group.removeLayer(marker));
      markerMap.clear();

      const qApproved=query(collection(db,'markers'), where('status','==','approved'));
      unsubMain=onSnapshot(qApproved, s=>{
        s.docChanges().forEach(renderChange);
        recomputeSeqs();
        updateAllCategoryProgress();
        tryOpenDeepLink();
      });

      if (isAdmin){
        const qPending=query(collection(db,'markers'), where('status','==','pending'));
        unsubPending=onSnapshot(qPending, s=>{
          s.docChanges().forEach(renderChange);
          recomputeSeqs();
          updateAllCategoryProgress();
          tryOpenDeepLink();
        });
      }
    }

    function updateAllCategoryProgress(){
      CATEGORIES.forEach(c=> updateCategoryProgress(c.key));
    }

    function renderChange(ch){
      const id = ch.doc.id;
      if (ch.type === 'removed'){
        const prev = markerMap.get(id);
        if (prev){ prev.group.removeLayer(prev.marker); markerMap.delete(id); }
        return;
      }
      const m = { id, ...ch.doc.data() };

      // âœ… ì¹´í…Œê³ ë¦¬ ì •ê·œí™”(ë¼ë²¨/í‚¤ í˜¼ìš© ë°©ì§€)
      m.category = resolveCategoryKey(m.category);

      if (Array.isArray(m.pokemon) && !Array.isArray(m.pokemonNorm)) {
        m.pokemonNorm = m.pokemon.map(normName);
      }

      if (markerMap.has(id)){
        const prev = markerMap.get(id);
        prev.group.removeLayer(prev.marker);
        markerMap.delete(id);
      }
      const group = ensureCatGroup(m.category);
      const mk = L.marker([m.y, m.x], { icon: iconFor(m.category) }).addTo(group);
      mk.on('click', ()=>openInfoWithSeq(m));
      markerMap.set(id, { group, marker: mk, data: m, seq: null, confirmed: LS.load(`pin_confirmed_${id}`, false) });
      applyVisibility(id);
    }

    function isHiddenByReport(m){ return toMs(m.hiddenUntil) > nowMs(); }
    
    function applyVisibility(id){
      const rec = markerMap.get(id); if (!rec) return;
      const {group, marker, data:m, confirmed} = rec;

      // âœ… í™•ì¸ëœ í•€ì€ ë°˜íˆ¬ëª… í‘œì‹œ
      if (confirmed){
        marker.setOpacity(0.4);
      } else {
        marker.setOpacity(1);
      }

      if (adminReportMode){
        const ok = isHiddenByReport(m);
        if (ok){ if (!group.hasLayer(marker)) marker.addTo(group); }
        else   { if (group.hasLayer(marker)) group.removeLayer(marker); }
        return;
      }

      const catOn = catVisible.get(m.category) !== false;
      const hiddenForUser = isHiddenByReport(m) && !isAdmin;
      const txtOk = matchText(m);
      const statusOk = isAdmin ? (showPendingOnly ? m.status==='pending' : true) : (m.status==='approved');

      const ok = catOn && !hiddenForUser && txtOk && statusOk;
      if (ok){ if (!group.hasLayer(marker)) marker.addTo(group); }
      else   { if (group.hasLayer(marker)) group.removeLayer(marker); }
    }
    
    function applyAllVisibility(){ markerMap.forEach((_, id)=> applyVisibility(id)); }

    setInterval(()=> { applyAllVisibility(); recomputeSeqs(); }, 60*1000);

    async function _touchFirstAtIfEmpty(refPath){
      const r = doc(db, ...refPath);
      const s = await getDoc(r);
      if (!s.exists()) return null;
      const d = s.data()||{};
      if (!d.firstReportAt) await updateDoc(r, { firstReportAt: serverTimestamp() });
      return r;
    }

    async function submitCommentReport(markerId, commentId, reason){
      const cref = doc(db,'markers', markerId, 'comments', commentId);
      const cs = await getDoc(cref);
      if (!cs.exists()){ alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
      const cd = cs.data()||{};
      if (cd.reportsBlocked){ alert('ê´€ë¦¬ìì— ì˜í•´ ì´ ëŒ“ê¸€ì€ ì‹ ê³ ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }

      // âœ… ì‹ ê³  ì ‘ìˆ˜ ì‹œ ì‹ ë¢°ë„ -10
      if (me?.uid) await addTrust(me.uid, -10, 'ëŒ“ê¸€ ì‹ ê³  ì ‘ìˆ˜');

      await addDoc(collection(db,'markers', markerId, 'comments', commentId, 'reports'), {
        type:'comment', markerId, commentId, uid: me?.uid||null, reason,
        status:'pending', createdAt: serverTimestamp()
      });

      await _touchFirstAtIfEmpty(['markers', markerId, 'comments', commentId]);
      await updateDoc(cref, { reportPendingCount: increment(1) });

      try{
        const body = cd.body || '(ë³¸ë¬¸ ì—†ìŒ)';
        await addDoc(collection(db,'adminReports'), {
          proxyType: 'comment',
          markerId, commentId,
          body,
          reporterUid: me?.uid || null,
          createdAt: serverTimestamp(),
          reportPendingCount: 1
        });
      }catch(_e){
        console.warn('[admin proxy create] failed', _e);
      }

      const res = await ensureCommentHidePolicy(markerId, commentId);
      if (res.hidden) alert('ì‹ ê³  ëˆ„ì /ê²½ê³¼ì‹œê°„ìœ¼ë¡œ ëŒ“ê¸€ì´ ì„ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      else alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì¡°ê±´ ì¶©ì¡± ì‹œ ìë™ìœ¼ë¡œ ê°€ë ¤ì§‘ë‹ˆë‹¤.');
    }

    async function reportMarker(m, reason){
      if (!firebaseOk) return { ok:false, hid:false };
      const mref = doc(db,'markers', m.id);
      const ms = await getDoc(mref);
      const md = ms.data()||{};
      if (md.reportsBlocked){ alert('ê´€ë¦¬ìì— ì˜í•´ ì´ í•€ì€ ì‹ ê³ ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'); return {ok:false, hid:false}; }

      // âœ… ì‹ ê³  ì ‘ìˆ˜ ì‹œ ì‹ ë¢°ë„ -10
      if (me?.uid) await addTrust(me.uid, -10, 'í•€ ì‹ ê³  ì ‘ìˆ˜');

      try{
        await addDoc(collection(db,'markers', m.id, 'reports'), {
          type:'marker', markerId: m.id, uid: me?.uid||null, reason,
          status:'pending', createdAt: serverTimestamp()
        });
      }catch(_e){}

      await _touchFirstAtIfEmpty(['markers', m.id]);
      await updateDoc(mref, { reportPendingCount: increment(1) });

      try{
        await addDoc(collection(db,'adminReports'), {
          proxyType: 'marker',
          markerId: m.id,
          commentId: null,
          body: m.title || '(í•€ ì‹ ê³ )',
          reporterUid: me?.uid || null,
          createdAt: serverTimestamp(),
          reportPendingCount: 1
        });
      }catch(_e){ console.warn('[admin proxy create] failed', _e); }

      const res = await ensureMarkerHidePolicy(m.id);
      if (res.hidden) alert('ì‹ ê³  ëˆ„ì /ê²½ê³¼ì‹œê°„ìœ¼ë¡œ í•€ì´ ì„ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      else alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì¡°ê±´ ì¶©ì¡± ì‹œ ìë™ìœ¼ë¡œ ê°€ë ¤ì§‘ë‹ˆë‹¤.');
      return { ok:true, hid:!!res.hidden };
    }

    /* ---------- ë™ì  ì‹œí€€ìŠ¤ ---------- */
    function visibleForSeq(m){
      if (!m) return false;
      if (adminReportMode) return isHiddenByReport(m);
      if (isHiddenByReport(m) && !isAdmin) return false;
      if (catVisible.get(m.category) === false) return false;
      if (!matchText(m)) return false;
      const statusOk = isAdmin ? (showPendingOnly ? m.status==='pending' : true) : (m.status==='approved');
      return !!statusOk;
    }

    function recomputeSeqs(){
      const items = [];
      markerMap.forEach(({data}, id)=>{
        if (visibleForSeq(data)){
          const created = toMs(data.createdAt) ?? 0;
          items.push({ id, created });
        }
      });
      items.sort((a,b)=> ((a.created || a._localCreatedAt || 0) - (b.created || b._localCreatedAt || 0)));
      const seqById = new Map();
      for (let i=0;i<items.length;i++) seqById.set(items[i].id, i+1);

      markerMap.forEach((rec, id)=>{ rec.seq = seqById.get(id) ?? null; });
      if (currentOpenId && markerMap.has(currentOpenId)){
        const rec = markerMap.get(currentOpenId);
        document.getElementById('infoId').textContent = rec.seq ? '#'+rec.seq : '#-';
      }
    }

    /* ---------------- ë°˜ì‘ ì‹œìŠ¤í…œ ---------------- */
    const reactionMenu = document.getElementById('reactionMenu');
    let currentReactionTarget = null;

    function showReactionMenu(x, y, type, targetId, parentId){
      currentReactionTarget = {type, targetId, parentId};
      reactionMenu.style.left = x + 'px';
      reactionMenu.style.top = y + 'px';
      reactionMenu.style.display = 'block';
    }
    globalThis.showReactionMenu = showReactionMenu;


    function hideReactionMenu(){
      reactionMenu.style.display = 'none';
      currentReactionTarget = null;
    }

    document.addEventListener('click', (e)=>{
      if (!reactionMenu.contains(e.target)) hideReactionMenu();
    });

    reactionMenu.onclick = async (e)=>{
      const btn = e.target.closest('[data-emoji]');
      if (!btn || !currentReactionTarget) return;
      const emoji = btn.getAttribute('data-emoji');
      const {type, targetId, parentId} = currentReactionTarget;
      
      if (!me){
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        hideReactionMenu();
        return;
      }

      try{
        if (type === 'pin'){
          const rRef = doc(db,'markers', targetId, 'reactions', me.uid);
          await setDoc(rRef, { emoji, uid: me.uid, createdAt: serverTimestamp() });
          
          // ë°˜ì‘ ë°›ì€ ì‚¬ëŒ í†µê³„ ì—…ë°ì´íŠ¸
          const pinSnap = await getDoc(doc(db,'markers', targetId));
          const authorUid = pinSnap.data()?.authorUid;
          if (authorUid){
            await safeMergeDoc(['profiles', authorUid], { reactionsReceived: increment(1) });
          }
        } else if (type === 'comment'){
          const rRef = doc(db,'markers', parentId, 'comments', targetId, 'reactions', me.uid);
          await setDoc(rRef, { emoji, uid: me.uid, createdAt: serverTimestamp() });
          
          // ë°˜ì‘ ë°›ì€ ì‚¬ëŒ í†µê³„ ì—…ë°ì´íŠ¸
          const cmtSnap = await getDoc(doc(db,'markers', parentId, 'comments', targetId));
          const authorUid = cmtSnap.data()?.uid;
          if (authorUid){
            await safeMergeDoc(['profiles', authorUid], { reactionsReceived: increment(1) });
          }
        }
        
        // ë°˜ì‘ ì¤€ ì‚¬ëŒ í†µê³„ ì—…ë°ì´íŠ¸
        await updateDoc(doc(db,'profiles', me.uid), {
          reactionsGiven: increment(1)
        });
        
        // ì¼ì¼ ë¯¸ì…˜ ì²´í¬
        const mRef = doc(db,'profiles', me.uid, 'missions', 'daily');
        await setDoc(mRef, {
          reactionsToday: increment(1)
        }, {merge:true});
        
        // ì£¼ê°„ ë¯¸ì…˜ ì²´í¬
        const weekNum = getWeekNumber(new Date());
        const wRef = doc(db,'profiles', me.uid, 'missions', 'weekly');
        await setDoc(wRef, {
          currentWeek: weekNum,
          reactionsThisWeek: increment(1)
        }, {merge:true});
        
        await checkAchievements(me.uid);
        hideReactionMenu();
        
        // í™”ë©´ ìƒˆë¡œê³ ì¹¨
        if (currentOpenId) openInfoWithSeq(markerMap.get(currentOpenId).data);
      }catch(err){
        alert('ë°˜ì‘ ì¶”ê°€ ì‹¤íŒ¨: ' + (err?.message||err));
        hideReactionMenu();
      }
    };

    async function loadReactions(type, targetId, parentId){
      if (!firebaseOk) return {};
      try{
        let rCol;
        if (type === 'pin'){
          rCol = collection(db,'markers', targetId, 'reactions');
        } else {
          rCol = collection(db,'markers', parentId, 'comments', targetId, 'reactions');
        }
        const snap = await getDocs(rCol);
        const counts = {};
        snap.forEach(d=>{
          const emoji = d.data().emoji;
          counts[emoji] = (counts[emoji]||0) + 1;
        });
        return counts;
      }catch{
        return {};
      }
    }

    function renderReactions(counts){
      if (!counts || Object.keys(counts).length === 0) return '';
      return Object.entries(counts).map(([emoji, count])=>`<span>${emoji} ${count}</span>`).join('');
    }
    
    // === ì¹´í…Œê³ ë¦¬ë³„ ì—ë””í„° í‘œì‹œ/ì´ˆê¸°í™” ===
    const $tmEditor = document.getElementById('tmEditor');
    const $megaEditor = document.getElementById('megaEditor');
    const $missionEditor = document.getElementById('missionEditor');
    const $itemEditor = document.getElementById('itemEditor');
    const $pkEditor = document.getElementById('pkEditor');

    const $pkAddInput = document.getElementById('pkAddInput');
    const $pkAddBtn = document.getElementById('pkAddBtn');
    const $pkAddClear = document.getElementById('pkAddClear');
    const $pkChips = document.getElementById('pkChips');

    let pkSet = [];

    function renderPkChips(){
      $pkChips.innerHTML = pkSet.map((name, i) =>
        `<span class="tag" data-i="${i}" title="ì œê±°">${esc(name)}</span>`).join('');
      // ì¹© í´ë¦­ìœ¼ë¡œ ì œê±°
      $pkChips.querySelectorAll('.tag').forEach(tag=>{
        tag.onclick = () => {
          const i = +tag.getAttribute('data-i');
          pkSet.splice(i,1);
          renderPkChips();
        };
      });
    }

    function clearPkTags(){
      pkSet = [];
      renderPkChips();
      $pkAddInput.value = '';
    }

    $pkAddBtn.onclick = () => {
      const v = ($pkAddInput.value||'').trim();
      if(!v) return;
      if(!pkSet.includes(v)) pkSet.push(v);
      $pkAddInput.value = '';
      renderPkChips();
    };
    $pkAddClear.onclick = () => { clearPkTags(); };

    // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— ë§ì¶° ì—ë””í„° show/hide ë° ë¶ˆí•„ìš” ì…ë ¥ ì´ˆê¸°í™”
    function updateEditorsForCategory(catKey){
      const showTM = (catKey === TM_CAT);
      const showMega = (catKey === MEGA_STONE_CAT);
      const showMission = MISSION_CATS.includes(catKey);
      const showItem = ITEM_CATS.includes(catKey);
      const showPk = POKEMON_CATS.includes(catKey);

      $tmEditor.style.display = showTM ? 'block' : 'none';
      if(!showTM){ document.getElementById('tmNumber').value=''; document.getElementById('tmName').value=''; }

      $megaEditor.style.display = showMega ? 'block' : 'none';
      if(!showMega){ document.getElementById('megaPokemon').value=''; }

      $missionEditor.style.display = showMission ? 'block' : 'none';
      if(!showMission){ document.getElementById('missionNumber').value=''; }

      $itemEditor.style.display = showItem ? 'block' : 'none';
      if(!showItem){ document.getElementById('itemName').value=''; }

      $pkEditor.style.display = showPk ? 'block' : 'none';
      if(!showPk){ clearPkTags(); }
    }

    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì—ë””í„° ìƒíƒœ ê°±ì‹ 
    catSel.addEventListener('change', () => updateEditorsForCategory(catSel.value));
    // ì´ˆê¸° 1íšŒ ì ìš©
    updateEditorsForCategory(catSel.value);
  
    /* PATCH START: Suggest/Inquiry debounce & auto-close (2025-10-28) */
    const suggestModal = document.getElementById('suggestModal');
    const sgEditSave   = document.getElementById('sgEditSave');
    let __sgLock = false;

    if (sgEditSave){
      sgEditSave.addEventListener('click', async ()=>{
        if (__sgLock) return;
        const last = +LS.load('sg_last_ts', 0);
        if (Date.now() - last < 4000){ alert('ì—°ì† ë“±ë¡ì€ 4ì´ˆ í›„ì— ê°€ëŠ¥í•´ìš”.'); return; }

        const titleEl = document.getElementById('sgEditTitle');
        const bodyEl  = document.getElementById('sgEditBody');
        const title = (titleEl?.value||'').trim();
        const body  = (bodyEl?.value||'').trim();
        if (!title || !body){ alert('ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!firebaseOk){ alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.'); return; }

        __sgLock = true; sgEditSave.disabled = true; sgEditSave.textContent = 'ë“±ë¡ì¤‘â€¦';
        try{
          await addDoc(collection(db,'suggestions'), {
            title, body, uid: me?.uid||null, createdAt: serverTimestamp()
          });
          LS.save('sg_last_ts', Date.now());
          if (titleEl) titleEl.value = '';
          if (bodyEl)  bodyEl.value  = '';
          if (suggestModal) suggestModal.style.display = 'none';  // âœ… ìë™ ë‹«ê¸°
          alert('ê±´ì˜/ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          alert('ë“±ë¡ ì‹¤íŒ¨: ' + (e?.message||e));
        }finally{
          __sgLock = false; sgEditSave.disabled = false; sgEditSave.textContent = 'ë“±ë¡';
        }
      });
    }
    /* PATCH END */
  
    /* ---------------- ìƒì„¸ íŒ¨ë„ + ìºëŸ¬ì…€ + ëŒ“ê¸€ ---------------- */
    const $info=document.getElementById('info');
    const $infoTitle=document.getElementById('infoTitle');
    const $infoId=document.getElementById('infoId');
    const $infoMeta=document.getElementById('infoMeta');
    const $infoBody=document.getElementById('infoBody');
    const $infoMediaTop=document.getElementById('infoMediaTop');
    const $infoBtns=document.getElementById('infoBtns');
    const $infoPk=document.getElementById('infoPk');
    const $copyLinkBtn=document.getElementById('copyLinkBtn');
    const $btnConfirm=document.getElementById('btnConfirm');
    const $pinViewCount=document.getElementById('pinViewCount');
    const $pinReactions=document.getElementById('pinReactions');

    const $carousel=document.getElementById('infoCarousel');
    const $carInner=document.getElementById('carInner');
    const $carPrev=document.getElementById('carPrev');
    const $carNext=document.getElementById('carNext');
    const $carDots=document.getElementById('carDots');
    let carIdx = 0, carItems = [];
    
    function buildCarousel(media){
      const rest = (media||[]).slice(1);
      if (!rest.length){ $carousel.style.display='none'; return; }
      $carousel.style.display='block';
      carItems = rest; carIdx = 0;
      $carInner.innerHTML = rest.map(m=>`
        <div class="item">
      ${ m.type==='video'
        ? `<video controls src="${m.url}" preload="metadata"></video>`
        : `<img src="${m.url}" loading="lazy" referrerpolicy="no-referrer" alt="">`
      }
         </div>`).join('');
      $carDots.innerHTML = rest.map((_,i)=>`<div class="dot ${i===0?'on':''}" data-i="${i}"></div>`).join('');
      updateCarousel();
      $carPrev.setAttribute('aria-controls','carInner');
      $carNext.setAttribute('aria-controls','carInner');
      $carInner.setAttribute('aria-live','polite');

    }
    
    function updateCarousel(){
      const w = $carousel.clientWidth || 1;
      $carInner.style.transform = `translateX(${-carIdx * w}px)`;
      [...$carDots.children].forEach((d,i)=> d.classList.toggle('on', i===carIdx));
    }
    
    window.addEventListener('resize', updateCarousel);
    $carPrev.onclick = ()=>{ if (carItems.length){ carIdx = (carIdx - 1 + carItems.length) % carItems.length; updateCarousel(); } };
    $carNext.onclick = ()=>{ if (carItems.length){ carIdx = (carIdx + 1) % carItems.length; updateCarousel(); } };
    $carDots.onclick = (e)=>{ const d = e.target.closest('.dot'); if (!d) return; carIdx = +d.getAttribute('data-i') || 0; updateCarousel(); };

    // âœ… í™•ì¸ ë²„íŠ¼
    $btnConfirm.onclick = ()=>{
      if (!currentOpenId) return;
      const rec = markerMap.get(currentOpenId); if (!rec) return;

      rec.confirmed = !rec.confirmed;
      LS.save(`pin_confirmed_${currentOpenId}`, rec.confirmed);

      // ì§„í–‰ë„ ê°±ì‹ 
      updateCategoryProgress(rec.data.category);

      // ì—…ì /í†µê³„ ìœ ì§€
      if (rec.confirmed && me){
        updateDoc(doc(db,'profiles', me.uid), {
          pinsConfirmed: increment(1)
        }).then(()=> checkAchievements(me.uid));
      }

      applyVisibility(currentOpenId);
      $btnConfirm.textContent = rec.confirmed ? 'âœ“ í™•ì¸ë¨' : 'âœ“ í™•ì¸';
      
      // ì¹´í…Œê³ ë¦¬ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
      const cat = rec.data.category;
      if (!catConfirmed.has(cat)) catConfirmed.set(cat, 0);
      catConfirmed.set(cat, catConfirmed.get(cat) + (rec.confirmed ? 1 : -1));
      updateCategoryProgress(cat);
      
      // ì—…ì  ì²´í¬
      if (rec.confirmed && me){
        updateDoc(doc(db,'profiles', me.uid), {
          pinsConfirmed: increment(1)
        }).then(()=> checkAchievements(me.uid));
      }
      
      applyVisibility(currentOpenId);
      $btnConfirm.textContent = rec.confirmed ? 'âœ“ í™•ì¸ë¨' : 'âœ“ í™•ì¸';
    };

    // ëŒ“ê¸€
    const $cForm = document.getElementById('cForm');
    const $cBody = document.getElementById('cBody');
    const $cSubmit = document.getElementById('cSubmit');
    const $cList = document.getElementById('cList');
    let unsubComments = null;

    async function getDisplayForUid(uid){
      if (!firebaseOk || !uid) return {nick:'ìµëª…', rankCode:'Z', trust:10, isAdmin:false};
      const [pf, ad] = await Promise.all([
        getDoc(doc(db,'profiles', uid)).catch(()=>null),
        getDoc(doc(db,'admins', uid)).catch(()=>null)
      ]);
      const isAdm = ad && ad.exists();
      const nick = (pf && pf.exists() && (pf.data()?.nick)) || 'ìµëª…';
      const rank = isAdm ? 'ê´€ë¦¬ì' : ((pf && pf.exists() && (pf.data()?.rankCode)) || 'Z');
      const trust = (pf && pf.exists() && (pf.data()?.trust !== undefined)) ? pf.data().trust : 10;
      return { nick, rankCode:rank, trust, isAdmin:isAdm };
    }

    /* PATCH START: other profile modal (2025-10-28) */
    async function openOtherProfile(uid){
      if (!firebaseOk || !uid){ alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      try{
        const pfSnap = await getDoc(doc(db,'profiles', uid));
        const d = pfSnap.exists() ? (pfSnap.data()||{}) : {};
        document.getElementById('opNick').textContent  = d.nick || '(ìµëª…)';
        document.getElementById('opRank').textContent  = d.rankCode || 'Z';
        document.getElementById('opTrust').textContent = (d.trust ?? 10);
        document.getElementById('opXp').textContent    = (d.xp ?? 0);
        document.getElementById('opViews').textContent = (d.totalViews ?? 0);

        const list = document.getElementById('opAchievementList');
        const ids = d.achievementsUnlocked || [];
        if (!ids.length){
          list.innerHTML = '<div style="opacity:.7">í‘œì‹œí•  ì—…ì  ì—†ìŒ</div>';
        } else {
          list.innerHTML = ids.map(id=>{
            const meta = ACHIEVEMENTS.find(a=>a.id===id);
            if (!meta) return `<span class="achievement-badge">${esc(id)}</span>`;
            return `<span class="achievement-badge ${meta.tier}">${esc(meta.name)}</span>`;
          }).join('');
      }

        const modal = document.getElementById('otherProfileModal');
        modal.style.display = 'flex';
        document.getElementById('opClose').onclick = ()=> (modal.style.display = 'none');
      }catch(e){
        alert('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨: ' + (e?.message||e));
      }
    }
    /* PATCH END */
  
    function fmtDisplay(nick, rankCode, trust, adm){
      const trustClass = trust < 0 ? 'trust-negative' : 'trust-positive';
      return `${nick} â€¢ ${adm ? 'ê´€ë¦¬ì' : rankCode} â€¢ ì‹ ë¢°ë„: <span class="${trustClass}">${trust}</span>`;
    }

    
  
    function openComments(marker){
      if (!firebaseOk) { $cForm.style.display='none'; $cList.innerHTML=''; return; }
      if (unsubComments){unsubComments();unsubComments=null; }
      $cForm.style.display = me ? 'block':'none';
      $cBody.value='';
      const qC = query(collection(db,'markers', marker.id, 'comments'), orderBy('createdAt','asc'));
      unsubComments = onSnapshot(qC, async snap=>{
        const now = nowMs();
        const raw = [];
        snap.forEach(d=>{
          const c = { id:d.id, ...d.data() };
          const hidden = c.hiddenUntil ? (toMs(c.hiddenUntil) > now) : false;
          if (c.deleted) return;
          if (!isAdmin && hidden) return;
          raw.push({ ...c, _hidden:hidden });
        });

        const items = await Promise.all(raw.map(async c=>{
          let cnt = c.reportPendingCount || 0;
          try{
            if (!cnt){
              const q = query(collection(db,'markers', marker.id, 'comments', c.id, 'reports'), where('status','==','pending'));
              const s = await getDocs(q); cnt = s.size || 0;
            }
          }catch(_e){}
          const disp = await getDisplayForUid(c.uid);
          const reactions = await loadReactions('comment', c.id, marker.id);
          return { ...c, _repCnt: cnt, _disp: disp, _reactions: reactions };
        }));

        $cList.innerHTML = items.map(c => `
          <div class="citem ${c._hidden?'inactive':''}" id="c-${c.id}" oncontextmenu="event.preventDefault(); showReactionMenu(event.pageX, event.pageY, 'comment', '${c.id}', '${marker.id}'); return false;">
            <div class="meta">
              <span class="clickable" data-uid="${c.uid}">${fmtDisplay(c._disp.nick, c._disp.rankCode, c._disp.trust, c._disp.isAdmin)}</span> Â· ${new Date(toMs(c.createdAt||Date.now())).toLocaleString()}
              ${c._repCnt>0 ? `<span class="badge-report">ì‹ ê³  ${c._repCnt}</span>`:''}
              ${c._hidden ? `<span class="badge-hidden">ê°€ë¦¼ì¤‘</span>`:''}
            </div>
            <div class="body" style="white-space:pre-wrap; margin-top:6px">${esc(c.body||'')}</div>
            <div class="reactions">${renderReactions(c._reactions)}</div>
            <div class="act">
              <button class="btn" data-crep="${c.id}">ì‹ ê³ </button>
              ${(isAdmin || me?.uid===c.uid) ? `<button class="btn warn" data-cdel="${c.id}">ì‚­ì œ</button>`:''}
            </div>
          </div>`).join('');

        // ìœ ì € í”„ë¡œí•„ í´ë¦­ ì´ë²¤íŠ¸
        $cList.querySelectorAll('[data-uid]').forEach(el=>{
          el.onclick = ()=> openOtherProfile(el.getAttribute('data-uid'));
        });

        $cList.querySelectorAll('[data-crep]').forEach(btn=>{
          btn.onclick = async ()=>{
            if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
            const cid = btn.getAttribute('data-crep');
            const reason = prompt('ëŒ“ê¸€ ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); if (!reason) return;
            await submitCommentReport(marker.id, cid, reason);
          };
        });
        $cList.querySelectorAll('[data-cdel]').forEach(btn=>{
          btn.onclick = async ()=>{
            const cid = btn.getAttribute('data-cdel');
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            await updateDoc(doc(db,'markers', marker.id, 'comments', cid), { deleted:true });
          };
        });
      });

      $cSubmit.onclick = async ()=>{
        if (!me) { alert('ë¡œê·¸ì¸ í›„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.'); return; }
        const body = ($cBody.value||'').trim();
        if (!body) return;
        const myProfSnap = await getDoc(doc(db,'profiles', me.uid)).catch(()=>null);
        const nick = (myProfSnap && myProfSnap.exists() && myProfSnap.data().nick) || (me.displayName||'ìµëª…');
        await addDoc(collection(db,'markers', marker.id, 'comments'), {
          body, uid: me.uid, displayName: nick,
          createdAt: serverTimestamp(), deleted:false,
          reportPendingCount: 0, reportsBlocked: false
        });
        $cBody.value='';
        
        // âœ… ì‹ ë¢°ë„ +5
        await addTrust(me.uid, 5, 'ëŒ“ê¸€ ì‘ì„±');
        
        // âœ… í†µê³„ ì—…ë°ì´íŠ¸
        await safeMergeDoc(['profiles', me.uid], { commentsCreated: increment(1) });

        
        // âœ… ì¼ì¼ ë¯¸ì…˜ ì²´í¬
        const today = new Date().toISOString().split('T')[0];
        const mRef = doc(db,'profiles', me.uid, 'missions', 'daily');
        await setDoc(mRef, {
          commentsToday: increment(1),
          lastCommentDate: today
        }, {merge:true});
        
        await awardXP('comment');
        await checkAchievements(me.uid);
      };
    }

    function mediaTopEl(m){
      if (!m.media?.length) return '';
      const first=m.media[0];
      return (first.type==='video')
        ? `<video class="thumb" controls src="${first.url}" preload="metadata"></video>`
        : `<img class="thumb" src="${first.url}" loading="lazy" referrerpolicy="no-referrer" alt="thumb">`;
    }

    async function fetchMarkerPendingCount(markerId){
      try{
        const ms = await getDoc(doc(db,'markers', markerId));
        let cnt = (ms.exists() ? (ms.data().reportPendingCount||0) : 0);
        if (!cnt){
          const q = query(collection(db,'markers', markerId, 'reports'), where('status','==','pending'));
          const s = await getDocs(q); cnt = s.size||0;
        }
        return cnt;
      }catch(_e){ return 0; }
    }

    function openInfoWithSeq(m){
      const rec = markerMap.get(m.id);
      const seqNum = rec?.seq ?? null;
      openInfo(m, seqNum);
    }

    async function openInfo(m, seqNum){
      currentOpenId=m.id;
      
      // âœ… ì¡°íšŒìˆ˜ ì¦ê°€
      await incrementViewCount(m.id);
      
      // âœ… ì‘ì„±ìì˜ ì´ ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸
      if (m.authorUid){
        await safeMergeDoc(['profiles', m.authorUid], { totalViews: increment(1) });
      }
      
      $infoTitle.textContent=m.title||'(ì œëª© ì—†ìŒ)';
      $infoId.textContent = seqNum ? '#'+seqNum : '#-';
      const statusText = m.status || 'pending';

      const pinRepCnt = await fetchMarkerPendingCount(m.id);
      
      // âœ… ì¡°íšŒìˆ˜ í‘œì‹œ
      const viewCount = m.viewCount || 0;
      $pinViewCount.textContent = `ì¡°íšŒ ${viewCount}`;

      // ì‘ì„±ì ë‹‰/ë­í¬/ì‹ ë¢°ë„ í‘œì‹œ
      let authorDisp = 'ìµëª…';
      try{
        if (m.authorUid){
          const disp = await getDisplayForUid(m.authorUid);
          authorDisp = `<span class="clickable" data-uid="${m.authorUid}">${fmtDisplay(disp.nick, disp.rankCode, disp.trust, disp.isAdmin)}</span>`;
        } else {
          authorDisp = m.displayName || 'ìµëª…';
        }
      }catch{ authorDisp = m.displayName || 'ìµëª…'; }

      $infoMeta.innerHTML = `
        <span>${labelFor(m.category)} Â· by ${authorDisp} Â· ${statusText}</span>
        ${pinRepCnt>0 ? `<span class="badge">ì‹ ê³  ${pinRepCnt}</span>`:''}
      `;
      
      // ìœ ì € í”„ë¡œí•„ í´ë¦­ ì´ë²¤íŠ¸
      const authorLink = $infoMeta.querySelector('[data-uid]');
      if (authorLink){
        authorLink.onclick = ()=> openOtherProfile(authorLink.getAttribute('data-uid'));
      }

      $infoMediaTop.innerHTML = mediaTopEl(m);
      $infoBody.textContent = m.body||'';
      
      // âœ… í•€ ë°˜ì‘ í‘œì‹œ
      const pinReactions = await loadReactions('pin', m.id, null);
      $pinReactions.innerHTML = renderReactions(pinReactions);
      
      // ìš°í´ë¦­ìœ¼ë¡œ ë°˜ì‘ ì¶”ê°€
      $infoBody.oncontextmenu = (e)=>{
        e.preventDefault();
        showReactionMenu(e.pageX, e.pageY, 'pin', m.id, null);
        return false;
      };

      if (POKEMON_CATS.includes(m.category) && Array.isArray(m.pokemon) && m.pokemon.length){
        $infoPk.style.display='flex';
        $infoPk.innerHTML = m.pokemon.map(n=>`<span class="tag" data-pk="${esc(n)}">${esc(n)}</span>`).join('');
        $infoPk.onclick = (e)=>{
          const t = e.target.closest('.tag[data-pk]'); if(!t) return;
          const name = t.getAttribute('data-pk');
          document.getElementById('qInput').value = name;
          setOnlyPokemonCats();
          applyTextFilter(name);
          alert(`"${name}" ì¶œí˜„ ë³´ê³  í•€ë§Œ í‘œì‹œí•©ë‹ˆë‹¤. (ì™€ì¼ë“œ/ìš°ë‘ë¨¸ë¦¬/ë©”ê°€)`);
        };
      } else { $infoPk.style.display='none'; $infoPk.innerHTML=''; }

      buildCarousel(m.media || []);

      const isMine = me && me.uid===m.authorUid;
      const canEdit = isMine && (m.status==='pending'||m.status===undefined);
      const hiddenNow = isHiddenByReport(m);
      
      // âœ… í™•ì¸ ë²„íŠ¼ ìƒíƒœ
      const rec = markerMap.get(m.id);
      if (rec){
        $btnConfirm.textContent = rec.confirmed ? 'âœ“ í™•ì¸ë¨' : 'âœ“ í™•ì¸';
      }

      $infoBtns.innerHTML = `
        <button id="btnReport" class="primary">í•€ ì‹ ê³ </button>
        ${canEdit ? `<button id="btnEdit">ìˆ˜ì •</button><button id="btnDel" class="warn">ì‚­ì œ</button>`:''}
        ${isAdmin ? `
            ${m.status==='pending'
              ? `<button id="btnAppr" class="primary">ìŠ¹ì¸</button><button id="btnReject" class="warn">ë°˜ë ¤</button>`
              : ``}
            <button id="btnAdminDel" class="warn">ê´€ë¦¬ì ì‚­ì œ</button>
            <button id="btnReportDismiss" class="">ì‹ ê³  ë°˜ë ¤/ì°¨ë‹¨</button>
            ${hiddenNow ? `<button id="btnUnhideNow">ìˆ¨ê¹€ í•´ì œ</button>`:''}
          ` : ``}
      `;

      const btnR=document.getElementById('btnReport');
      if (btnR) btnR.onclick = async ()=>{
        if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
        const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); if(!reason) return;
        try{
          const res = await reportMarker(m, reason);
          if (res.ok && !res.hid){ /* ì•ˆë‚´ëŠ” reportMarkerì—ì„œ */ }
          $info.style.display='none'; currentOpenId=null;
        }catch(err){ alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + (err?.message||err)); }
      };

      const btnE=document.getElementById('btnEdit');
      if (btnE) btnE.onclick=async()=>{
        if (!firebaseOk) return;
        const nt=prompt('ì œëª© ìˆ˜ì •', m.title||''); if (nt===null) return;
        const nb=prompt('ë‚´ìš© ìˆ˜ì •', m.body||''); if (nb===null) return;
        await updateDoc(doc(db,'markers', m.id), { title:nt, body:nb });
      };

      const btnD=document.getElementById('btnDel');
      if (btnD) btnD.onclick=async()=>{
        if (!firebaseOk) return;
        if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
        await deleteDoc(doc(db,'markers', m.id));
        $info.style.display='none'; currentOpenId=null;
      };

      const btnAdminDel=document.getElementById('btnAdminDel');
      if (btnAdminDel) btnAdminDel.onclick = async ()=>{
        if (!firebaseOk) return;
        if (!confirm('ì´ í•€ì„ ì™„ì „íˆ ì‚­ì œí• ê¹Œìš”?')) return;
        
        // âœ… ì‘ì„±ì í†µê³„ ì—…ë°ì´íŠ¸
        if (m.authorUid){
          await safeMergeDoc(['profiles', m.authorUid], { pinsDeleted: increment(1) });
        }
        
        await deleteDoc(doc(db,'markers', m.id));
        $info.style.display='none'; currentOpenId=null;
      };

      const btnA=document.getElementById('btnAppr');
      if (btnA) btnA.onclick=async()=>{
        if (!firebaseOk) return;
        btnA.disabled=true; btnA.textContent='ìŠ¹ì¸ì¤‘...';
        try{ await updateDoc(doc(db,'markers', m.id), { status:'approved' }); }
        finally{ btnA.disabled=false; btnA.textContent='ìŠ¹ì¸'; }
      };

      const btnRe=document.getElementById('btnReject');
      if (btnRe) btnRe.onclick=async()=>{
        if (!firebaseOk) return;
        btnRe.disabled=true; btnRe.textContent='ë°˜ë ¤ì¤‘...';
        try{ await updateDoc(doc(db,'markers', m.id), { status:'rejected' }); }
        finally{ btnRe.disabled=false; btnRe.textContent='ë°˜ë ¤'; }
      };

      const btnReportDismiss = document.getElementById('btnReportDismiss');
      if (btnReportDismiss) btnReportDismiss.onclick = async ()=>{
        try{
          // âœ… ì‹ ê³ ìì—ê²Œ ì‹ ë¢°ë„ +15
          const reports = await getDocs(query(collection(db,'markers', m.id, 'reports'), where('status','==','pending')));
          for (const r of reports.docs){
            const reporterUid = r.data().uid;
            if (reporterUid) await addTrust(reporterUid, 15, 'ì‹ ê³  ë°˜ë ¤');
          }
          
          try{
            const q = query(collection(db,'markers', m.id, 'reports'), where('status','==','pending'));
            const s = await getDocs(q);
            await Promise.all(s.docs.map(d=> updateDoc(d.ref, { status:'rejected', reviewedAt: serverTimestamp() })));
          }catch(e){ console.warn('reject pending reports failed', e); }
          await updateDoc(doc(db,'markers', m.id), { hiddenUntil: null, reportPendingCount: 0, reportsBlocked: true });
          try{
            const q2 = query(collection(db,'adminReports'), where('markerId','==', m.id));
            const s2 = await getDocs(q2);
            await Promise.all(s2.docs.map(d=> deleteDoc(d.ref)));
          }catch(e){ console.warn('reject pending reports failed', e); }
          const rec = markerMap.get(m.id);
          if (rec){ rec.data.hiddenUntil = null; rec.data.reportPendingCount=0; rec.data.reportsBlocked=true; applyVisibility(m.id); }
          alert('í•€ ì‹ ê³ ë¥¼ ë°˜ë ¤í•˜ê³ , ì¶”ê°€ ì‹ ê³ ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + (e?.message||e));
        }
      };

      const btnUnhideNow = document.getElementById('btnUnhideNow');
      if (btnUnhideNow) btnUnhideNow.onclick = async ()=>{
        try{
          await updateDoc(doc(db,'markers', m.id), { hiddenUntil: null });
          const rec = markerMap.get(m.id);
          if (rec){ rec.data.hiddenUntil = null; applyVisibility(m.id); }
          alert('ìˆ¨ê¹€ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          alert('í•´ì œ ì‹¤íŒ¨: ' + (e?.message||e));
        }
      };

      $copyLinkBtn.onclick = async ()=>{
        const url = new URL(location.href);
        url.searchParams.set('mid', m.id);
        try{
          await navigator.clipboard.writeText(url.toString());
          alert('ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
        }catch{
          prompt('ë³µì‚¬í•  ë§í¬ì…ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:', url.toString());
        }
      };

      $info.style.display='block';
      openComments(m);
    }

    const $infoClose=document.getElementById('infoClose');
    // ë‹‰ë„¤ì„(ì‘ì„±ì í‘œì‹œ í¬í•¨) í´ë¦­ ì‹œ í•´ë‹¹ ìœ ì € í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸° â€” ì´ë²¤íŠ¸ ìœ„ì„
    document.addEventListener('click', (e)=>{
      const t = e.target.closest('[data-uid]');
      if (t) {
        const uid = t.getAttribute('data-uid');
        if (uid) openOtherProfile(uid);
     }
    });
        let currentOpenId=null;
    $infoClose.onclick=()=>{ $info.style.display='none'; currentOpenId=null; if (unsubComments){unsubComments();unsubComments=null;} };

    /* ë”¥ë§í¬ */
    let deepLinkTried = false;
    function tryOpenDeepLink(){
      if (deepLinkTried) return;
      const mid = new URL(location.href).searchParams.get('mid');
      if (!mid) { deepLinkTried = true; return; }
      const rec = markerMap.get(mid);
      if (rec){
        deepLinkTried = true;
        openInfoWithSeq(rec.data);
        map.panTo([rec.data.y, rec.data.x]);
      }
    }

    /* ---------------- ëª¨ë“œ ì „í™˜ ---------------- */
    let mode = 'search';
    const btnSearch = document.getElementById('btnSearch');
    const btnPlace  = document.getElementById('btnPlace');

    const modalEl = document.getElementById('modal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn   = document.getElementById('saveBtn');
    let pendingPos  = null;
    let _placeHandler = null;
    let _saveWired = false;

    // ëª¨ë‹¬ ì—´ê³ ë‹«ê¸° ì•ˆì „ì¥ì¹˜
    function openCreateModal(){
      if (!modalEl) return;
      document.getElementById('mTitle').value = '';
      document.getElementById('mBody').value  = '';
      // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ë””í´íŠ¸ ì„ íƒ(ì›í•˜ë©´ ë°”ê¿”ë„ ë¨)
      if (document.getElementById('mCat')) {
        document.getElementById('mCat').value = document.getElementById('mCat').value || TM_CAT;
      }
      modalEl.style.display = 'flex';
      }
    function closeCreateModal(){
      if (!modalEl) return;
      modalEl.style.display = 'none';
      pendingPos = null;
    }
    if (cancelBtn) cancelBtn.onclick = closeCreateModal;

    // ì´ˆê¸° ì§„ì… ì‹œ ëª¨ë‹¬ ê°•ì œ ìˆ¨ê¹€ (ì ‘ì† ì‹œ ëœ¨ë˜ ë¬¸ì œ fix)
    if (modalEl) modalEl.style.display = 'none';

    function setMode(m){
      mode = m;
      btnSearch.classList.toggle('on', m === 'search');
      btnPlace.classList.toggle('on',  m === 'place');

      // ì»¤ì„œ í‘œì‹œ
      map.getContainer().style.cursor = (m === 'place') ? 'crosshair' : '';

      // ì´ì „ í•¸ë“¤ëŸ¬ ì œê±°
      if (_placeHandler){ map.off('click', _placeHandler); _placeHandler = null; }

      if (m === 'place'){
        _placeHandler = (e)=>{
          const ll = e.latlng;
          if (!isInside(ll)){ alert('ì§€ë„ë¥¼ ë²—ì–´ë‚œ ìœ„ì¹˜ì…ë‹ˆë‹¤.'); return; }
          pendingPos = { x: ll.lng, y: ll.lat };
          openCreateModal();
        };
        map.on('click', _placeHandler);
      }
    }

    btnSearch.onclick = ()=> setMode('search');
    btnPlace.onclick  = ()=> setMode('place');

    // ì €ì¥ ë²„íŠ¼(ì¤‘ë³µ ë°©ì§€ + ì¢Œí‘œ í•„ìš”)
    if (saveBtn && !_saveWired){
      _saveWired = true;
      let saving = false;
      saveBtn.addEventListener('click', async ()=>{
        if (saving) return;
        if (!firebaseOk){ alert('ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨/ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.'); return; }
        if (!pendingPos){ alert('ì§€ë„ë¥¼ í´ë¦­í•´ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }

        const title = (document.getElementById('mTitle').value||'').trim();
        const body  = (document.getElementById('mBody').value||'').trim();
        const rawCat= (document.getElementById('mCat').value||'').trim();
        const cat   = resolveCategoryKey(rawCat);

        if (!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

        saving = true; saveBtn.disabled = true; saveBtn.textContent = 'ë“±ë¡ì¤‘â€¦';
        try{
          const data = {
            title, body,
            category: cat,
            x: pendingPos.x, y: pendingPos.y,
            status: 'pending',
            authorUid: me?.uid || null,
            displayName: me?.displayName || 'ìµëª…',
            createdAt: serverTimestamp(),
            media: []
          };
          const r = await addDoc(collection(db,'markers'), data);
          await safeMergeDoc(['profiles', me?.uid], { pinsCreated: increment(1) });
          await awardXP('pin');

          closeCreateModal();
          setMode('search');
          alert('í•€ ë“±ë¡ ì™„ë£Œ! (ê²€ìˆ˜ ëŒ€ê¸°)');

          // ë°©ê¸ˆ ë“±ë¡í•œ í•€ ì •ë³´ íŒ¨ë„ ì—´ê¸°(ë¡œì»¬ë¡œë¼ë„)
          openInfo({ id: r.id, ...data }, null);
        }catch(e){
          alert('ë“±ë¡ ì‹¤íŒ¨: ' + (e?.message||e));
        }finally{
          saving = false; saveBtn.disabled = false; saveBtn.textContent = 'ë“±ë¡';
        }
      });
    }

    // í˜ì´ì§€ ìµœì´ˆ ëª¨ë“œëŠ” ê²€ìƒ‰ëª¨ë“œë¡œ ê³ ì • (ì ‘ì† ì‹œ ëª¨ë‹¬ ëœ¨ë˜ ë¬¸ì œ fix)
    setMode('search');

    /* ---------------- ì…ë ¥/ì €ì¥ ---------------- */
    const modal=document.getElementById('modal');
    const t=document.getElementById('mTitle');
    const b=document.getElementById('mBody');
    const imgsInp=document.getElementById('mImgs');
    const videoInp=document.getElementById('mVideo');
    
    // âœ… ì¶”ê°€ ì…ë ¥ í•„ë“œ
    const tmEditor = document.getElementById('tmEditor');
    const tmNumber = document.getElementById('tmNumber');
    const tmName = document.getElementById('tmName');
    const megaEditor = document.getElementById('megaEditor');
    const megaPokemon = document.getElementById('megaPokemon');
    const missionEditor = document.getElementById('missionEditor');
    const missionNumber = document.getElementById('missionNumber');
    const itemEditor = document.getElementById('itemEditor');
    const itemName = document.getElementById('itemName');

    document.getElementById('cancelBtn').onclick=()=>{ modal.style.display='none'; pending=null; };
    modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; pending=null; } });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex'){ modal.style.display='none'; pending=null; } });

    // í¬ì¼“ëª¬ í¸ì§‘ê¸°
    const pkEditor = document.getElementById('pkEditor');
    const pkAddInput = document.getElementById('pkAddInput');
    const pkAddBtn = document.getElementById('pkAddBtn');
    const pkAddClear = document.getElementById('pkAddClear');
    const pkChips = document.getElementById('pkChips');
    let pkList = [];
    function redrawPkChips(){ pkChips.innerHTML = pkList.map((n,i)=>`<span class="tag" data-i="${i}">${esc(n)} âœ•</span>`).join(''); }
    function addPk(){ const v=(pkAddInput.value||'').trim(); if(!v) return; if(!pkList.some(x=>normName(x)===normName(v))) pkList.push(v); pkAddInput.value=''; redrawPkChips(); }
    pkAddBtn.onclick = addPk;
    pkAddInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addPk(); });
    pkAddClear.onclick = ()=>{ pkList=[]; redrawPkChips(); };

    // (ì¹´í…Œê³ ë¦¬ ì„ íƒ ì´ˆê¸°í™”)
      catSel.value = CATEGORIES[0].key;
      const cat = catSel.value;
      pkEditor.style.display      = POKEMON_CATS.includes(cat) ? 'block' : 'none';
      tmEditor.style.display      = (cat === TM_CAT) ? 'block' : 'none';
      megaEditor.style.display    = (cat === MEGA_STONE_CAT) ? 'block' : 'none';
      missionEditor.style.display = MISSION_CATS.includes(cat) ? 'block' : 'none';
      itemEditor.style.display    = ITEM_CATS.includes(cat) ? 'block' : 'none';

      // ì‘ì„± ëª¨ë‹¬ ì˜¤í”ˆ
      modal.style.display = 'flex';
     

    let pending=null;
    map.on('click', (e)=>{
      if (mode !== 'place') return;

      // ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ëˆ„ë¥¸ í´ë¦­ë§Œ í†µê³¼ (ìë™/ìŠ¤í¬ë¦½íŠ¸/ë¶€ìˆ˜ íš¨ê³¼ ì°¨ë‹¨)
      if (!e?.originalEvent || !e.originalEvent.isTrusted) return;

      if (!me){ alert('ë¡œê·¸ì¸ í›„ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.'); return; }
      if (!isInside(e.latlng)){ alert('ë§µ ë°”ê¹¥ì—ëŠ” ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      pending = e.latlng;
      // ... (ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì½”ë“œ ë™ì¼)
      modal.style.display='flex';
      if (mode!=='place') return;
      if(!me){ alert('ë¡œê·¸ì¸ í›„ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.'); return; }
      if(!isInside(e.latlng)){ alert('ë§µ ë°”ê¹¥ì—ëŠ” ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      t.value=''; b.value=''; imgsInp.value=''; videoInp.value='';
      tmNumber.value=''; tmName.value=''; megaPokemon.value=''; missionNumber.value=''; itemName.value='';
      pkList=[]; redrawPkChips();
      if (!catSel.value) catSel.value=CATEGORIES[0].key;
      
      const cat = catSel.value;
      pkEditor.style.display = POKEMON_CATS.includes(cat) ? 'block' : 'none';
      tmEditor.style.display = cat === TM_CAT ? 'block' : 'none';
      megaEditor.style.display = cat === MEGA_STONE_CAT ? 'block' : 'none';
      missionEditor.style.display = MISSION_CATS.includes(cat) ? 'block' : 'none';
      itemEditor.style.display = ITEM_CATS.includes(cat) ? 'block' : 'none';      
    });

    document.getElementById('saveBtn').onclick = async () => {
      if (!me || !pending) return;
      if (!firebaseOk) { alert('ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ìœ¼ë¡œ ì €ì¥ ë¶ˆê°€'); return; }

      const imgFiles = imgsInp.files ? Array.from(imgsInp.files) : [];
      const vidFile  = (videoInp.files && videoInp.files[0]) ? videoInp.files[0] : null;

      const saveBtn = document.getElementById('saveBtn');
      const setBtn  = (t)=> saveBtn.textContent = t;
      const prevTxt = saveBtn.textContent;
      saveBtn.disabled = true;
      try {
        const pfSnap = await getDoc(doc(db,'profiles', me.uid)).catch(()=>null);
        const displayName = (pfSnap && pfSnap.exists() && pfSnap.data().nick) || (me.displayName || 'ìµëª…');

        const media=[];
        for (let i=0;i<imgFiles.length;i++){
          const url = await globalThis.uploadSmart(imgFiles[i], 'markerMedia', setBtn, `ì´ë¯¸ì§€ ${i+1}/${imgFiles.length}`);
          media.push({type:'image', url});
        }
        if (vidFile){
          const url = await globalThis.uploadSmart(vidFile, 'markerMedia', setBtn, 'ë™ì˜ìƒ');
          media.push({type:'video', url});
        }

        const thumbUrl = media.length ? media[0].url : null;

        setBtn('ì €ì¥ ì¤‘â€¦');
        const inPkCat = POKEMON_CATS.includes(catSel.value);
        const markerData = {
          x: pending.lng, y: pending.lat,
          title: t.value, body: b.value,
          category: catSel.value,
          media, thumbUrl,
          displayName, authorUid: me.uid,
          createdAt: serverTimestamp(),
          status: 'pending',
          hiddenUntil: null,
          reportPendingCount: 0, reportsBlocked: false,
          viewCount: 0,
          _localCreatedAt: Date.now(), // âœ… ë³´ì •ìš©
          ...(inPkCat ? { pokemon: pkList, pokemonNorm: pkList.map(normName) } : {})
        };
        
        // âœ… ì¶”ê°€ í•„ë“œ ì €ì¥
        if (catSel.value === TM_CAT){
          markerData.tmNumber = tmNumber.value;
          markerData.tmName = tmName.value;
        }
        if (catSel.value === MEGA_STONE_CAT){
          markerData.megaPokemon = megaPokemon.value;
        }
        if (MISSION_CATS.includes(catSel.value)){
          markerData.missionNumber = missionNumber.value;
        }
        if (ITEM_CATS.includes(catSel.value)){
          markerData.itemName = itemName.value;
        }
        
        await addDoc(collection(db,'markers'), markerData);
        modal.style.display='none'; pending=null;
        setBtn('ë“±ë¡ ì™„ë£Œ!'); setTimeout(()=>{ saveBtn.disabled=false; setBtn(prevTxt); }, 700);

        // âœ… ì‹ ë¢°ë„ +10
        await addTrust(me.uid, 10, 'í•€ ë“±ë¡');
        
        // âœ… í†µê³„ ì—…ë°ì´íŠ¸
        await updateDoc(doc(db,'profiles', me.uid), {
          pinsCreated: increment(1)
        });
        
        // âœ… ì£¼ê°„ ë¯¸ì…˜ ì²´í¬
        const weekNum = getWeekNumber(new Date());
        const wRef = doc(db,'profiles', me.uid, 'missions', 'weekly');
        await setDoc(wRef, {
          currentWeek: weekNum,
          pinsThisWeek: increment(1)
        }, {merge:true});
        
        await awardXP('pin');
        await checkAchievements(me.uid);
      } catch (err) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + (err?.message||err));
        saveBtn.disabled=false; setBtn(prevTxt);
      }
    };

    /* ---------------- í…ìŠ¤íŠ¸ ë§¤ì¹­ ---------------- */
    function matchText(m){
      if (!textFilter) return true;
      const q = textFilter;
      const base = norm(`${m.title||''} ${m.body||''}`);
      if (base.includes(q)) return true;
      const qn = normName(q);
      if (Array.isArray(m.pokemonNorm) && m.pokemonNorm.some(p => p.includes(qn))) return true;
      return false;
    }

    // ì´ˆê¸° êµ¬ë…
    subscribeMarkers();
    subscribeReportedCommentsAdmin();
    // === íƒ€ ìœ ì € í”„ë¡œí•„ ì—´ê¸° ===
    async function openOtherProfile(uid){
      if (!uid) return;
      if (!firebaseOk){ alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.'); return; }

      try{
        const [pfSnap, adSnap] = await Promise.all([
          getDoc(doc(db,'profiles', uid)).catch(()=>null),
        getDoc(doc(db,'admins', uid)).catch(()=>null)
      ]);

      const d = (pfSnap && pfSnap.exists()) ? (pfSnap.data()||{}) : {};
        const isAdm = !!(adSnap && adSnap.exists());

      const nick  = d.nick || 'ìµëª…';
      const rank  = isAdm ? 'ê´€ë¦¬ì' : (d.rankCode || 'Z');
      const trust = (d.trust !== undefined) ? d.trust : 10;
      const xp    = d.xp || 0;
      const views = d.totalViews || 0;

      document.getElementById('opNick').textContent  = nick;
        document.getElementById('opRank').textContent  = rank;
        document.getElementById('opTrust').textContent = trust;
        document.getElementById('opXp').textContent    = xp;
      document.getElementById('opViews').textContent = views;

      // ì „ì‹œ ì—…ì 
      const wrap = document.getElementById('opAchievementList');
        const displayed = d.achievementsDisplayed || [];
        const unlocked  = new Set(d.achievementsUnlocked || []);
        const byId = new Map(ACHIEVEMENTS.map(a=>[a.id,a]));
        const list = (displayed.length ? displayed : Array.from(unlocked).slice(0,3))
                      .map(id => byId.get(id))
                      .filter(Boolean);
      
        wrap.innerHTML = list.length
          ? list.map(a=>`<span class="achievement-badge ${a.tier}">${a.name}</span>`).join('')
          : '<div style="opacity:.7">ì „ì‹œëœ ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          const modal = document.getElementById('otherProfileModal');
          // ë°©ë¬¸ ì‹œ ë¬´ì¡°ê±´ ë‹«í˜€ ìˆê²Œ ê°•ì œ
            modal.style.display = 'none';
            pending = null;

        modal.style.display = 'flex';
        document.getElementById('opClose').onclick = ()=>{ modal.style.display='none'; };
        modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; }, { once:true });
      }catch(e){
       console.warn('[openOtherProfile] failed', e);
       alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');   
      }
    }

    /* ====== í”„ë¡œí•„ UI ====== */
    const profileModal = document.getElementById('profileModal');
    const pfNick = document.getElementById('pfNick');
    const pfRank = document.getElementById('pfRank');
    const pfTrust = document.getElementById('pfTrust');
    const pfXpFill = document.getElementById('pfXpFill');
    const pfXpText = document.getElementById('pfXpText');
    const pfTotalViews = document.getElementById('pfTotalViews');
    const pfTotalReactions = document.getElementById('pfTotalReactions');
    const pfWho = document.getElementById('pfWho');
    const pfClose = document.getElementById('pfClose');
    const pfSave = document.getElementById('pfSave');
    const pfTrustHistory = document.getElementById('pfTrustHistory');
    const pfManageAchievements = document.getElementById('pfManageAchievements');
    const pfAchievementList = document.getElementById('pfAchievementList');
    
    function openProfile(force=false){
      if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      pfWho.textContent = `êµ¬ê¸€: ${me.displayName||'(ì´ë¦„ ì—†ìŒ)'} Â· ${me.email||''}`;
      profileModal.style.display='flex';
      loadProfile(force);
    }
    
    async function loadProfile(){
      if (!firebaseOk || !me) return;
      const pfRef = doc(db,'profiles', me.uid);
      const s = await getDoc(pfRef);
      const d = s.exists()? (s.data()||{}) : { nick: me.displayName||'ìµëª…', xp:0, rankCode:'Z', trust:10 };
      pfNick.value = d.nick || (me.displayName||'ìµëª…');
      
      // âœ… ê´€ë¦¬ìëŠ” ë­í¬ë¥¼ "ê´€ë¦¬ì"ë¡œ í‘œì‹œ, XPë°” ê½‰ ì°¬ ìƒíƒœ, ë‚¨ì€ ê²½í—˜ì¹˜ X
      if (isAdmin){
        pfRank.textContent = 'ê´€ë¦¬ì';
        pfXpFill.style.width = '100%';
        pfXpText.textContent = 'X';
      } else {
        pfRank.textContent = d.rankCode || 'Z';
        const calc = totalToRank(d.xp||0);
        const percent = calc.next > 0 ? Math.round((calc.cur / (calc.cur + calc.next)) * 100) : 100;
        pfXpFill.style.width = percent + '%';
        pfXpText.textContent = `${calc.cur} / ${calc.cur + calc.next} XP`;
      }
      
      pfTrust.textContent = d.trust !== undefined ? d.trust : 10;
      pfTrust.className = (d.trust||10) < 0 ? 'trust-negative' : '';
      pfTotalViews.textContent = d.totalViews || 0;
      pfTotalReactions.textContent = d.reactionsReceived || 0;
      
      // âœ… ì „ì‹œ ì—…ì  í‘œì‹œ
      const displayed = d.achievementsDisplayed || [];
      const unlocked = d.achievementsUnlocked || [];
      pfAchievementList.innerHTML = displayed.length > 0
        ? displayed.map(achId=>{
            const ach = ACHIEVEMENTS.find(a=>a.id===achId);
            return ach ? `<div class="achievement-badge ${ach.tier}">${ach.name}</div>` : '';
          }).join('')
        : '<div style="opacity:.7">ì „ì‹œëœ ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    
    $btnProfile.onclick = ()=> openProfile();
    pfClose.onclick = ()=> profileModal.style.display='none';
    profileModal.addEventListener('click', (e)=>{ if(e.target===profileModal) profileModal.style.display='none'; });
    
    pfSave.onclick = async ()=>{
      if (!firebaseOk || !me) return;
      const nick = (pfNick.value||'').trim() || (me.displayName||'ìµëª…');
      const pfRef = doc(db,'profiles', me.uid);
      await setDoc(pfRef, { uid: me.uid, nick }, { merge:true });
      profileModal.style.display='none';
      await refreshTopName();
      alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    
    pfTrustHistory.onclick = ()=> openTrustHistory();
    pfManageAchievements.onclick = ()=> openAchievementManagement();

    /* ====== íƒ€ ìœ ì € í”„ë¡œí•„ ëª¨ë‹¬ ====== */
    const otherProfileModal = document.getElementById('otherProfileModal');
    const opNick = document.getElementById('opNick');
    const opRank = document.getElementById('opRank');
    const opTrust = document.getElementById('opTrust');
    const opXp = document.getElementById('opXp');
    const opViews = document.getElementById('opViews');
    const opAchievementList = document.getElementById('opAchievementList');
    const opClose = document.getElementById('opClose');
    
    
    
    opClose.onclick = ()=> otherProfileModal.style.display='none';
    otherProfileModal.addEventListener('click', (e)=>{ if(e.target===otherProfileModal) otherProfileModal.style.display='none'; });

    /* ====== ì‹ ë¢°ë„ ë‚´ì—­ ëª¨ë‹¬ ====== */
    const trustHistoryModal = document.getElementById('trustHistoryModal');
    const trustHistoryList = document.getElementById('trustHistoryList');
    const thClose = document.getElementById('thClose');
    
    async function openTrustHistory(){
      if (!firebaseOk || !me) return;
      const q = query(collection(db,'profiles', me.uid, 'trustHistory'), orderBy('timestamp','desc'), limit(50));
      const snap = await getDocs(q);
      
      if (snap.empty){
        trustHistoryList.innerHTML = '<div style="opacity:.7">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        trustHistoryList.innerHTML = snap.docs.map(d=>{
          const data = d.data();
          const amountClass = data.amount >= 0 ? 'trust-positive' : 'trust-negative';
          return `
            <div style="background:#2a2a2a; padding:8px; margin:6px 0; border-radius:6px">
              <div><span class="${amountClass}">${data.amount >= 0 ? '+' : ''}${data.amount}</span> Â· ${esc(data.reason||'')}</div>
              <div style="font-size:11px; opacity:.7">${new Date(toMs(data.timestamp)).toLocaleString()} Â· ì´ ${data.newTotal}</div>
            </div>
          `;
        }).join('');
      }
      
      trustHistoryModal.style.display='flex';
    }
    
    thClose.onclick = ()=> trustHistoryModal.style.display='none';
    trustHistoryModal.addEventListener('click', (e)=>{ if(e.target===trustHistoryModal) trustHistoryModal.style.display='none'; });

    /* ====== ì—…ì  ê´€ë¦¬ ëª¨ë‹¬ ====== */
    const achievementModal = document.getElementById('achievementModal');
    const achievementList = document.getElementById('achievementList');
    const achClose = document.getElementById('achClose');
    
    async function openAchievementManagement(){
      if (!firebaseOk || !me) return;
      const pfSnap = await getDoc(doc(db,'profiles', me.uid));
      const unlocked = pfSnap.exists() ? (pfSnap.data().achievementsUnlocked || []) : [];
      const displayed = pfSnap.exists() ? (pfSnap.data().achievementsDisplayed || []) : [];
      
      achievementList.innerHTML = ACHIEVEMENTS.map(ach=>{
        const isUnlocked = unlocked.includes(ach.id);
        const isDisplayed = displayed.includes(ach.id);
        const tierLabels = {normal:'ë…¸ë§', rare:'ë ˆì–´', epic:'ì—í”½', legend:'ë ˆì „ë“œ'};
        
        return `
          <div class="achievement-badge ${ach.tier}" style="display:flex; justify-content:space-between; align-items:center; opacity:${isUnlocked?1:0.3}; margin:8px 0">
            <div>
              <strong>${ach.name}</strong> (${tierLabels[ach.tier]})<br>
              <span style="font-size:11px">${ach.desc}</span>
            </div>
            ${isUnlocked ? `
              <button class="tbtn" style="margin:0" data-toggle="${ach.id}">
                ${isDisplayed ? 'ì „ì‹œ í•´ì œ' : 'ì „ì‹œí•˜ê¸°'}
              </button>
            ` : ''}
          </div>
        `;
      }).join('');
      
      achievementList.onclick = async (e)=>{
        const btn = e.target.closest('[data-toggle]');
        if (!btn) return;
        const achId = btn.getAttribute('data-toggle');
        const pfRef = doc(db,'profiles', me.uid);
        const pfSnap = await getDoc(pfRef);
        const currentDisplayed = pfSnap.data().achievementsDisplayed || [];
        
        if (currentDisplayed.includes(achId)){
          await updateDoc(pfRef, {
            achievementsDisplayed: arrayRemove(achId)
          });
        } else {
          if (currentDisplayed.length >= 3){
            alert('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì „ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            return;
          }
          await updateDoc(pfRef, {
            achievementsDisplayed: arrayUnion(achId)
          });
        }
        openAchievementManagement();
      };
      
      achievementModal.style.display='flex';
    }
    
    achClose.onclick = ()=> achievementModal.style.display='none';
    achievementModal.addEventListener('click', (e)=>{ if(e.target===achievementModal) achievementModal.style.display='none'; });

    /* ====== ê´€ë¦¬ì ë©”ì‹ ì € ëª¨ë‹¬ ====== */
    const messengerModal = document.getElementById('messengerModal');
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('msgInput');
    const msgSend = document.getElementById('msgSend');
    const msgClose = document.getElementById('msgClose');
    let unsubChat=null;

    function openMessenger(){
      if (!isAdmin){ alert('ê´€ë¦¬ì§„ ì „ìš©'); return; }
      messengerModal.style.display='flex';
      markSeenNow();
      if (!unsubChat){
        const qy = query(collection(db,'adminChat'), orderBy('createdAt','asc'));
        unsubChat = onSnapshot(qy, async snap=>{
          chatBox.innerHTML = '';
          for (const d of snap.docs){
            const v = d.data()||{};
            if (v.type==='notice'){
              chatBox.insertAdjacentHTML('beforeend', `
                <div class="sys-notice">
                  <h4>ğŸ“¢ ê³µì§€: ${esc(v.title||'(ì œëª© ì—†ìŒ)')}</h4>
                  <p>${esc(v.body||'')}</p>
                </div>
              `);
            } else if (v.type==='suggestion'){
              // âœ… ê±´ì˜ ë° ë¬¸ì˜ ì¹´ë“œ
              chatBox.insertAdjacentHTML('beforeend', `
                <div class="sys-notice" style="background:#1a3a5f; cursor:pointer" data-suggest-id="${v.suggestionId}">
                  <h4>ğŸ’¡ ìƒˆ ê±´ì˜: ${esc(v.title||'(ì œëª© ì—†ìŒ)')}</h4>
                  <p>${esc((v.body||'').slice(0,100))}${(v.body||'').length>100?'...':''}</p>
                </div>
              `);
            } else {
              const mine = v.uid===me?.uid;
              const disp = await getDisplayForUid(v.uid);
              chatBox.insertAdjacentHTML('beforeend', `
                <div class="chat-row ${mine?'me':'other'}">
                  <div>
                    <div class="bubble">${esc(v.body||'')}</div>
                    <div class="chat-meta">${esc(fmtDisplay(disp.nick, disp.rankCode, disp.trust, disp.isAdmin))} Â· ${new Date(toMs(v.createdAt||Date.now())).toLocaleString()}</div>
                  </div>
                </div>
              `);
            }
          }
          
          // ê±´ì˜ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
          chatBox.querySelectorAll('[data-suggest-id]').forEach(card=>{
            card.onclick = (ev)=>{
              ev.preventDefault();
              const y = chatBox.scrollTop;
              openSuggestDetail(card.getAttribute('data-suggest-id'));
              setTimeout(()=> chatBox.scrollTop = y, 0);
            };
          });
          
          chatBox.scrollTop = chatBox.scrollHeight;
        });
      }
    }
    
    function closeMessenger(){ messengerModal.style.display='none'; }
    msgClose.onclick = closeMessenger;
    messengerModal.addEventListener('click', (e)=>{ if(e.target===messengerModal) closeMessenger(); });

    msgSend.onclick = async ()=>{
      const body = (msgInput.value||'').trim();
      if (!body) return;
      await addDoc(collection(db,'adminChat'), { uid: me?.uid||null, body, type:'text', createdAt: serverTimestamp() });
      msgInput.value='';
      markSeenNow();
    };

    $btnMsg.onclick = ()=> openMessenger();

    async function markSeenNow(){
      if (!firebaseOk || !me || !isAdmin) return;
      await setDoc(doc(db,'adminSeen', me.uid), { last: serverTimestamp() }, { merge:true });
      $msgBang.classList.remove('show');
    }
    
    function wireAdminMessenger(){
      // ì¤‘ë³µ ì„ ì–¸ ë°©ì§€: ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      globalThis.wireAdminMessenger ??= function wireAdminMessenger(){
        /* no-op: ê´€ë¦¬ì ë©”ì‹ ì € ë¯¸êµ¬í˜„ ë°©ì§€ */
      };

      if (!firebaseOk || !isAdmin || !me) { $msgBang.classList.remove('show'); return; }
      const unsubs = [];
      Promise.all([
        getDoc(doc(db,'adminSeen', me.uid)).catch(()=>null)
      ]).then(([seen])=>{
        let last = toMs(seen?.data()?.last) || 0;
        unsubs.push(onSnapshot(query(collection(db,'adminChat'), orderBy('createdAt','asc')), snap=>{
          let hasNew=false;
          snap.forEach(d=>{
            const v=d.data()||{};
            const ct = toMs(v.createdAt||0) || 0;
            if (ct>last && v.uid!==me?.uid){ hasNew=true; }
          });
          $msgBang.classList.toggle('show', hasNew);
        }));
      });
    }

    /* ====== ê³µì§€ ì‹œìŠ¤í…œ ====== */
    const noticeModal = document.getElementById('noticeModal');
    const noticeListModal = document.getElementById('noticeListModal');
    const ntListWrap = document.getElementById('ntListWrap');
    const ntNew = document.getElementById('ntNew');
    const btnNoticeList = document.getElementById('btnNoticeList');
    const noticeClose = document.getElementById('noticeClose');
    const ntListClose = document.getElementById('ntListClose');
    const noticeView = document.getElementById('noticeView');
    const noticeEdit = document.getElementById('noticeEdit');
    const noticeTitle = document.getElementById('noticeTitle');
    const noticeBody = document.getElementById('noticeBody');
    const noticeDate = document.getElementById('noticeDate');
    const noticeFiles = document.getElementById('noticeFiles');
    const noticeAdminBtns = document.getElementById('noticeAdminBtns');
    const noticeHide24 = document.getElementById('noticeHide24');
    const noticeDismiss = document.getElementById('noticeDismiss');
    const noticeViewCount = document.getElementById('noticeViewCount');
    const ntTitle = document.getElementById('ntTitle');
    const ntBody = document.getElementById('ntBody');
    const ntFiles = document.getElementById('ntFiles');
    const ntCancel = document.getElementById('ntCancel');
    const ntSave = document.getElementById('ntSave');

    let currentNoticeId = null;

    btnNoticeList.onclick = ()=> openNoticeList();

    function openNoticeList(){
      if (!firebaseOk){ alert('ë„¤íŠ¸ì›Œí¬ í•„ìš”'); return; }
      noticeListModal.style.display='flex';
      renderNoticeList();
      ntNew.style.display = isAdmin ? 'inline-block' : 'none';
      
      // âœ… ì¼ì¼ ë¯¸ì…˜: ê³µì§€ í™•ì¸
      if (me){
        const today = new Date().toISOString().split('T')[0];
        const mRef = doc(db,'profiles', me.uid, 'missions', 'daily');
        setDoc(mRef, {
          noticeCheckedToday: true,
          lastNoticeCheckDate: today
        }, {merge:true});
      }
    }
    
    ntListClose.onclick = ()=> noticeListModal.style.display='none';
    noticeListModal.addEventListener('click', (e)=>{ if(e.target===noticeListModal) noticeListModal.style.display='none'; });

    async function renderNoticeList(){
      const qs = query(collection(db,'notices'), orderBy('createdAt','desc'));
      const snap = await getDocs(qs);
      ntListWrap.innerHTML = [...snap.docs].map(d=>{
        const v = d.data()||{};
        const dt = new Date(toMs(v.createdAt||Date.now())).toLocaleString();
        const viewCount = v.viewCount || 0;
        return `<div class="ritem" data-id="${d.id}">
          <div style="font-weight:600">${esc(v.title||'(ì œëª© ì—†ìŒ)')}</div>
          <div class="meta">${dt} Â· ì¡°íšŒ ${viewCount}</div>
          <div style="margin-top:6px"><button class="rbtn" data-open>ì—´ê¸°</button></div>
        </div>`;
      }).join('') || `<div style="opacity:.7">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      ntListWrap.onclick = (e)=>{
        const card = e.target.closest('.ritem'); if(!card) return;
        if (e.target.matches('[data-open]')) openNotice(card.getAttribute('data-id'));
      };
    }

    async function openNotice(id){
      const s = await getDoc(doc(db,'notices', id));
      if (!s.exists()){ alert('ì‚­ì œëœ ê³µì§€ì…ë‹ˆë‹¤'); return; }
      const v = s.data()||{};
      currentNoticeId = id;
      
      // âœ… ì¡°íšŒìˆ˜ ì¦ê°€
      await safeMergeDoc(['notices', id], { viewCount: increment(1) });
      
      noticeEdit.style.display='none';
      noticeView.style.display='block';
      noticeModal.style.display='flex';
      noticeTitle.textContent = v.title||'(ì œëª© ì—†ìŒ)';
      noticeBody.textContent = v.body||'';
      noticeDate.textContent = new Date(toMs(v.createdAt||Date.now())).toLocaleString();
      noticeViewCount.textContent = `ì¡°íšŒ ${(v.viewCount||0)+1}`;
      
      if (Array.isArray(v.files)&&v.files.length){
        noticeFiles.innerHTML = v.files.map(f=>`<div><a href="${f.url}" target="_blank" rel="noopener noreferrer">${esc(f.name||'íŒŒì¼')}</a></div>`).join('');
      } else noticeFiles.innerHTML='';

      if (isAdmin){
        noticeAdminBtns.innerHTML = `
          <button id="ntEdit" class="tbtn">ìˆ˜ì •</button>
          <button id="ntDel" class="tbtn">ì‚­ì œ</button>
        `;
        document.getElementById('ntEdit').onclick = ()=> editNotice(id, v);
        document.getElementById('ntDel').onclick = async ()=>{
          if (!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
          await deleteDoc(doc(db,'notices', id));
          noticeModal.style.display='none';
          renderNoticeList();
        };
      } else {
        noticeAdminBtns.innerHTML = '';
      }
    }
    
    noticeClose.onclick = ()=> noticeModal.style.display='none';
    noticeModal.addEventListener('click', (e)=>{ if(e.target===noticeModal) noticeModal.style.display='none'; });

    function editNotice(id, v){
      noticeEdit.style.display='block';
      noticeView.style.display='none';
      ntTitle.value = v.title||'';
      ntBody.value  = v.body||'';
      noticeModal.style.display='flex';
      currentNoticeId = id;
    }

    ntNew.onclick = ()=> {
      noticeEdit.style.display='block';
      noticeView.style.display='none';
      noticeModal.style.display='flex';
      ntTitle.value=''; ntBody.value=''; ntFiles.value='';
      currentNoticeId=null;
    };
    ntCancel.onclick = ()=> { noticeModal.style.display='none'; };

    ntSave.onclick = async ()=>{
      if (!firebaseOk || !isAdmin){ alert('ê¶Œí•œ ì—†ìŒ'); return; }
      if (!confirm('ê³µì§€ ì‘ì„±ì‹œ ìœ ì € ëª¨ë‘ì—ê²Œ ë³´ì´ê²Œ ë©ë‹ˆë‹¤. ì´ ë‚´ìš©ì´ ë§ìŠµë‹ˆê¹Œ?')) return;
      const files = Array.from(ntFiles.files||[]);
      const uploaded = [];
      for (let i=0;i<files.length;i++){
        const url = await uploadSmart(files[i], 'noticeFiles', (t)=>{}, `íŒŒì¼ ${i+1}/${files.length}`);
        uploaded.push({ name: files[i].name, url });
      }
      const payload = {
        title: ntTitle.value||'(ì œëª© ì—†ìŒ)',
        body: ntBody.value||'',
        files: uploaded,
        authorUid: me?.uid||null,
        createdAt: serverTimestamp(),
        viewCount: 0
      };
      const docRef = currentNoticeId
        ? (await updateDoc(doc(db,'notices', currentNoticeId), payload), { id: currentNoticeId })
        : await addDoc(collection(db,'notices'), payload);
      noticeModal.style.display='none';
      if (!currentNoticeId){
        await addDoc(collection(db,'adminChat'), {
          type:'notice',
          noticeId: docRef.id,
          title: payload.title,
          body: payload.body,
          createdAt: serverTimestamp(),
          uid: me?.uid||null
        });
      }
      openNoticeList();
      renderNoticeList();
    };

    noticeHide24.onclick = async ()=>{
      if (!firebaseOk){ alert('ë¡œê·¸ì¸ ì‹œì—ë§Œ ìœ ì§€ë©ë‹ˆë‹¤. ë¹„ë¡œê·¸ì¸ ìœ ì €ëŠ” ë§¤ ë°©ë¬¸ë§ˆë‹¤ ê³µì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.'); return; }
      if (!me){ alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      const until = new Date(Date.now()+24*3600*1000);
      await setDoc(doc(db,'noticeSuppress', me.uid), { until }, { merge:true });
      alert('24ì‹œê°„ ë™ì•ˆ ìë™ íŒì—…ì„ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      noticeModal.style.display='none';
    };
    noticeDismiss.onclick = ()=> noticeModal.style.display='none';

    async function autoPopupLatestNotice(){
      if (!firebaseOk) return;
      const qs = query(collection(db,'notices'), orderBy('createdAt','desc'), limit(1));
      const s = await getDocs(qs);
      if (s.empty) return;
      const d = s.docs[0]; const v = d.data()||{};
      if (!me){
        openNotice(d.id);
        return;
      }
      try{
        const sup = await getDoc(doc(db,'noticeSuppress', me.uid));
        const until = toMs(sup?.data()?.until);
        if (until && until > Date.now()) return;
      }catch{}
      openNotice(d.id);
    }

    setTimeout(autoPopupLatestNotice, 1200);

    /* ====== ê±´ì˜ ë° ë¬¸ì˜ ì‹œìŠ¤í…œ ====== */
    const btnSuggestList = document.getElementById('btnSuggestList');
    const suggestListModal = document.getElementById('suggestListModal');
    const sgListWrap = document.getElementById('sgListWrap');
    const sgNew = document.getElementById('sgNew');
    const sgListClose = document.getElementById('sgListClose');
    
    const suggestModal = document.getElementById('suggestModal');
    const sgView = document.getElementById('sgView');
    const sgEdit = document.getElementById('sgEdit');
    const sgClose = document.getElementById('sgClose');
    const sgTitle = document.getElementById('sgTitle');
    const sgBody = document.getElementById('sgBody');
    const sgDate = document.getElementById('sgDate');
    const sgReplies = document.getElementById('sgReplies');
    const sgReplyForm = document.getElementById('sgReplyForm');
    const sgReplyBody = document.getElementById('sgReplyBody');
    const sgReplySubmit = document.getElementById('sgReplySubmit');
    const sgEditTitle = document.getElementById('sgEditTitle');
    const sgEditBody = document.getElementById('sgEditBody');
    const sgEditCancel = document.getElementById('sgEditCancel');
    const sgEditSave = document.getElementById('sgEditSave');
    
    let currentSuggestId = null;
    
    btnSuggestList.onclick = ()=> openSuggestList();
    
    function openSuggestList(){
      if (!firebaseOk){ alert('ë„¤íŠ¸ì›Œí¬ í•„ìš”'); return; }
      suggestListModal.style.display='flex';
      renderSuggestList();
    }
    
    sgListClose.onclick = ()=> suggestListModal.style.display='none';
    suggestListModal.addEventListener('click', (e)=>{ if(e.target===suggestListModal) suggestListModal.style.display='none'; });
    
    async function renderSuggestList(){
      const qs = query(collection(db,'suggestions'), orderBy('createdAt','desc'));
      const snap = await getDocs(qs);
      sgListWrap.innerHTML = [...snap.docs].map(d=>{
        const v = d.data()||{};
        const dt = new Date(toMs(v.createdAt||Date.now())).toLocaleString();
        const replyCount = v.replyCount || 0;
        return `<div class="ritem" data-id="${d.id}">
          <div style="font-weight:600">${esc(v.title||'(ì œëª© ì—†ìŒ)')}</div>
          <div class="meta">${dt} Â· ë‹µë³€ ${replyCount}ê°œ</div>
          <div style="margin-top:6px"><button class="rbtn" data-open>ì—´ê¸°</button></div>
        </div>`;
      }).join('') || `<div style="opacity:.7">ë“±ë¡ëœ ê±´ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      sgListWrap.onclick = (e)=>{
        const card = e.target.closest('.ritem'); if(!card) return;
        if (e.target.matches('[data-open]')) openSuggestDetail(card.getAttribute('data-id'));
      };
    }
    
    sgNew.onclick = ()=>{
      if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      sgEdit.style.display='block';
      sgView.style.display='none';
      suggestModal.style.display='flex';
      sgEditTitle.value=''; sgEditBody.value='';
      currentSuggestId=null;
    };
    
    async function openSuggestDetail(id){
      const s = await getDoc(doc(db,'suggestions', id));
      if (!s.exists()){ alert('ì‚­ì œëœ ê±´ì˜ì…ë‹ˆë‹¤'); return; }
      const v = s.data()||{};
      currentSuggestId = id;
      
      sgEdit.style.display='none';
      sgView.style.display='block';
      suggestModal.style.display='flex';
      sgTitle.textContent = v.title||'(ì œëª© ì—†ìŒ)';
      sgBody.textContent = v.body||'';
      sgDate.textContent = new Date(toMs(v.createdAt||Date.now())).toLocaleString();
      
      // ë‹µë³€ í‘œì‹œ
      const repliesSnap = await getDocs(query(collection(db,'suggestions', id, 'replies'), orderBy('createdAt','asc')));
      if (repliesSnap.empty){
        sgReplies.innerHTML = '<div style="opacity:.7">ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        const isMine = me && me.uid === v.authorUid;
        sgReplies.innerHTML = (await Promise.all(repliesSnap.docs.map(async d=>{
          const r = d.data();
          if (r.isAdminReply && !isAdmin && !isMine) {
            return '<div class="citem"><div style="opacity:.7">ê´€ë¦¬ì ì „ìš© ë‹µë³€ì…ë‹ˆë‹¤</div></div>';
          }

          // âœ… ê´€ë¦¬ì ë‹µë³€ì€ ì‘ì„±ìì™€ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆìŒ
          if (!isAdmin && !isMine){
            return '<div class="citem"><div style="opacity:.7">ìˆ¨ê²¨ì§„ ëŒ“ê¸€ì…ë‹ˆë‹¤</div></div>';
          }
          const disp = await getDisplayForUid(r.uid);
          return `<div class="citem">
            <div class="meta">${esc(fmtDisplay(disp.nick, disp.rankCode, disp.trust, disp.isAdmin))} Â· ${new Date(toMs(r.createdAt||Date.now())).toLocaleString()}</div>
            <div style="white-space:pre-wrap; margin-top:6px">${esc(r.body||'')}</div>
          </div>`;
        }))).join('');
      }
      
      sgReplyForm.style.display = isAdmin ? 'block' : 'none';
    }
    
    sgClose.onclick = ()=> suggestModal.style.display='none';
    suggestModal.addEventListener('click', (e)=>{ if(e.target===suggestModal) suggestModal.style.display='none'; });
    
    sgEditCancel.onclick = ()=> suggestModal.style.display='none';
    
    sgEditSave.onclick = async ()=>{
      if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      const title = sgEditTitle.value.trim() || '(ì œëª© ì—†ìŒ)';
      const body = sgEditBody.value.trim();
      if (!body){ alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      
      const docRef = await addDoc(collection(db,'suggestions'), {
        title, body,
        authorUid: me.uid,
        createdAt: serverTimestamp(),
        replyCount: 0
      });
      
      // âœ… ê´€ë¦¬ì ë©”ì‹ ì €ì— ì¹´ë“œ ì¶”ê°€
      await addDoc(collection(db,'adminChat'), {
        type:'suggestion',
        suggestionId: docRef.id,
        title, body,
        createdAt: serverTimestamp(),
        uid: me.uid
      });
      
      // âœ… í†µê³„ ì—…ë°ì´íŠ¸
      await updateDoc(doc(db,'profiles', me.uid), {
        suggestionsMade: increment(1)
      });
      
      // âœ… ì£¼ê°„ ë¯¸ì…˜ ì²´í¬
      const weekNum = getWeekNumber(new Date());
      const wRef = doc(db,'profiles', me.uid, 'missions', 'weekly');
      await setDoc(wRef, {
        currentWeek: weekNum,
        suggestionsThisWeek: increment(1)
      }, {merge:true});
      
      await checkAchievements(me.uid);
      
      suggestModal.style.display='none';
      alert('ê±´ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
      renderSuggestList();
    };
    
    sgReplySubmit.onclick = async ()=>{
      if (!isAdmin){ alert('ê´€ë¦¬ì ì „ìš©'); return; }
      const body = sgReplyBody.value.trim();
      if (!body) return;
      
      await addDoc(collection(db,'suggestions', currentSuggestId, 'replies'), {
        body,
        uid: me.uid,
        createdAt: serverTimestamp(),
        isAdminReply: true
      });
      
      await updateDoc(doc(db,'suggestions', currentSuggestId), {
        replyCount: increment(1)
      });
      
      sgReplyBody.value='';
      openSuggestDetail(currentSuggestId);
    };

    /* ====== ë¯¸ì…˜ ì‹œìŠ¤í…œ ====== */
    const missionsModal = document.getElementById('missionsModal');
    const missionsClose = document.getElementById('missionsClose');
    const dailyMissions = document.getElementById('dailyMissions');
    const weeklyMissions = document.getElementById('weeklyMissions');
    
    // âœ… í”„ë¡œí•„ ë²„íŠ¼ì—ì„œ ë¯¸ì…˜ ì—´ê¸°
    document.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase() === 'q' && !['INPUT','TEXTAREA'].includes((e.target||{}).tagName)){
        e.preventDefault();
        openMissions();
      }
    });
    
    async function openMissions(){
      if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      missionsModal.style.display='flex';
      await renderMissions();
    }
    
    missionsClose.onclick = ()=> missionsModal.style.display='none';
    missionsModal.addEventListener('click', (e)=>{ if(e.target===missionsModal) missionsModal.style.display='none'; });
    
    async function renderMissions(){
      if (!firebaseOk || !me) return;
      
      const today = new Date().toISOString().split('T')[0];
      const weekNum = getWeekNumber(new Date());
      
      const dRef = doc(db,'profiles', me.uid, 'missions', 'daily');
      const wRef = doc(db,'profiles', me.uid, 'missions', 'weekly');
      
      const [dSnap, wSnap] = await Promise.all([getDoc(dRef), getDoc(wRef)]);
      const dData = dSnap.exists() ? dSnap.data() : {};
      const wData = wSnap.exists() ? wSnap.data() : {};
      
      // ë‚ ì§œê°€ ë°”ë€Œë©´ ì´ˆê¸°í™”
      if (dData.lastLoginDate !== today){
        await setDoc(dRef, {
          loginToday: false,
          commentsToday: 0,
          noticeCheckedToday: false,
          lastLoginDate: today
        });
      }
      
      // ì£¼ê°€ ë°”ë€Œë©´ ì´ˆê¸°í™”
      if (wData.currentWeek !== weekNum){
        await setDoc(wRef, {
          currentWeek: weekNum,
          loginDaysThisWeek: 0,
          pinsThisWeek: 0,
          suggestionsThisWeek: 0,
          reactionsThisWeek: 0,
          loginDates: []
        });
      }
      
      const pfRef = doc(db,'profiles', me.uid);
      const pfSnap = await getDoc(pfRef);
      const completedDaily = pfSnap.data()?.dailyMissionsCompleted || [];
      const completedWeekly = pfSnap.data()?.weeklyMissionsCompleted || [];
      
      // ì¼ì¼ ë¯¸ì…˜ ë Œë”ë§
      dailyMissions.innerHTML = DAILY_MISSIONS.map(m=>{
        const completed = m.check(dData) || completedDaily.includes(m.id);
        return `
          <div class="mission-item ${completed?'completed':''}">
            <div>
              <strong>${m.name}</strong>
              <div class="mission-reward">+${m.xp} XP</div>
            </div>
            ${completed ? '<span style="color:#4caf50">âœ“</span>' : ''}
          </div>
        `;
      }).join('');
      
      // ì£¼ê°„ ë¯¸ì…˜ ë Œë”ë§
      weeklyMissions.innerHTML = WEEKLY_MISSIONS.map(m=>{
        const completed = m.check(wData) || completedWeekly.includes(m.id);
        return `
          <div class="mission-item ${completed?'completed':''}">
            <div>
              <strong>${m.name}</strong>
              <div class="mission-reward">+${m.xp} XP</div>
            </div>
            ${completed ? '<span style="color:#4caf50">âœ“</span>' : ''}
          </div>
        `;
      }).join('');
      
      // ì™„ë£Œëœ ë¯¸ì…˜ ë³´ìƒ ì§€ê¸‰
      for (const m of DAILY_MISSIONS){
        if (m.check(dData) && !completedDaily.includes(m.id)){
          await updateDoc(pfRef, {
            xp: increment(m.xp),
            dailyMissionsCompleted: arrayUnion(m.id)
          });
        }
      }
      
      for (const m of WEEKLY_MISSIONS){
        if (m.check(wData) && !completedWeekly.includes(m.id)){
          await updateDoc(pfRef, {
            xp: increment(m.xp),
            weeklyMissionsCompleted: arrayUnion(m.id)
          });
        }
      }
    }

    /* ====== ì—…ì  ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ì) ====== */
    const achievementListModal = document.getElementById('achievementListModal');
    const achListContent = document.getElementById('achListContent');
    const achListClose = document.getElementById('achListClose');
    
    // âœ… ê´€ë¦¬ì ë©”ì‹ ì €ì™€ ê³µì§€ ì‚¬ì´ì— ë²„íŠ¼ ì¶”ê°€ (HTMLì—ì„œ ìˆ˜ë™ ì¶”ê°€ í•„ìš”)
    if (isAdmin){
      const achievementListBtn = document.createElement('button');
      achievementListBtn.id = 'btnAchievementList';
      achievementListBtn.className = 'pill-btn';
      achievementListBtn.textContent = 'ì—…ì  ë¦¬ìŠ¤íŠ¸';
      achievementListBtn.style.display = 'inline-block';
      achievementListBtn.onclick = ()=> openAchievementList();
      
      const topRight = document.querySelector('.top-right');
      const msgBtn = document.getElementById('btnMsg');
      topRight.insertBefore(achievementListBtn, msgBtn);
    }
    
    function openAchievementList(){
      if (!isAdmin){ alert('ê´€ë¦¬ì ì „ìš©'); return; }
      achievementListModal.style.display='flex';
      
      const tierLabels = {normal:'ë…¸ë§', rare:'ë ˆì–´', epic:'ì—í”½', legend:'ë ˆì „ë“œ'};
      achListContent.innerHTML = ACHIEVEMENTS.map(ach=>`
        <div class="achievement-badge ${ach.tier}" style="margin:8px 0; padding:12px">
          <strong>${ach.name}</strong> (${tierLabels[ach.tier]} Â· +${ach.xp} XP)<br>
          <span style="font-size:12px; opacity:.8">${ach.desc}</span>
        </div>
      `).join('');
    }
    
    achListClose.onclick = ()=> achievementListModal.style.display='none';
    achievementListModal.addEventListener('click', (e)=>{ if(e.target===achievementListModal) achievementListModal.style.display='none'; });

    /* ===== í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ===== */
    document.addEventListener('keydown', (e)=>{
      function closeIfOpen(id, openDisplay='flex') {
        const el = document.getElementById(id);
        if (el && el.style.display === openDisplay) {
          el.style.display = 'none';
          return true;
        }
        return false;
      }

      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;

        const modals = [
          'messengerModal','noticeModal','noticeListModal',
          'suggestModal','suggestListModal','missionsModal','achievementListModal'
        ];

        for (const id of modals) {
          if (closeIfOpen(id)) return;
        }

        if (info?.style.display === 'block') { infoClose?.click(); }
      });

      if (['INPUT','TEXTAREA'].includes((e.target||{}).tagName)) return;
      if (e.key === '/') { e.preventDefault(); qInput.focus(); }
      if (e.key.toLowerCase() === 's') { e.preventDefault(); side.style.display = (side.style.display==='block'?'none':'block'); }
      if (e.key.toLowerCase() === 'm') { e.preventDefault(); setMode(mode==='search'?'place':'search'); }
      if (e.key === 'Escape'){
        if (document.getElementById('modal').style.display==='flex') { document.getElementById('modal').style.display='none'; pending=null; return; }
        if (document.getElementById('profileModal').style.display==='flex') { document.getElementById('profileModal').style.display='none'; return; }
        if (document.getElementById('otherProfileModal').style.display==='flex') { document.getElementById('otherProfileModal').style.display='none'; return; }
        if (document.getElementById('trustHistoryModal').style.display==='flex') { document.getElementById('trustHistoryModal').style.display='none'; return; }
        if (document.getElementById('achievementModal').style.display==='flex') { document.getElementById('achievementModal').style.display='none'; return; }
        if (document.getElementById('messengerModal').style.display==='flex') { document.getElementById('messengerModal').style.display='none'; return; }
        if (document.getElementById('noticeModal').style.display==='flex') { document.getElementById('noticeModal').style.display='none'; return; }
        if (document.getElementById('noticeListModal').style.display==='flex') { document.getElementById('noticeListModal').style.display='none'; return; }
        if (document.getElementById('suggestModal').style.display==='flex') { document.getElementById('suggestModal').style.display='none'; return; }
        if (document.getElementById('suggestListModal').style.display==='flex') { document.getElementById('suggestListModal').style.display='none'; return; }
        if (document.getElementById('missionsModal').style.display==='flex') { document.getElementById('missionsModal').style.display='none'; return; }
        if (document.getElementById('achievementListModal').style.display==='flex') { document.getElementById('achievementListModal').style.display='none'; return; }
        if ($info.style.display==='block'){ $infoClose.click(); return; }
      }
    });

    /* ===== showReactionMenu ê¸€ë¡œë²Œ í•¨ìˆ˜ ===== */
    window.showReactionMenu = showReactionMenu;

    /* ===== ì¹´í…Œê³ ë¦¬ë³„ í™•ì¸ëœ í•€ ë¡œë“œ ===== */
    function loadConfirmedPins(){
      const confirmed = {};
      markerMap.forEach((rec, id)=>{
        if (rec.confirmed){
          const cat = rec.data.category;
          confirmed[cat] = (confirmed[cat] || 0) + 1;
        }
      });
      for (const [cat, count] of Object.entries(confirmed)){
        catConfirmed.set(cat, count);
      }
      updateAllCategoryProgress();
    }
    
    // ë§ˆì»¤ ë¡œë“œ í›„ í™•ì¸ëœ í•€ ì§‘ê³„
    setTimeout(loadConfirmedPins, 2000);

    // í˜ì´ì§€ ë¡œë“œ ì§í›„ í•œ í‹± ë’¤ì— ê°•ì œ ë‹«ê¸° (ì‹¤ìˆ˜ë¡œ ì—´ë ¸ìœ¼ë©´ ì¡ì•„ì¤Œ)
      setTimeout(()=>{
        if (mode !== 'place' && modal.style.display !== 'none'){
         modal.style.display = 'none';
          pending = null;
        }
      }, 0);


    console.log('âœ… ZA í•œê¸€ ê³µëµ ë§µ ì´ˆê¸°í™” ì™„ë£Œ');

    /* === ZA MAPS PATCH BUNDLE (drop-in) =========================================
    * ëª©ì : ê¸°ì¡´ HTML(ë™ì¼ ë¬¸ì„œì˜ <script type="module">)ì— ì´ ë¸”ë¡ë§Œ ë¶™ì—¬ë„£ìœ¼ë©´
    * - ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼(ê³µì§€/ê±´ì˜/ë©”ì‹ ì €) ì—´ê¸°/ë‹«ê¸°
    * - í”„ë¡œí•„/ì‹ ë¢°ë„ë‚´ì—­/ì—…ì ê´€ë¦¬/íƒ€ìœ ì €í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    * - ìƒì„¸íŒ¨ë„ ë§í¬ë³µì‚¬, í•€ ì˜¤ë¥¸ìª½-í´ë¦­ ë°˜ì‘ ë©”ë‰´
    * - ê²€ìƒ‰/í•€ë°°ì¹˜ ëª¨ë“œ í† ê¸€, ë‹¨ì¶•í‚¤, ì‚¬ì´ë“œë°” í† ê¸€
    * ë“±ì´ ë°”ë¡œ ì‘ë™.
    * ê¸°ì¡´ ì½”ë“œ(Leaflet/Firebase/ê°ì¢… ìœ í‹¸)ì™€ ì¶©ëŒ ì—†ì´ â€œí›„í‚¹â€ë§Œ í•œë‹¤.
    * ì´ ì½”ë“œëŠ” ë°˜ë“œì‹œ ê°™ì€ <script type="module"> ë‚´ë¶€ ê°€ì¥ ë§ˆì§€ë§‰ì— ì‚½ì….
    * ========================================================================== */

    (function(){
      // ----- ì•ˆì „ í—¬í¼ -----
      const $ = (id)=> document.getElementById(id);
      const qs = (sel, root=document)=> root.querySelector(sel);
      const qsa = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
      const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);

      // ê¸°ì¡´ ìŠ¤ì½”í”„ ê°’ë“¤ ì ‘ê·¼ (ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì•ˆì „í•œ ê¸°ë³¸ê°’)
      const LS = globalThis.LS || { save:()=>{}, load:()=>null };
      const map = globalThis.map || null;

      // ----- ëª¨ë‹¬ ê³µí†µ -----
      function showModal(id){ const el=$(id); if(el){ el.style.display='flex'; trapFocus(el); } }
      function hideModal(id){ const el=$(id); if(el){ el.style.display='none'; releaseFocus(); } }
      function toggleModal(id){ const el=$(id); if(!el) return; (el.style.display==='flex')?hideModal(id):showModal(id); }

      // í¬ì»¤ìŠ¤ íŠ¸ë©(ì ‘ê·¼ì„±)
      let lastFocus=null;
      function trapFocus(container){
      lastFocus = document.activeElement;
        const focusables = qsa('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])', container)
         .filter(el=>!el.hasAttribute('disabled'));
        if (focusables[0]) focusables[0].focus();
        function loop(e){
          if(e.key!=='Tab') return;
          const first = focusables[0], last = focusables[focusables.length-1];
          if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
          else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
      }
        container.__trapHandler = loop;
        container.addEventListener('keydown', loop);
    }
      function releaseFocus(){
        if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus();
        qsa('#modal,#profileModal,#messengerModal,#noticeModal,#noticeListModal,#suggestModal,#suggestListModal,#achievementModal,#missionsModal,#trustHistoryModal,#otherProfileModal,#achievementListModal')
          .forEach(m=>{
            if (m.__trapHandler) { m.removeEventListener('keydown', m.__trapHandler); m.__trapHandler=null; }
          });
      lastFocus=null;
      }

      // ----- ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼: ê³µì§€/ê±´ì˜/ë©”ì‹ ì € -----
      on($('btnNoticeList'), 'click', ()=> showModal('noticeListModal'));
      on($('btnSuggestList'), 'click', ()=> showModal('suggestListModal'));
      on($('btnMsg'),        'click', ()=> showModal('messengerModal'));

      // ê³µì§€ ëª©ë¡ ë‹«ê¸°/ìƒˆ ê³µì§€
      on($('ntListClose'), 'click', ()=> hideModal('noticeListModal'));
      on($('ntNew'), 'click', ()=> { hideModal('noticeListModal'); showModal('noticeModal'); });

      // ê³µì§€ ë³¸ë¬¸ ë·°/ë‹«ê¸°
      on($('noticeClose'), 'click', ()=> hideModal('noticeModal'));
      on($('noticeDismiss'), 'click', ()=> hideModal('noticeModal'));
      on($('noticeHide24'), 'click', ()=>{
        try { LS.save('notice_hide_until', Date.now()+24*3600*1000); }catch{}
        hideModal('noticeModal');
      });

      // ê±´ì˜/ë¬¸ì˜ ëª©ë¡ ë‹«ê¸° & ì‘ì„±í•˜ê¸°
      on($('sgListClose'), 'click', ()=> hideModal('suggestListModal'));
      on($('sgNew'), 'click', ()=> { hideModal('suggestListModal'); showModal('suggestModal'); });

      // ê±´ì˜/ë¬¸ì˜ ìƒì„¸ ë‹«ê¸°
      on($('sgClose'), 'click', ()=> hideModal('suggestModal'));

      // ê´€ë¦¬ì ë©”ì‹ ì € ë‹«ê¸°
      on($('msgClose'), 'click', ()=> hideModal('messengerModal'));

      // ----- í”„ë¡œí•„/ì‹ ë¢°ë„/ì—…ì /íƒ€ ìœ ì € í”„ë¡œí•„ -----
      on($('btnProfile'), 'click', ()=> showModal('profileModal'));
      on($('pfClose'), 'click', ()=> hideModal('profileModal'));
      on($('thClose'), 'click', ()=> hideModal('trustHistoryModal'));
      on($('pfTrustHistory'), 'click', ()=> showModal('trustHistoryModal'));

      //ì—…ì  ê´€ë¦¬(ë‚´)
      on($('pfManageAchievements'), 'click', ()=> showModal('achievementModal'));
      on($('achClose'), 'click', ()=> hideModal('achievementModal'));

      // ì „ì²´ ì—…ì (ê´€ë¦¬ììš© ë¦¬ìŠ¤íŠ¸) ëª¨ë‹¬(ìˆì„ ë•Œ)
      on($('achListClose'), 'click', ()=> hideModal('achievementListModal'));

      // íƒ€ ìœ ì € í”„ë¡œí•„
      on($('opClose'), 'click', ()=> hideModal('otherProfileModal'));

      // ë¯¸ì…˜ ëª¨ë‹¬ (ë²„íŠ¼ì´ ë³„ë„ë¡œ ìˆë‹¤ë©´ ì—°ê²°)
      const btnMissions = $('btnMissions'); // ì„ íƒ ìš”ì†Œ(ì—†ìœ¼ë©´ ë¬´ì‹œ)
      if (btnMissions) on(btnMissions, 'click', ()=> showModal('missionsModal'));
      on($('missionsClose'), 'click', ()=> hideModal('missionsModal'));

      // ----- ì‚¬ì´ë“œë°” & ëª¨ë“œ í† ê¸€ -----
      const side = $('side');
      const btnSearch = $('btnSearch');
      const btnPlace = $('btnPlace');

      function setMode(mode){ // 'search' | 'place'
        if (!btnSearch || !btnPlace) return;
        if (mode==='search'){
          btnSearch.classList.add('on'); btnPlace.classList.remove('on');
          if (side) side.style.display = 'block';
        }else{
          btnPlace.classList.add('on'); btnSearch.classList.remove('on');
          if (side) side.style.display = 'none';
        }
        try { LS.save('ui_mode', mode); }catch{}
    }
      // ì´ˆê¸° ëª¨ë“œ ë³µì›
      const savedMode = (LS.load('ui_mode','search')||'search');
      setMode(savedMode);

      on(btnSearch, 'click', ()=> setMode('search'));
      on(btnPlace,  'click', ()=> setMode('place'));

      // ë‹¨ì¶•í‚¤: S=ê²€ìƒ‰ëª¨ë“œ, M=í•€ëª¨ë“œ, /=ê²€ìƒ‰ í¬ì»¤ìŠ¤, ESC=ëª¨ë‹¬/ìƒì„¸ ë‹«ê¸°
      on(document, 'keydown', (e)=>{
        const tag = (e.target && e.target.tagName)||'';
        const inInput = /INPUT|TEXTAREA|SELECT/.test(tag);
        if (e.key==='s' || e.key==='S'){ if(!inInput){ e.preventDefault(); setMode('search'); } }
        if (e.key==='m' || e.key==='M'){ if(!inInput){ e.preventDefault(); setMode('place'); } }
        if (e.key==='/'){ if(!inInput){ e.preventDefault(); $('qInput')?.focus(); } }
        if (e.key==='Escape'){
          // ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/ìƒì„¸ ë‹«ê¸°
          const openMod = qsa('#modal,#profileModal,#messengerModal,#noticeModal,#noticeListModal,#suggestModal,#suggestListModal,#achievementModal,#missionsModal,#trustHistoryModal,#otherProfileModal,#achievementListModal')
            .find(el=> el.style.display==='flex');
          if (openMod) { hideModal(openMod.id); return; }
          const info = $('info');
          if (info && info.style.display!=='none'){ qs('#infoClose', info)?.click(); }
        }
      });

      // ----- ìƒì„¸íŒ¨ë„: ë§í¬ë³µì‚¬ & í•€ ë°˜ì‘(right-click) -----
      const copyBtn = $('copyLinkBtn');
      if (copyBtn){
        on(copyBtn, 'click', ()=>{
          try{
            const idTag = $('infoId')?.textContent?.trim() || '#-';
            // currentOpenIdëŠ” ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìœ ì§€
            const mid = (globalThis.currentOpenId || '').trim();
            const url = new URL(location.href);
            if (mid) url.searchParams.set('pin', mid);
            // ë³´ì´ëŠ” ë²ˆí˜¸ë§Œ ìˆëŠ” ê²½ìš°ì—ë„ ì¼ë‹¨ ë³µì‚¬
            navigator.clipboard.writeText(url.toString())
              .then(()=> alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'))
              .catch(()=> alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'));
          }catch{
            alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆì–´ìš”');
          }
        });
      }

      // í•€ ì „ì²´ì— ëŒ€í•œ ë°˜ì‘ ë©”ë‰´: ìƒì„¸ ìƒë‹¨ ì˜ì—­ ìš°í´ë¦­ ì‹œ
      const infoPane = $('info');
      if (infoPane){
        on(infoPane, 'contextmenu', (e)=>{
          // ëŒ“ê¸€ ê°œë³„ ìš°í´ë¦­ì€ ë³¸ë¬¸ ë Œë” ìª½ì—ì„œ ì´ë¯¸ ì²˜ë¦¬.
          // ìƒì„¸ íŒ¨ë„ ë¹ˆ ê³³ ìš°í´ë¦­ ì‹œ, í˜„ì¬ ì—´ë¦° í•€ì— ë°˜ì‘ ë‹¬ê¸°
          const menu = $('reactionMenu');
          if (!menu) return;
          const pinId = globalThis.currentOpenId;
          if (!pinId) return;
          e.preventDefault();
          if (typeof globalThis.showReactionMenu === 'function'){
            globalThis.showReactionMenu(e.pageX, e.pageY, 'pin', pinId, null);
          }
        });
      }

      // ë°˜ì‘ ë©”ë‰´ ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°(ë³´í˜¸)
      const reactionMenu = $('reactionMenu');
      if (reactionMenu){
        on(document, 'click', (e)=>{
          if (reactionMenu.style.display==='block' && !reactionMenu.contains(e.target)){
            reactionMenu.style.display='none';
          }
        });
      }

      // ----- â€œê³µì§€ 24ì‹œê°„ ìˆ¨ê¹€â€ ì ìš©(ìˆë‹¤ë©´) -----
      try{
        const until = LS.load('notice_hide_until', 0) || 0;
        if (Date.now() < until){
          // ê³µì§€ ì—´ë¦¼ì„ ì‹œë„í•  ë•Œë§ˆë‹¤ ë§‰ì„ ìˆ˜ ìˆì§€ë§Œ,
          // ì—¬ê¸°ì„  ì‹œì‘ ì‹œ ëª©ë¡ ëª¨ë‹¬ì„ ê°•ì œë¡œ ë‹«ëŠ” ì •ë„ë¡œ ì²˜ë¦¬
          const nl = $('noticeListModal'); if (nl) nl.style.display='none';
          const nv = $('noticeModal'); if (nv) nv.style.display='none';
        }
      }catch{}

      // ----- ì ‘ê·¼ì„±: ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸° -----
      qsa('#modal,#profileModal,#messengerModal,#noticeModal,#noticeListModal,#suggestModal,#suggestListModal,#achievementModal,#missionsModal,#trustHistoryModal,#otherProfileModal,#achievementListModal')
        .forEach(m=>{
          on(m, 'click', (e)=>{ if (e.target===m) hideModal(m.id); });
        });

      // ----- ì‚¬ì´ë“œ: ì¸ê¸°ê²€ìƒ‰ì–´ ë²„íŠ¼ í‚¤ë³´ë“œ ì ‘ê·¼ì„± ê°•í™” -----
      const qTrend = $('qTrending');
      if (qTrend){
        qTrend.addEventListener('keydown', (e)=>{
          const b = e.target.closest('[data-sug]');
          if (!b) return;
          if (e.key==='Enter' || e.key===' '){ b.click(); e.preventDefault(); }
        });
      }

      // ----- ì¤Œ ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ì„ ë³´ì™„í•˜ëŠ” ì¶•ì†Œ/í™•ëŒ€ ë‹¨ì¶•í‚¤(+/-) -----
      on(document, 'keydown', (e)=>{
        if (!map) return;
        if (e.target && /INPUT|TEXTAREA|SELECT/.test(e.target.tagName)) return;
        if (e.key==='+'){ map.zoomIn(); }
        else if (e.key==='-'){ map.zoomOut(); }
      });

      // ----- ì‘ì€ í† ìŠ¤íŠ¸ ìœ í‹¸(í•„ìš”ì‹œ) -----
      if (typeof globalThis.toast !== 'function'){
        globalThis.toast = (msg)=>{
          const t = document.createElement('div');
          t.textContent = msg;
          Object.assign(t.style, {
            position:'fixed', left:'50%', bottom:'24px', transform:'translateX(-50%)',
            background:'#111c', color:'#fff', padding:'8px 12px', borderRadius:'8px',
            zIndex: 4000, backdropFilter:'blur(4px)'
          });
          document.body.appendChild(t);
          setTimeout(()=> t.remove(), 1800);
        };
      }

      // ----- ì•ˆì „: showReactionMenuê°€ ì—†ìœ¼ë©´ ìµœì†Œ êµ¬í˜„ -----
      if (typeof globalThis.showReactionMenu !== 'function'){
        globalThis.showReactionMenu = (x,y,type,targetId,parentId)=>{
          const menu = $('reactionMenu'); if(!menu) return;
          menu.style.left = x+'px'; menu.style.top = y+'px'; menu.style.display='block';
          // ì„ íƒ ì²˜ë¦¬ ìì²´ëŠ” ë©”ì¸ êµ¬í˜„(ì´ë¯¸ HTMLì— ì¡´ì¬)ì—ê²Œ ë§¡ê¹€
        };
      }

      // ë
    })();
    
  </script>
</body>
</html>
